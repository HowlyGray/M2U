<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PeerText - Messagerie P2P Chiffr√©e</title>
    <!-- PeerJS via jsDelivr (meilleur support des source maps) -->
    <script src="https://cdn.jsdelivr.net/npm/peerjs@1.5.4/dist/peerjs.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background: linear-gradient(135deg, #1a1a2e, #16213e, #0f3460);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            padding: 20px;
            color: #fff;
        }

        .container {
            width: 100%;
            max-width: 1100px;
            background: rgba(15, 23, 42, 0.9);
            backdrop-filter: blur(12px);
            border-radius: 24px;
            overflow: hidden;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.75);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        header {
            background: rgba(11, 18, 39, 0.95);
            padding: 20px 25px;
            text-align: center;
            border-bottom: 1px solid rgba(99, 179, 237, 0.3);
            position: relative;
        }

        h1 {
            font-size: 2.2rem;
            background: linear-gradient(to right, #63b3ed, #81e6d9, #f093fb);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            display: inline-flex;
            align-items: center;
            gap: 12px;
        }

        .subtitle {
            color: #94a3b8;
            font-size: 1rem;
            margin-top: 8px;
        }

        .badges {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 12px;
            flex-wrap: wrap;
        }

        .badge {
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .badge.e2e {
            background: rgba(52, 211, 153, 0.2);
            color: #34d399;
            border: 1px solid rgba(52, 211, 153, 0.3);
        }

        .badge.p2p {
            background: rgba(99, 179, 237, 0.2);
            color: #63b3ed;
            border: 1px solid rgba(99, 179, 237, 0.3);
        }

        .badge.files {
            background: rgba(251, 191, 36, 0.2);
            color: #fbbf24;
            border: 1px solid rgba(251, 191, 36, 0.3);
        }

        .badge.rooms {
            background: rgba(167, 139, 250, 0.2);
            color: #a78bfa;
            border: 1px solid rgba(167, 139, 250, 0.3);
        }

        /* Mobile menu button */
        .mobile-menu-btn {
            position: absolute;
            top: 20px;
            left: 25px;
            width: 40px;
            height: 40px;
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            background: rgba(30, 41, 59, 0.8);
            color: #94a3b8;
            cursor: pointer;
            display: none;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .mobile-menu-btn:hover {
            background: rgba(51, 65, 85, 0.8);
            color: #e2e8f0;
        }

        .mobile-menu-btn:active {
            transform: scale(0.95);
        }

        /* Close button for mobile sidebar */
        .mobile-close-btn {
            position: absolute;
            top: 20px;
            right: 25px;
            width: 40px;
            height: 40px;
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            background: rgba(30, 41, 59, 0.8);
            color: #94a3b8;
            cursor: pointer;
            display: none;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            z-index: 101;
        }

        .mobile-close-btn:hover {
            background: rgba(51, 65, 85, 0.8);
            color: #e2e8f0;
        }

        /* Street back button */
        .street-back-btn {
            position: absolute;
            top: 20px;
            left: 25px;
            width: 40px;
            height: 40px;
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            background: rgba(30, 41, 59, 0.8);
            color: #94a3b8;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            z-index: 5;
        }

        .street-back-btn:hover {
            background: rgba(51, 65, 85, 0.8);
            color: #e2e8f0;
        }

        /* Overlay for mobile sidebar */
        .sidebar-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 99;
            display: none;
        }

        .sidebar-overlay.show {
            display: block;
        }

        .main-layout {
            display: grid;
            grid-template-columns: 280px 1fr;
            min-height: 600px;
        }

        /* Sidebar */
        .sidebar {
            background: rgba(11, 18, 39, 0.8);
            border-right: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            flex-direction: column;
        }

        .sidebar-section {
            padding: 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .sidebar-section h3 {
            color: #94a3b8;
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .my-info {
            background: rgba(99, 179, 237, 0.1);
            border-radius: 12px;
            padding: 12px;
            border: 1px solid rgba(99, 179, 237, 0.2);
        }

        .my-id {
            font-family: monospace;
            font-size: 0.9rem;
            color: #63b3ed;
            word-break: break-all;
            margin-bottom: 8px;
        }

        .copy-btn {
            width: 100%;
            padding: 8px;
            background: rgba(99, 179, 237, 0.2);
            border: 1px solid rgba(99, 179, 237, 0.3);
            color: #63b3ed;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.85rem;
            transition: all 0.2s;
        }

        .copy-btn:hover {
            background: rgba(99, 179, 237, 0.3);
        }

        .input-field {
            width: 100%;
            padding: 12px 14px;
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.15);
            background: rgba(11, 22, 47, 0.7);
            color: white;
            font-size: 0.95rem;
            transition: all 0.3s;
            margin-bottom: 10px;
        }

        .input-field:focus {
            outline: none;
            border-color: rgba(99, 179, 237, 0.6);
            box-shadow: 0 0 0 3px rgba(99, 179, 237, 0.15);
        }

        .input-field::placeholder {
            color: #64748b;
        }

        .btn {
            padding: 10px 16px;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            width: 100%;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-primary {
            background: linear-gradient(45deg, #4f46e5, #7c3aed);
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(79, 70, 229, 0.4);
        }

        .btn-secondary {
            background: rgba(30, 41, 59, 0.8);
            color: #94a3b8;
            border: 1px solid rgba(148, 163, 184, 0.2);
        }

        .btn-secondary:hover:not(:disabled) {
            background: rgba(51, 65, 85, 0.8);
            color: #cbd5e1;
        }

        .btn-success {
            background: linear-gradient(45deg, #059669, #10b981);
            color: white;
        }

        .btn-danger {
            background: linear-gradient(45deg, #dc2626, #ef4444);
            color: white;
        }

        /* Peers list */
        .peers-list {
            flex: 1;
            overflow-y: auto;
            padding: 10px 20px;
        }

        .peer-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 12px;
            border-radius: 10px;
            margin-bottom: 8px;
            background: rgba(30, 41, 59, 0.5);
            border: 1px solid rgba(255, 255, 255, 0.05);
            transition: all 0.2s;
        }

        .peer-item:hover {
            background: rgba(30, 41, 59, 0.8);
        }

        .peer-item.connected {
            border-color: rgba(52, 211, 153, 0.3);
        }

        .peer-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: linear-gradient(45deg, #4f46e5, #7c3aed);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 0.9rem;
            flex-shrink: 0;
        }

        .peer-details {
            flex: 1;
            min-width: 0;
        }

        .peer-name {
            color: #e2e8f0;
            font-weight: 500;
            font-size: 0.9rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .peer-status {
            font-size: 0.75rem;
            color: #64748b;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .peer-status.online {
            color: #34d399;
        }

        .status-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: currentColor;
        }

        .encryption-badge {
            font-size: 0.7rem;
            padding: 2px 6px;
            border-radius: 4px;
            background: rgba(52, 211, 153, 0.2);
            color: #34d399;
        }

        /* Main chat area */
        .chat-area {
            display: flex;
            flex-direction: column;
            background: rgba(15, 23, 42, 0.5);
        }

        .chat-header {
            padding: 16px 20px;
            background: rgba(11, 18, 39, 0.8);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .chat-header-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .chat-header-info h2 {
            color: #e2e8f0;
            font-size: 1.1rem;
        }

        .chat-header-info .room-id {
            font-size: 0.8rem;
            color: #64748b;
            font-family: monospace;
        }

        .participants-count {
            display: flex;
            align-items: center;
            gap: 6px;
            color: #94a3b8;
            font-size: 0.85rem;
        }

        .messages-container {
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 12px;
            min-height: 0;
            scroll-behavior: smooth;
        }

        .message {
            max-width: 75%;
            padding: 12px 16px;
            border-radius: 16px;
            position: relative;
            animation: fadeIn 0.3s ease;
            word-wrap: break-word;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .message.sent {
            background: linear-gradient(45deg, #4f46e5, #6366f1);
            color: white;
            align-self: flex-end;
            border-bottom-right-radius: 4px;
        }

        .message.received {
            background: rgba(30, 41, 59, 0.9);
            color: #e2e8f0;
            align-self: flex-start;
            border-bottom-left-radius: 4px;
        }

        .message.system {
            background: rgba(30, 41, 59, 0.5);
            color: #94a3b8;
            align-self: center;
            max-width: 90%;
            font-size: 0.85rem;
            border-radius: 10px;
            text-align: center;
        }

        .message-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 4px;
            gap: 12px;
        }

        .message-sender {
            font-weight: 600;
            font-size: 0.8rem;
            color: #81e6d9;
        }

        .message.sent .message-sender {
            color: rgba(255, 255, 255, 0.8);
        }

        .message-time {
            font-size: 0.7rem;
            opacity: 0.7;
        }

        .message-content {
            line-height: 1.4;
        }

        .message-encryption {
            font-size: 0.65rem;
            margin-top: 4px;
            opacity: 0.6;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        /* File message */
        .file-message {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 10px;
            padding: 12px;
            margin-top: 8px;
        }

        .file-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .file-icon {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            background: rgba(99, 179, 237, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            color: #63b3ed;
        }

        .file-details {
            flex: 1;
        }

        .file-name {
            font-weight: 500;
            font-size: 0.9rem;
            word-break: break-all;
        }

        .file-size {
            font-size: 0.75rem;
            opacity: 0.7;
        }

        .file-progress {
            margin-top: 8px;
            height: 4px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 2px;
            overflow: hidden;
        }

        .file-progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #4f46e5, #7c3aed);
            transition: width 0.3s;
        }

        .file-download {
            margin-top: 8px;
            padding: 8px 12px;
            background: rgba(99, 179, 237, 0.2);
            border: none;
            border-radius: 6px;
            color: #63b3ed;
            cursor: pointer;
            font-size: 0.85rem;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .file-download:hover {
            background: rgba(99, 179, 237, 0.3);
        }

        /* Image preview */
        .image-preview {
            max-width: 300px;
            max-height: 200px;
            border-radius: 8px;
            margin-top: 8px;
            cursor: pointer;
        }

        /* Settings modal styles */
        .settings-modal {
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .settings-section {
            margin-bottom: 20px;
            padding-bottom: 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .settings-section:last-child {
            border-bottom: none;
        }

        .settings-section h4 {
            color: #e2e8f0;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .ice-server-item {
            background: rgba(30, 41, 59, 0.5);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 12px;
            margin-bottom: 10px;
            display: flex;
            align-items: flex-start;
            gap: 10px;
        }

        .ice-server-details {
            flex: 1;
        }

        .ice-server-details .server-url {
            color: #63b3ed;
            font-family: monospace;
            font-size: 0.85rem;
            margin-bottom: 4px;
        }

        .ice-server-details .server-credentials {
            color: #64748b;
            font-size: 0.75rem;
        }

        .ice-server-type {
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 0.7rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .ice-server-type.stun {
            background: rgba(99, 179, 237, 0.2);
            color: #63b3ed;
        }

        .ice-server-type.turn {
            background: rgba(251, 191, 36, 0.2);
            color: #fbbf24;
        }

        .ice-server-type.turns {
            background: rgba(52, 211, 153, 0.2);
            color: #34d399;
        }

        .delete-ice-server {
            background: none;
            border: none;
            color: #ef4444;
            cursor: pointer;
            padding: 4px;
            border-radius: 4px;
            transition: all 0.2s;
        }

        .delete-ice-server:hover {
            background: rgba(239, 68, 68, 0.1);
        }

        .add-ice-server-form {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 10px;
        }

        .add-ice-server-form .full-width {
            grid-column: 1 / -1;
        }

        .connection-status {
            padding: 12px;
            border-radius: 10px;
            background: rgba(30, 41, 59, 0.5);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .connection-status .status-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.85rem;
        }

        .connection-status .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #64748b;
        }

        .connection-status .status-dot.connected {
            background: #34d399;
        }

        .connection-status .status-dot.connecting {
            background: #fbbf24;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .reset-btn {
            background: rgba(239, 68, 68, 0.2);
            border: 1px solid rgba(239, 68, 68, 0.3);
            color: #ef4444;
        }

        .reset-btn:hover:not(:disabled) {
            background: rgba(239, 68, 68, 0.3);
        }

        /* Settings button in header */
        .settings-btn {
            position: absolute;
            top: 20px;
            right: 25px;
            width: 40px;
            height: 40px;
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            background: rgba(30, 41, 59, 0.8);
            color: #94a3b8;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .settings-btn:hover {
            background: rgba(51, 65, 85, 0.8);
            color: #e2e8f0;
            transform: rotate(90deg);
        }

        /* Input area */
        .input-area {
            padding: 16px 20px;
            background: rgba(11, 18, 39, 0.8);
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .input-row {
            display: flex;
            gap: 10px;
            align-items: flex-end;
        }

        .input-actions {
            display: flex;
            gap: 8px;
        }

        .action-btn {
            width: 44px;
            height: 44px;
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            background: rgba(30, 41, 59, 0.8);
            color: #94a3b8;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .action-btn:hover {
            background: rgba(51, 65, 85, 0.8);
            color: #e2e8f0;
        }

        .action-btn.active {
            background: rgba(99, 179, 237, 0.2);
            color: #63b3ed;
            border-color: rgba(99, 179, 237, 0.3);
        }

        .message-input-wrapper {
            flex: 1;
            position: relative;
        }

        .message-input {
            width: 100%;
            padding: 12px 16px;
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            background: rgba(30, 41, 59, 0.8);
            color: white;
            font-size: 0.95rem;
            resize: none;
            min-height: 44px;
            max-height: 120px;
        }

        .message-input:focus {
            outline: none;
            border-color: rgba(99, 179, 237, 0.5);
        }

        .message-input:disabled {
            opacity: 0.5;
        }

        .send-btn {
            width: 44px;
            height: 44px;
            border-radius: 12px;
            border: none;
            background: linear-gradient(45deg, #4f46e5, #7c3aed);
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .send-btn:hover:not(:disabled) {
            transform: scale(1.05);
        }

        .send-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Typing indicator */
        .typing-indicator {
            padding: 8px 20px;
            color: #64748b;
            font-size: 0.8rem;
            display: none;
        }

        .typing-indicator.active {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .typing-dots {
            display: flex;
            gap: 3px;
        }

        .typing-dots span {
            width: 5px;
            height: 5px;
            border-radius: 50%;
            background: #64748b;
            animation: bounce 1.4s infinite ease-in-out;
        }

        .typing-dots span:nth-child(1) { animation-delay: 0s; }
        .typing-dots span:nth-child(2) { animation-delay: 0.2s; }
        .typing-dots span:nth-child(3) { animation-delay: 0.4s; }

        @keyframes bounce {
            0%, 80%, 100% { transform: translateY(0); }
            40% { transform: translateY(-5px); }
        }

        /* File input hidden */
        #file-input {
            display: none;
        }

        /* Toast */
        .toast {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: rgba(17, 24, 39, 0.95);
            color: white;
            padding: 14px 24px;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
            z-index: 1000;
            transition: transform 0.3s;
            border: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .toast.show {
            transform: translateX(-50%) translateY(0);
        }

        .toast.success { border-color: rgba(52, 211, 153, 0.5); }
        .toast.error { border-color: rgba(239, 68, 68, 0.5); }
        .toast.warning { border-color: rgba(251, 191, 36, 0.5); }

        /* Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s;
        }

        .modal-overlay.show {
            opacity: 1;
            visibility: visible;
        }

        .modal {
            background: rgba(15, 23, 42, 0.98);
            border-radius: 20px;
            padding: 24px;
            max-width: 450px;
            width: 90%;
            border: 1px solid rgba(255, 255, 255, 0.1);
            transform: scale(0.9);
            transition: transform 0.3s;
        }

        .modal-overlay.show .modal {
            transform: scale(1);
        }

        .modal h3 {
            color: #e2e8f0;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .modal-actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .modal-actions .btn {
            flex: 1;
        }

        /* Connection status bar */
        .status-bar {
            padding: 8px 20px;
            background: rgba(11, 18, 39, 0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            font-size: 0.8rem;
            border-top: 1px solid rgba(255, 255, 255, 0.05);
        }

        .status-bar.connecting {
            color: #fbbf24;
        }

        .status-bar.connected {
            color: #34d399;
        }

        .status-bar.error {
            color: #f87171;
        }

        .spinner {
            width: 14px;
            height: 14px;
            border: 2px solid currentColor;
            border-top-color: transparent;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Responsive */
        @media (max-width: 768px) {
            .mobile-menu-btn {
                display: flex;
            }

            .mobile-close-btn {
                display: flex;
            }

            .main-layout {
                grid-template-columns: 1fr;
            }

            .sidebar {
                display: none;
            }

            .sidebar.mobile-show {
                display: flex;
                position: fixed;
                top: 0;
                left: 0;
                bottom: 0;
                width: 280px;
                z-index: 100;
                box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.9);
            }

            h1 {
                font-size: 1.6rem;
            }

            .badges {
                display: none;
            }
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(99, 179, 237, 0.4);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: rgba(99, 179, 237, 0.6);
        }

        ::-webkit-scrollbar-corner {
            background: rgba(255, 255, 255, 0.05);
        }

        /* Firefox scrollbar */
        * {
            scrollbar-width: thin;
            scrollbar-color: rgba(99, 179, 237, 0.4) rgba(255, 255, 255, 0.05);
        }

        /* Room creation section */
        .room-options {
            display: flex;
            gap: 8px;
            margin-bottom: 10px;
        }

        .room-option {
            flex: 1;
            padding: 10px;
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            background: rgba(30, 41, 59, 0.5);
            color: #94a3b8;
            cursor: pointer;
            text-align: center;
            font-size: 0.8rem;
            transition: all 0.2s;
        }

        .room-option:hover, .room-option.active {
            border-color: rgba(99, 179, 237, 0.5);
            color: #63b3ed;
            background: rgba(99, 179, 237, 0.1);
        }

        /* The Street - Home Page */
        .the-street {
            display: none;
            flex-direction: column;
            gap: 30px;
            padding: 40px 30px;
            max-width: 1200px;
            margin: 0 auto;
        }

        .the-street.active {
            display: flex;
        }

        .street-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .street-title {
            font-size: 2.5rem;
            background: linear-gradient(to right, #63b3ed, #81e6d9, #f093fb);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            margin-bottom: 10px;
        }

        .street-subtitle {
            color: #94a3b8;
            font-size: 1.1rem;
        }

        .street-actions {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-bottom: 40px;
            flex-wrap: wrap;
        }

        .street-btn {
            padding: 14px 24px;
            border-radius: 12px;
            border: none;
            font-weight: 600;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            min-width: 180px;
            justify-content: center;
        }

        .street-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .street-btn.primary {
            background: linear-gradient(45deg, #4f46e5, #7c3aed);
            color: white;
            box-shadow: 0 4px 15px rgba(79, 70, 229, 0.4);
        }

        .street-btn.primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(79, 70, 229, 0.5);
        }

        .street-btn.secondary {
            background: rgba(30, 41, 59, 0.8);
            color: #94a3b8;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .street-btn.secondary:hover:not(:disabled) {
            background: rgba(51, 65, 85, 0.8);
            color: #e2e8f0;
        }

        .public-rooms-section {
            background: rgba(30, 41, 59, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            padding: 30px;
        }

        .section-title {
            color: #e2e8f0;
            font-size: 1.3rem;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .rooms-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
        }

        .room-card {
            background: rgba(15, 23, 42, 0.6);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            padding: 20px;
            transition: all 0.3s;
            cursor: pointer;
        }

        .room-card:hover {
            border-color: rgba(99, 179, 237, 0.4);
            transform: translateY(-4px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
        }

        .room-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 12px;
        }

        .room-name {
            font-size: 1.2rem;
            font-weight: 600;
            color: #e2e8f0;
            flex: 1;
        }

        .room-participants-badge {
            background: rgba(99, 179, 237, 0.2);
            color: #63b3ed;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.75rem;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .room-description {
            color: #94a3b8;
            font-size: 0.9rem;
            margin-bottom: 12px;
            line-height: 1.5;
        }

        .room-creator {
            color: #64748b;
            font-size: 0.85rem;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .room-creator-avatar {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: linear-gradient(45deg, #4f46e5, #7c3aed);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 0.8rem;
            color: white;
        }

        .join-room-btn {
            width: 100%;
            padding: 10px;
            background: linear-gradient(45deg, #4f46e5, #7c3aed);
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }

        .join-room-btn:hover {
            transform: scale(1.02);
        }

        .no-rooms {
            text-align: center;
            padding: 40px;
            color: #64748b;
        }

        /* Room creation modal */
        .create-room-modal {
            max-width: 500px;
        }

        .create-room-form {
            display: grid;
            gap: 15px;
        }

        .room-visibility-toggle {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }

        .visibility-option {
            flex: 1;
            padding: 15px;
            border: 2px solid rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            background: rgba(30, 41, 59, 0.5);
            color: #94a3b8;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
        }

        .visibility-option:hover {
            border-color: rgba(99, 179, 237, 0.4);
        }

        .visibility-option.active {
            border-color: #63b3ed;
            background: rgba(99, 179, 237, 0.1);
            color: #63b3ed;
        }

        .visibility-icon {
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(99, 179, 237, 0.1);
            border-radius: 8px;
        }

        .visibility-title {
            font-weight: 600;
            color: #e2e8f0;
        }

        .visibility-description {
            font-size: 0.85rem;
            color: #64748b;
            text-align: center;
        }

        /* My rooms section */
        .my-rooms-section {
            background: rgba(52, 211, 153, 0.05);
            border: 1px solid rgba(52, 211, 153, 0.1);
            border-radius: 20px;
            padding: 30px;
        }

        .my-rooms-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .my-rooms-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 15px;
        }

        /* App visibility */
        .app-container {
            display: none;
        }

        .app-container.active {
            display: block;
        }

        .encryption-info {
            background: rgba(52, 211, 153, 0.1);
            border: 1px solid rgba(52, 211, 153, 0.2);
            border-radius: 8px;
            padding: 10px;
            margin-top: 10px;
            font-size: 0.75rem;
            color: #34d399;
            display: flex;
            align-items: flex-start;
            gap: 8px;
        }

        .encryption-info svg {
            flex-shrink: 0;
            margin-top: 2px;
        }
    </style>
</head>
<body>
    <!-- The Street - Home Page -->
    <div class="the-street" id="the-street">
        <div class="street-header">
            <h1 class="street-title">üèõÔ∏è The Street</h1>
            <p class="street-subtitle">D√©couvrez et rejoignez des salons de discussion P2P chiffr√©s</p>
        </div>

        <div class="street-actions">
            <button class="street-btn primary" id="create-room-btn">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M12 5v14M5 12h14"></path>
                    <circle cx="12" cy="12" r="3"></circle>
                </svg>
                Cr√©er un salon
            </button>
            <button class="street-btn secondary" id="join-with-id-btn">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path>
                    <polyline points="15 3 21 3 21 9"></polyline>
                    <line x1="10" y1="14" x2="21" y2="3"></line>
                </svg>
                Rejoindre avec ID
            </button>
            <button class="street-btn secondary" id="my-rooms-btn">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V9a2 2 0 0 1 2-2h6"></path>
                    <polyline points="9 22 9 12 15 12 3"></polyline>
                </svg>
                Mes salons
            </button>
        </div>

        <!-- Public Rooms Section -->
        <div class="public-rooms-section">
            <h2 class="section-title">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                    <circle cx="9" cy="7" r="4"></circle>
                    <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                    <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                </svg>
                Salons publics
            </h2>
            <div class="rooms-grid" id="public-rooms-list">
                <div class="no-rooms">
                    <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" style="opacity:0.3;">
                        <circle cx="12" cy="12" r="10"></circle>
                        <path d="M12 8v8"></path>
                    </svg>
                    <p>Aucun salon public disponible</p>
                    <p style="font-size:0.85rem;margin-top:10px;">Soyez le premier √† cr√©er un salon public !</p>
                </div>
            </div>
        </div>
    </div>

    <!-- My Rooms Section -->
    <div class="container my-rooms-section" id="my-rooms-section" style="display:none;">
        <div class="my-rooms-header">
            <h2 class="section-title">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V9a2 2 0 0 1 2-2h6"></path>
                    <polyline points="9 22 9 12 15 12 3"></polyline>
                </svg>
                Mes salons
            </h2>
            <button class="btn btn-secondary" id="back-to-street-btn">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M15 18l-6-6 6 6"></path>
                </svg>
                Retour
            </button>
        </div>
        <div class="my-rooms-grid" id="my-rooms-list">
            <!-- User's rooms will be rendered here -->
        </div>
    </div>

    <!-- Main Chat App -->
    <div class="container app-container" id="app-container">
        <header>
            <button class="street-back-btn" id="back-to-street-app-btn" title="Retour √† The Street">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M15 18l-6-6 6 6"></path>
                </svg>
            </button>
            <button class="mobile-menu-btn" id="mobile-menu-btn" title="Menu">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="3" y1="12" x2="21" y2="12"></line>
                    <line x1="3" y1="6" x2="21" y2="6"></line>
                    <line x1="3" y1="18" x2="21" y2="18"></line>
                </svg>
            </button>
            <button class="settings-btn" id="settings-btn" title="Param√®tres de connexion">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="3"></circle>
                    <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path>
                </svg>
            </button>
            <h1>PeerText</h1>
            <p class="subtitle">Messagerie P2P chiffr√©e de bout en bout</p>
            <div class="badges">
                <span class="badge e2e">
                    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
                        <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
                    </svg>
                    Chiffrement E2E AES-256
                </span>
                <span class="badge p2p">
                    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="2"></circle>
                        <path d="M16.24 7.76a6 6 0 0 1 0 8.49m-8.48-.01a6 6 0 0 1 0-8.49m11.31-2.82a10 10 0 0 1 0 14.14m-14.14 0a10 10 0 0 1 0-14.14"></path>
                    </svg>
                    WebRTC P2P
                </span>
                <span class="badge files">
                    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                        <polyline points="14 2 14 8 20 8"></polyline>
                    </svg>
                    Transfert de fichiers
                </span>
                <span class="badge rooms">
                    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                        <circle cx="9" cy="7" r="4"></circle>
                        <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                        <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                    </svg>
                    Salons multi-utilisateurs
                </span>
            </div>
        </header>

        <!-- Mobile sidebar overlay -->
        <div class="sidebar-overlay" id="sidebar-overlay"></div>

        <div class="main-layout">
            <!-- Sidebar -->
            <button class="mobile-close-btn" id="mobile-close-btn" title="Fermer">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="18" y1="6" x2="6" y2="18"></line>
                    <line x1="6" y1="6" x2="18" y2="18"></line>
                </svg>
            </button>
            <div class="sidebar" id="sidebar">
                <div class="sidebar-section">
                    <h3>
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                            <circle cx="12" cy="7" r="4"></circle>
                        </svg>
                        Mon profil
                    </h3>
                    <input type="text" id="my-name" class="input-field" placeholder="Votre pseudo" maxlength="20">
                    <div class="my-info">
                        <div class="my-id" id="my-peer-id">Connexion...</div>
                        <button class="copy-btn" id="copy-id-btn">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="display:inline;vertical-align:middle;margin-right:4px;">
                                <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                                <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                            </svg>
                            Copier mon ID
                        </button>
                    </div>
                </div>

                <div class="sidebar-section">
                    <h3>
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path>
                            <polyline points="15 3 21 3 21 9"></polyline>
                            <line x1="10" y1="14" x2="21" y2="3"></line>
                        </svg>
                        Connexion directe
                    </h3>
                    <input type="text" id="peer-id-input" class="input-field" placeholder="ID du pair (PT-XXXXXXXX)" style="text-transform:uppercase;">
                    <button class="btn btn-primary" id="connect-peer-btn">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path>
                            <polyline points="15 3 21 3 21 9"></polyline>
                            <line x1="10" y1="14" x2="21" y2="3"></line>
                        </svg>
                        Se connecter
                    </button>
                    <div class="encryption-info">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path>
                        </svg>
                        <span>√âchangez vos IDs (PT-XXXXXXXX) puis connectez-vous. Chiffrement AES-256-GCM automatique.</span>
                    </div>
                </div>

                <div class="sidebar-section" style="flex:1;display:flex;flex-direction:column;">
                    <h3>
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                            <circle cx="9" cy="7" r="4"></circle>
                            <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                            <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                        </svg>
                        Participants (<span id="participants-count">0</span>)
                    </h3>
                    <div class="peers-list" id="peers-list">
                        <div style="color:#64748b;font-size:0.85rem;text-align:center;padding:20px;">
                            Aucun participant connect√©
                        </div>
                    </div>
                </div>
            </div>

            <!-- Chat area -->
            <div class="chat-area">
                <div class="chat-header">
                    <div class="chat-header-info">
                        <h2 id="room-name">Chat P2P</h2>
                        <span class="room-id" id="current-room-id">Chiffrement E2E activ√©</span>
                    </div>
                    <div class="participants-count">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                            <circle cx="9" cy="7" r="4"></circle>
                            <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                            <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                        </svg>
                        <span id="header-participants">0</span> connect√©(s)
                    </div>
                </div>

                <div class="messages-container" id="messages-container">
                    <div class="message system">
                        Bienvenue sur PeerText ! Copiez votre ID et partagez-le, puis entrez l'ID de votre correspondant pour vous connecter.
                    </div>
                </div>

                <div class="typing-indicator" id="typing-indicator">
                    <div class="typing-dots">
                        <span></span><span></span><span></span>
                    </div>
                    <span id="typing-names">Quelqu'un √©crit...</span>
                </div>

                <div class="input-area">
                    <div class="input-row">
                        <div class="input-actions">
                            <button class="action-btn" id="attach-btn" title="Envoyer un fichier">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M21.44 11.05l-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66l-9.2 9.19a2 2 0 0 1-2.83-2.83l8.49-8.48"></path>
                                </svg>
                            </button>
                        </div>
                        <div class="message-input-wrapper">
                            <textarea id="message-input" class="message-input" placeholder="Rejoignez un salon pour discuter..." rows="1" disabled></textarea>
                        </div>
                        <button class="send-btn" id="send-btn" disabled title="Envoyer">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <line x1="22" y1="2" x2="11" y2="13"></line>
                                <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
                            </svg>
                        </button>
                    </div>
                </div>

                <div class="status-bar connecting" id="status-bar">
                    <div class="spinner"></div>
                    <span>Connexion au r√©seau P2P...</span>
                </div>
            </div>
        </div>
    </div>

    <!-- File input -->
    <input type="file" id="file-input" multiple>

    <!-- Toast -->
    <div class="toast" id="toast"></div>

    <!-- Image modal -->
    <div class="modal-overlay" id="image-modal">
        <div class="modal" style="max-width:90%;max-height:90%;padding:10px;">
            <img id="modal-image" style="max-width:100%;max-height:80vh;border-radius:8px;">
        </div>
    </div>

    <!-- Create Room modal -->
    <div class="modal-overlay" id="create-room-modal">
        <div class="modal create-room-modal">
            <h3>
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M12 5v14M5 12h14"></path>
                    <circle cx="12" cy="12" r="3"></circle>
                </svg>
                Cr√©er un nouveau salon
            </h3>

            <input type="text" id="room-name-input" class="input-field" placeholder="Nom du salon" maxlength="30">

            <textarea id="room-description-input" class="input-field" placeholder="Description (optionnelle)" rows="3" maxlength="200"></textarea>

            <div style="margin: 20px 0;">
                <label style="display:block;color:#94a3b8;font-size:0.85rem;margin-bottom:10px;">Visibilit√© du salon</label>
                <div class="room-visibility-toggle">
                    <div class="visibility-option active" id="visibility-private" data-type="private">
                        <div class="visibility-icon">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
                                <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
                            </svg>
                        </div>
                        <span class="visibility-title">Priv√©</span>
                        <span class="visibility-description">Salon accessible uniquement via l'ID</span>
                    </div>
                    <div class="visibility-option" id="visibility-public" data-type="public">
                        <div class="visibility-icon">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                                <circle cx="9" cy="7" r="4"></circle>
                                <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                                <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                            </svg>
                        </div>
                        <span class="visibility-title">Public</span>
                        <span class="visibility-description">Visible dans The Street</span>
                    </div>
                </div>
            </div>

            <div class="modal-actions">
                <button class="btn btn-secondary" id="cancel-create-room-btn">Annuler</button>
                <button class="btn btn-primary" id="confirm-create-room-btn">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M12 5v14M5 12h14"></path>
                        <circle cx="12" cy="12" r="3"></circle>
                    </svg>
                    Cr√©er le salon
                </button>
            </div>
        </div>
    </div>

    <!-- Settings modal -->
    <div class="modal-overlay" id="settings-modal">
        <div class="modal settings-modal">
            <h3>
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="3"></circle>
                    <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path>
                </svg>
                Configuration des serveurs ICE
            </h3>

            <!-- Connection status -->
            <div class="connection-status">
                <div class="status-indicator">
                    <span class="status-dot" id="connection-status-dot"></span>
                    <span id="connection-status-text">En attente de connexion...</span>
                </div>
            </div>

            <div class="settings-section">
                <h4>
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10"></circle>
                        <line x1="2" y1="12" x2="22" y2="12"></line>
                        <path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"></path>
                    </svg>
                    Serveurs STUN/TURN configur√©s
                </h4>
                <div id="ice-servers-list">
                    <!-- ICE servers will be listed here -->
                </div>
            </div>

            <div class="settings-section">
                <h4>
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10"></circle>
                        <line x1="12" y1="8" x2="12" y2="16"></line>
                        <line x1="8" y1="12" x2="16" y2="12"></line>
                    </svg>
                    Ajouter un serveur ICE
                </h4>
                <div class="add-ice-server-form">
                    <select id="ice-server-type" class="input-field">
                        <option value="stun">STUN</option>
                        <option value="turn">TURN (TCP)</option>
                        <option value="turns">TURN (TLS)</option>
                    </select>
                    <input type="text" id="ice-server-url" class="input-field" placeholder="URL (ex: stun:stun.example.com:3478)">
                    <input type="text" id="ice-server-username" class="input-field" placeholder="Nom d'utilisateur (TURN)">
                    <input type="password" id="ice-server-credential" class="input-field" placeholder="Mot de passe (TURN)">
                    <button class="btn btn-success" id="add-ice-server-btn">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="12" y1="5" x2="12" y2="19"></line>
                            <line x1="5" y1="12" x2="19" y2="12"></line>
                        </svg>
                        Ajouter
                    </button>
                </div>
            </div>

            <div class="settings-section">
                <h4>
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M22 12h-4l-3 9L9 3l-3 9H2"></path>
                    </svg>
                    Serveur de signalisation
                </h4>
                <div style="color:#94a3b8;font-size:0.8rem;margin-bottom:10px;">
                    Le serveur par d√©faut est utilis√©. Vous pouvez configurer un serveur personnalis√© ci-dessous.
                </div>
                <input type="text" id="signaling-host" class="input-field" placeholder="Host (ex: 0.peerjs.com)">
                <input type="number" id="signaling-port" class="input-field" placeholder="Port (ex: 443)" value="443">
                <input type="text" id="signaling-path" class="input-field" placeholder="Path (ex: /)" value="/">
                <button class="btn btn-secondary" id="save-signaling-btn">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path>
                        <polyline points="17 21 17 13 7 13 7 21"></polyline>
                        <polyline points="7 3 7 8 15 8"></polyline>
                    </svg>
                    Sauvegarder
                </button>
                <button class="btn btn-secondary reset-btn" id="reset-signaling-btn" style="margin-top:10px;">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"></path>
                        <path d="M3 3v5h5"></path>
                    </svg>
                    R√©initialiser par d√©faut
                </button>
            </div>

            <div class="settings-section">
                <h4>
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10"></circle>
                        <path d="M8 14s1.5 2 4 2 4-2 4-2"></path>
                        <line x1="9" y1="9" x2="9.01" y2="9"></line>
                        <line x1="15" y1="9" x2="15.01" y2="9"></line>
                    </svg>
                    Diagnostic et aide
                </h4>
                <div id="diagnostic-info" style="background:rgba(30, 41, 59, 0.5);border:1px solid rgba(255,255,255,0.1);border-radius:10px;padding:12px;font-size:0.85rem;color:#94a3b8;">
                    <div style="margin-bottom:8px;">
                        <strong>√âtat actuel:</strong>
                        <div id="diagnostic-status">Chargement...</div>
                    </div>
                    <div style="margin-bottom:8px;">
                        <strong>Nombre de connexions P2P:</strong>
                        <span id="diagnostic-connections">0</span>
                    </div>
                    <div style="margin-bottom:8px;">
                        <strong>HTTPS:</strong>
                        <span id="diagnostic-https">-</span>
                    </div>
                    <div>
                        <strong>WebRTC support√©:</strong>
                        <span id="diagnostic-webrtc">-</span>
                    </div>
                </div>
                <div style="margin-top:15px;padding:10px;background:rgba(99, 179, 237, 0.1);border:1px solid rgba(99, 179, 237, 0.2);border-radius:8px;font-size:0.8rem;color:#63b3ed;">
                    <strong>üí° Conseils de d√©pannage:</strong>
                    <ul style="margin-left:20px;margin-top:8px;line-height:1.6;">
                        <li>Assurez-vous d'utiliser <strong>HTTPS</strong> (obligatoire pour WebRTC)</li>
                        <li>Ajoutez des serveurs TURN pour traverser les NAT/Firewalls</li>
                        <li>V√©rifiez que votre pare-feu/antivirus ne bloque pas WebRTC</li>
                        <li>Si le pair est injoignable, il peut √™tre hors ligne</li>
                        <li>Essayez de rafra√Æchir la page si la connexion au serveur √©choue</li>
                    </ul>
                </div>
            </div>

            <div class="modal-actions">
                <button class="btn btn-secondary reset-btn" id="reset-ice-servers-btn">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"></path>
                        <path d="M3 3v5h5"></path>
                    </svg>
                    R√©initialiser
                </button>
                <button class="btn btn-secondary" id="close-settings-btn">Fermer</button>
            </div>
        </div>
    </div>

    <script>
    // ============================================
    // CONFIGURATION
    // ============================================
    // Load custom ICE servers from localStorage or use default configuration
    const savedIceServers = localStorage.getItem('customIceServers');
    const defaultIceServers = [
        // STUN servers (public)
        { urls: 'stun:stun.l.google.com:19302' },
        { urls: 'stun:stun1.l.google.com:19302' },
        { urls: 'stun:stun2.l.google.com:19302' },
        { urls: 'stun:global.stun.twilio.com:3478' },
        // TURN servers (OpenRelay - Free for testing)
        { urls: 'turn:openrelay.metered.ca:80', username: 'openrelayproject', credential: 'openrelayproject' },
        { urls: 'turn:openrelay.metered.ca:443', username: 'openrelayproject', credential: 'openrelayproject' },
        { urls: 'turns:openrelay.metered.ca:443', username: 'openrelayproject', credential: 'openrelayproject' }
    ];

    // Load custom signaling server configuration
    const savedSignalingConfig = localStorage.getItem('signalingConfig');
    let signalingConfig = null;
    if (savedSignalingConfig) {
        try {
            signalingConfig = JSON.parse(savedSignalingConfig);
        } catch (e) {
            console.error('Error parsing signaling config:', e);
        }
    }

    const CONFIG = {
        peerOptions: {
            debug: 1,
            config: {
                iceServers: savedIceServers ? JSON.parse(savedIceServers) : defaultIceServers
            },
            ...(signalingConfig ? signalingConfig : {})
        },
        chunkSize: 16384, // 16KB chunks for file transfer
        maxFileSize: 100 * 1024 * 1024, // 100MB max
        typingTimeout: 2000
    };

    // ============================================
    // STATE
    // ============================================
    const state = {
        peer: null,
        myPeerId: null,
        myName: localStorage.getItem('peerName') || 'Anonyme',
        currentRoom: null,
        isRoomCreator: false,
        connections: new Map(), // peerId -> { conn, name, publicKey, sharedKey }
        pendingConnections: new Map(),
        myKeyPair: null,
        typingPeers: new Set(),
        typingTimer: null,
        isTyping: false,
        fileTransfers: new Map(), // transferId -> { chunks, metadata }
        // Room management
        myRooms: JSON.parse(localStorage.getItem('myRooms') || '[]'),
        publicRooms: JSON.parse(localStorage.getItem('publicRooms') || '[]'),
        creatingRoomVisibility: 'private' // 'private' or 'public'
    };

    // ============================================
    // DOM ELEMENTS
    // ============================================
    const elements = {
        myName: document.getElementById('my-name'),
        myPeerId: document.getElementById('my-peer-id'),
        copyIdBtn: document.getElementById('copy-id-btn'),
        peerIdInput: document.getElementById('peer-id-input'),
        connectPeerBtn: document.getElementById('connect-peer-btn'),
        peersList: document.getElementById('peers-list'),
        participantsCount: document.getElementById('participants-count'),
        headerParticipants: document.getElementById('header-participants'),
        roomName: document.getElementById('room-name'),
        currentRoomId: document.getElementById('current-room-id'),
        messagesContainer: document.getElementById('messages-container'),
        messageInput: document.getElementById('message-input'),
        sendBtn: document.getElementById('send-btn'),
        attachBtn: document.getElementById('attach-btn'),
        fileInput: document.getElementById('file-input'),
        typingIndicator: document.getElementById('typing-indicator'),
        typingNames: document.getElementById('typing-names'),
        statusBar: document.getElementById('status-bar'),
        toast: document.getElementById('toast'),
        imageModal: document.getElementById('image-modal'),
        modalImage: document.getElementById('modal-image'),
        settingsBtn: document.getElementById('settings-btn'),
        settingsModal: document.getElementById('settings-modal'),
        iceServersList: document.getElementById('ice-servers-list'),
        iceServerType: document.getElementById('ice-server-type'),
        iceServerUrl: document.getElementById('ice-server-url'),
        iceServerUsername: document.getElementById('ice-server-username'),
        iceServerCredential: document.getElementById('ice-server-credential'),
        addIceServerBtn: document.getElementById('add-ice-server-btn'),
        resetIceServersBtn: document.getElementById('reset-ice-servers-btn'),
        closeSettingsBtn: document.getElementById('close-settings-btn'),
        connectionStatusDot: document.getElementById('connection-status-dot'),
        connectionStatusText: document.getElementById('connection-status-text'),
        signalingHost: document.getElementById('signaling-host'),
        signalingPort: document.getElementById('signaling-port'),
        signalingPath: document.getElementById('signaling-path'),
        saveSignalingBtn: document.getElementById('save-signaling-btn'),
        resetSignalingBtn: document.getElementById('reset-signaling-btn'),
        diagnosticStatus: document.getElementById('diagnostic-status'),
        diagnosticConnections: document.getElementById('diagnostic-connections'),
        diagnosticHttps: document.getElementById('diagnostic-https'),
        diagnosticWebrtc: document.getElementById('diagnostic-webrtc'),
        mobileMenuBtn: document.getElementById('mobile-menu-btn'),
        mobileCloseBtn: document.getElementById('mobile-close-btn'),
        sidebarOverlay: document.getElementById('sidebar-overlay'),
        // The Street elements
        theStreet: document.getElementById('the-street'),
        appContainer: document.getElementById('app-container'),
        createRoomBtn: document.getElementById('create-room-btn'),
        joinWithIdBtn: document.getElementById('join-with-id-btn'),
        myRoomsBtn: document.getElementById('my-rooms-btn'),
        backToStreetAppBtn: document.getElementById('back-to-street-app-btn'),
        backToStreetBtn: document.getElementById('back-to-street-btn'),
        createRoomModal: document.getElementById('create-room-modal'),
        roomNameInput: document.getElementById('room-name-input'),
        roomDescriptionInput: document.getElementById('room-description-input'),
        visibilityPrivate: document.getElementById('visibility-private'),
        visibilityPublic: document.getElementById('visibility-public'),
        cancelCreateRoomBtn: document.getElementById('cancel-create-room-btn'),
        confirmCreateRoomBtn: document.getElementById('confirm-create-room-btn'),
        publicRoomsList: document.getElementById('public-rooms-list'),
        myRoomsSection: document.getElementById('my-rooms-section'),
        myRoomsList: document.getElementById('my-rooms-list')
    };

    // ============================================
    // CRYPTO - E2E ENCRYPTION
    // ============================================
    const Crypto = {
        async generateKeyPair() {
            return await window.crypto.subtle.generateKey(
                { name: 'ECDH', namedCurve: 'P-256' },
                true,
                ['deriveKey', 'deriveBits']
            );
        },

        async exportPublicKey(publicKey) {
            const exported = await window.crypto.subtle.exportKey('raw', publicKey);
            return btoa(String.fromCharCode(...new Uint8Array(exported)));
        },

        async importPublicKey(base64Key) {
            const binary = atob(base64Key);
            const bytes = new Uint8Array(binary.length);
            for (let i = 0; i < binary.length; i++) {
                bytes[i] = binary.charCodeAt(i);
            }
            return await window.crypto.subtle.importKey(
                'raw',
                bytes,
                { name: 'ECDH', namedCurve: 'P-256' },
                true,
                []
            );
        },

        async deriveSharedKey(privateKey, publicKey) {
            return await window.crypto.subtle.deriveKey(
                { name: 'ECDH', public: publicKey },
                privateKey,
                { name: 'AES-GCM', length: 256 },
                false,
                ['encrypt', 'decrypt']
            );
        },

        async encrypt(sharedKey, data) {
            const iv = window.crypto.getRandomValues(new Uint8Array(12));
            const encoded = new TextEncoder().encode(JSON.stringify(data));
            const encrypted = await window.crypto.subtle.encrypt(
                { name: 'AES-GCM', iv },
                sharedKey,
                encoded
            );
            return {
                iv: btoa(String.fromCharCode(...iv)),
                data: btoa(String.fromCharCode(...new Uint8Array(encrypted)))
            };
        },

        async decrypt(sharedKey, encryptedData) {
            const iv = new Uint8Array(atob(encryptedData.iv).split('').map(c => c.charCodeAt(0)));
            const data = new Uint8Array(atob(encryptedData.data).split('').map(c => c.charCodeAt(0)));
            const decrypted = await window.crypto.subtle.decrypt(
                { name: 'AES-GCM', iv },
                sharedKey,
                data
            );
            return JSON.parse(new TextDecoder().decode(decrypted));
        },

        async encryptFile(sharedKey, arrayBuffer) {
            const iv = window.crypto.getRandomValues(new Uint8Array(12));
            const encrypted = await window.crypto.subtle.encrypt(
                { name: 'AES-GCM', iv },
                sharedKey,
                arrayBuffer
            );
            return { iv, encrypted: new Uint8Array(encrypted) };
        },

        async decryptFile(sharedKey, iv, encryptedData) {
            return await window.crypto.subtle.decrypt(
                { name: 'AES-GCM', iv },
                sharedKey,
                encryptedData
            );
        }
    };

    // ============================================
    // INITIALIZATION
    // ============================================
    async function init() {
        elements.myName.value = state.myName;

        // Generate encryption keys
        state.myKeyPair = await Crypto.generateKeyPair();

        // Event listeners
        elements.myName.addEventListener('input', handleNameChange);
        elements.copyIdBtn.addEventListener('click', copyPeerId);
        elements.connectPeerBtn.addEventListener('click', handleConnectPeer);
        elements.peerIdInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') handleConnectPeer();
        });
        elements.sendBtn.addEventListener('click', sendMessage);
        elements.messageInput.addEventListener('keydown', handleMessageKeydown);
        elements.messageInput.addEventListener('input', handleTyping);
        elements.attachBtn.addEventListener('click', () => elements.fileInput.click());
        elements.fileInput.addEventListener('change', handleFileSelect);
        elements.imageModal.addEventListener('click', () => elements.imageModal.classList.remove('show'));

        // Settings modal event listeners
        elements.settingsBtn.addEventListener('click', () => openSettingsModal());
        elements.closeSettingsBtn.addEventListener('click', () => closeSettingsModal());
        elements.settingsModal.addEventListener('click', (e) => {
            if (e.target === elements.settingsModal) closeSettingsModal();
        });
        elements.addIceServerBtn.addEventListener('click', addIceServer);
        elements.resetIceServersBtn.addEventListener('click', resetIceServers);
        elements.saveSignalingBtn.addEventListener('click', saveSignalingConfig);
        elements.resetSignalingBtn.addEventListener('click', resetSignalingConfig);

        // Mobile menu event listeners
        elements.mobileMenuBtn.addEventListener('click', toggleMobileSidebar);
        elements.mobileCloseBtn.addEventListener('click', toggleMobileSidebar);
        elements.sidebarOverlay.addEventListener('click', toggleMobileSidebar);

        // The Street event listeners
        elements.createRoomBtn.addEventListener('click', openCreateRoomModal);
        elements.joinWithIdBtn.addEventListener('click', showRoomIdJoin);
        elements.myRoomsBtn.addEventListener('click', showMyRooms);
        elements.backToStreetAppBtn.addEventListener('click', showTheStreet);
        elements.backToStreetBtn.addEventListener('click', showTheStreet);
        elements.cancelCreateRoomBtn.addEventListener('click', closeCreateRoomModal);
        elements.confirmCreateRoomBtn.addEventListener('click', createRoom);
        elements.visibilityPrivate.addEventListener('click', () => selectRoomVisibility('private'));
        elements.visibilityPublic.addEventListener('click', () => selectRoomVisibility('public'));

        // Start ping/pong interval for connection health (only when connected)
        startConnectionHealthCheck();
        
        // The Street is shown by default
        showTheStreet();
    }

    // Connection health check
    function startConnectionHealthCheck() {
        // Send ping every 30 seconds
        setInterval(() => {
            state.connections.forEach(({ conn }) => {
                if (conn && conn.open) {
                    conn.send({
                        type: 'ping',
                        timestamp: Date.now()
                    });
                }
            });

            // Check for stale connections (no response in 60 seconds)
            const now = Date.now();
            state.connections.forEach((info, peerId) => {
                if (info.lastSeen && now - info.lastSeen > 60000) {
                    console.log(`Peer ${peerId} appears disconnected`);
                    appendSystemMessage(`${info.name || 'Un utilisateur'} semble d√©connect√©`);
                }
            });
        }, 30000);
    }

    // Handle direct peer connection
    function handleConnectPeer() {
        const peerId = elements.peerIdInput.value.trim().toUpperCase();

        if (!peerId) {
            showToast('Entrez l\'ID du pair ou du salon', 'error');
            return;
        }

        if (peerId === state.myPeerId) {
            showToast('Vous ne pouvez pas vous connecter √† vous-m√™me', 'error');
            return;
        }

        if (state.connections.has(peerId)) {
            showToast('D√©j√† connect√© √† ce pair', 'warning');
            return;
        }

        // Check if it's a room ID (RM-XXXXXX)
        if (peerId.startsWith('RM-')) {
            joinRoom(peerId);
        } else {
            // It's a direct peer connection
            appendSystemMessage(`Connexion √† ${peerId}...`);
            connectToPeer(peerId);
            elements.peerIdInput.value = '';
        }
    }

    // ============================================
    // THE STREET - ROOM MANAGEMENT
    // ============================================
    function showTheStreet() {
        elements.theStreet.classList.add('active');
        elements.appContainer.classList.remove('active');
        elements.myRoomsSection.style.display = 'none';

        // Reset room state
        if (state.currentRoom) {
            leaveRoom();
        }

        // Load public rooms
        loadPublicRooms();
    }

    function showApp() {
        elements.theStreet.classList.remove('active');
        elements.appContainer.classList.add('active');
        elements.myRoomsSection.style.display = 'none';
    }

    function openCreateRoomModal() {
        elements.roomNameInput.value = '';
        elements.roomDescriptionInput.value = '';
        selectRoomVisibility('private');
        elements.createRoomModal.classList.add('show');
        elements.roomNameInput.focus();
    }

    function closeCreateRoomModal() {
        elements.createRoomModal.classList.remove('show');
    }

    function selectRoomVisibility(visibility) {
        state.creatingRoomVisibility = visibility;
        
        elements.visibilityPrivate.classList.remove('active');
        elements.visibilityPublic.classList.remove('active');
        
        if (visibility === 'private') {
            elements.visibilityPrivate.classList.add('active');
        } else {
            elements.visibilityPublic.classList.add('active');
        }
    }

    function createRoom() {
        const roomName = elements.roomNameInput.value.trim();
        const roomDescription = elements.roomDescriptionInput.value.trim();
        const visibility = state.creatingRoomVisibility;

        if (!roomName) {
            showToast('Veuillez entrer un nom de salon', 'error');
            return;
        }

        // Generate room ID
        const roomId = 'RM-' + generateId(6);
        
        const newRoom = {
            id: roomId,
            name: roomName,
            description: roomDescription,
            visibility: visibility,
            creator: state.myName,
            creatorId: state.myPeerId,
            participants: 0,
            createdAt: new Date().toISOString()
        };

        // Add to my rooms
        state.myRooms.push(newRoom);
        saveMyRooms();

        // If public, add to public rooms list
        if (visibility === 'public') {
            state.publicRooms.push(newRoom);
            savePublicRooms();
            showToast('Salon public cr√©√© avec succ√®s !', 'success');
        } else {
            showToast('Salon priv√© cr√©√© !', 'success');
        }

        closeCreateRoomModal();
        showMyRooms();
    }

    function joinRoom(roomId) {
        const room = findRoom(roomId);
        
        if (!room) {
            showToast('Salon introuvable', 'error');
            return;
        }

        state.currentRoom = room;
        state.isRoomCreator = (room.creatorId === state.myPeerId);

        // Initialize PeerJS if not already initialized
        if (!state.peer) {
            initializePeer();
        }

        showApp();
        
        // Update UI
        elements.roomName.textContent = room.name;
        elements.currentRoomId.textContent = `Salon: ${room.id} (${room.visibility === 'public' ? 'Public' : 'Priv√©'})`;
        elements.peerIdInput.placeholder = `ID du pair (PT-XXXXXXXX)`;
        
        // Connect to room creator
        if (room.creatorId && room.creatorId !== state.myPeerId) {
            connectToPeer(room.creatorId);
        }
    }

    function leaveRoom() {
        // Disconnect from all peers
        state.connections.forEach(({ conn }) => {
            if (conn && conn.open) {
                conn.close();
            }
        });
        state.connections.clear();
        state.pendingConnections.clear();
        state.currentRoom = null;
        state.isRoomCreator = false;

        elements.roomName.textContent = 'Chat P2P';
        elements.currentRoomId.textContent = 'Chiffrement E2E activ√©';
    }

    function showMyRooms() {
        elements.theStreet.classList.remove('active');
        elements.appContainer.classList.remove('active');
        elements.myRoomsSection.style.display = 'block';
        renderMyRooms();
    }

    function renderMyRooms() {
        if (state.myRooms.length === 0) {
            elements.myRoomsList.innerHTML = `
                <div class="no-rooms">
                    <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" style="opacity:0.3;">
                        <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V9a2 2 0 0 1 2-2h6"></path>
                        <polyline points="9 22 9 12 15 12 3"></polyline>
                    </svg>
                    <p>Vous n'avez pas encore cr√©√© de salon</p>
                    <p style="font-size:0.85rem;margin-top:10px;">Cr√©ez votre premier salon pour commencer !</p>
                </div>
            `;
            return;
        }

        elements.myRoomsList.innerHTML = state.myRooms.map(room => `
            <div class="room-card" onclick="joinRoom('${room.id}')">
                <div class="room-card-header">
                    <span class="room-name">${escapeHtml(room.name)}</span>
                    <span class="room-participants-badge">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                            <circle cx="9" cy="7" r="4"></circle>
                        </svg>
                        ${room.participants}
                    </span>
                </div>
                ${room.description ? `<div class="room-description">${escapeHtml(room.description)}</div>` : ''}
                <div class="room-creator">
                    <div class="room-creator-avatar">${(room.creator || '?')[0].toUpperCase()}</div>
                    <span>${room.visibility === 'public' ? 'üåê Public' : 'üîí Priv√©'}</span>
                </div>
                <button class="join-room-btn">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path>
                        <polyline points="15 3 21 3 21 9"></polyline>
                        <line x1="10" y1="14" x2="21" y2="3"></line>
                    </svg>
                    Rejoindre
                </button>
            </div>
        `).join('');
    }

    function loadPublicRooms() {
        // In a real app, this would load from a server
        // For now, use localStorage
        renderPublicRooms();
    }

    function renderPublicRooms() {
        if (state.publicRooms.length === 0) {
            elements.publicRoomsList.innerHTML = `
                <div class="no-rooms">
                    <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" style="opacity:0.3;">
                        <circle cx="12" cy="12" r="10"></circle>
                        <path d="M12 8v8"></path>
                    </svg>
                    <p>Aucun salon public disponible</p>
                    <p style="font-size:0.85rem;margin-top:10px;">Soyez le premier √† cr√©er un salon public !</p>
                </div>
            `;
            return;
        }

        elements.publicRoomsList.innerHTML = state.publicRooms.map(room => `
            <div class="room-card" onclick="joinRoom('${room.id}')">
                <div class="room-card-header">
                    <span class="room-name">${escapeHtml(room.name)}</span>
                    <span class="room-participants-badge">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                            <circle cx="9" cy="7" r="4"></circle>
                        </svg>
                        ${room.participants}
                    </span>
                </div>
                ${room.description ? `<div class="room-description">${escapeHtml(room.description)}</div>` : ''}
                <div class="room-creator">
                    <div class="room-creator-avatar">${(room.creator || '?')[0].toUpperCase()}</div>
                    <span>Par ${escapeHtml(room.creator)}</span>
                </div>
                <button class="join-room-btn">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path>
                        <polyline points="15 3 21 3 21 9"></polyline>
                        <line x1="10" y1="14" x2="21" y2="3"></line>
                    </svg>
                    Rejoindre
                </button>
            </div>
        `).join('');
    }

    function showRoomIdJoin() {
        elements.theStreet.classList.remove('active');
        elements.appContainer.classList.add('active');
        elements.peerIdInput.placeholder = `ID du salon (RM-XXXXXX)`;
        elements.peerIdInput.focus();
        showToast('Entrez l\'ID du salon pour rejoindre', 'info');
    }

    function findRoom(roomId) {
        // Search in public rooms
        let room = state.publicRooms.find(r => r.id === roomId);
        if (!room) {
            room = state.myRooms.find(r => r.id === roomId);
        }
        return room;
    }

    function saveMyRooms() {
        localStorage.setItem('myRooms', JSON.stringify(state.myRooms));
    }

    function savePublicRooms() {
        localStorage.setItem('publicRooms', JSON.stringify(state.publicRooms));
    }

    function deleteRoom(roomId, isPublic) {
        if (isPublic) {
            state.publicRooms = state.publicRooms.filter(r => r.id !== roomId);
            savePublicRooms();
        } else {
            state.myRooms = state.myRooms.filter(r => r.id !== roomId);
            saveMyRooms();
        }
        showToast('Salon supprim√©', 'success');
    }

    // ============================================
    // MESSAGING
    // ============================================
    // ICE SERVERS CONFIGURATION
    // ============================================
    function openSettingsModal() {
        renderIceServersList();
        loadSignalingConfig();
        updateConnectionStatus();
        updateDiagnostics();
        elements.settingsModal.classList.add('show');
    }

    function updateDiagnostics() {
        // Connection status
        if (state.peer && state.peer.id) {
            elements.diagnosticStatus.textContent = '‚úÖ Connect√©';
            elements.diagnosticStatus.style.color = '#34d399';
        } else {
            elements.diagnosticStatus.textContent = '‚ùå Non connect√©';
            elements.diagnosticStatus.style.color = '#ef4444';
        }

        // P2P connections
        elements.diagnosticConnections.textContent = state.connections.size;
        if (state.connections.size > 0) {
            elements.diagnosticConnections.style.color = '#34d399';
        } else {
            elements.diagnosticConnections.style.color = '#fbbf24';
        }

        // HTTPS check
        const isHttps = window.location.protocol === 'https:';
        elements.diagnosticHttps.textContent = isHttps ? '‚úÖ Oui' : '‚ùå Non (Requis pour WebRTC)';
        elements.diagnosticHttps.style.color = isHttps ? '#34d399' : '#ef4444';

        // WebRTC support
        const hasWebRTC = !!(window.RTCPeerConnection || window.webkitRTCPeerConnection || window.mozRTCPeerConnection);
        elements.diagnosticWebrtc.textContent = hasWebRTC ? '‚úÖ Oui' : '‚ùå Non';
        elements.diagnosticWebrtc.style.color = hasWebRTC ? '#34d399' : '#ef4444';
    }

    function closeSettingsModal() {
        elements.settingsModal.classList.remove('show');
    }

    function renderIceServersList() {
        const iceServers = CONFIG.peerOptions.config.iceServers;

        if (iceServers.length === 0) {
            elements.iceServersList.innerHTML = `
                <div style="color:#64748b;font-size:0.85rem;text-align:center;padding:20px;">
                    Aucun serveur ICE configur√©
                </div>
            `;
            return;
        }

        elements.iceServersList.innerHTML = iceServers.map((server, index) => {
            const url = server.urls;
            const type = getIceServerType(url);
            const hasCredentials = server.username || server.credential;

            return `
                <div class="ice-server-item">
                    <span class="ice-server-type ${type}">${type}</span>
                    <div class="ice-server-details">
                        <div class="server-url">${escapeHtml(url)}</div>
                        ${hasCredentials ? `
                            <div class="server-credentials">
                                ${server.username ? `User: ${escapeHtml(server.username)}` : ''}
                                ${server.username && server.credential ? ' | ' : ''}
                                ${server.credential ? '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢' : ''}
                            </div>
                        ` : ''}
                    </div>
                    <button class="delete-ice-server" onclick="removeIceServer(${index})" title="Supprimer">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="18" y1="6" x2="6" y2="18"></line>
                            <line x1="6" y1="6" x2="18" y2="18"></line>
                        </svg>
                    </button>
                </div>
            `;
        }).join('');
    }

    function getIceServerType(url) {
        if (url.startsWith('stun:')) return 'stun';
        if (url.startsWith('turns:')) return 'turns';
        if (url.startsWith('turn:')) return 'turn';
        return 'unknown';
    }

    function addIceServer() {
        const type = elements.iceServerType.value;
        const url = elements.iceServerUrl.value.trim();

        if (!url) {
            showToast('Veuillez entrer l\'URL du serveur', 'error');
            return;
        }

        const newServer = { urls: url };

        // Add credentials for TURN servers
        if (type !== 'stun') {
            const username = elements.iceServerUsername.value.trim();
            const credential = elements.iceServerCredential.value;

            if (username) newServer.username = username;
            if (credential) newServer.credential = credential;
        }

        // Add to configuration
        CONFIG.peerOptions.config.iceServers.push(newServer);

        // Save to localStorage
        localStorage.setItem('customIceServers', JSON.stringify(CONFIG.peerOptions.config.iceServers));

        // Clear form
        elements.iceServerUrl.value = '';
        elements.iceServerUsername.value = '';
        elements.iceServerCredential.value = '';

        // Re-render
        renderIceServersList();
        showToast('Serveur ICE ajout√©', 'success');
    }

    window.removeIceServer = function(index) {
        CONFIG.peerOptions.config.iceServers.splice(index, 1);
        localStorage.setItem('customIceServers', JSON.stringify(CONFIG.peerOptions.config.iceServers));
        renderIceServersList();
        showToast('Serveur ICE supprim√©', 'success');
    };

    function resetIceServers() {
        if (confirm('Voulez-vous vraiment r√©initialiser aux serveurs par d√©faut ?')) {
            localStorage.removeItem('customIceServers');
            CONFIG.peerOptions.config.iceServers = [...defaultIceServers];
            renderIceServersList();
            showToast('Configuration r√©initialis√©e', 'success');

            // Note: For the new servers to take effect, the user needs to refresh the page
            showToast('Actualisez la page pour appliquer les changements', 'warning');
        }
    }

    function updateConnectionStatus() {
        if (state.peer && state.peer.id) {
            elements.connectionStatusDot.classList.add('connected');
            elements.connectionStatusText.textContent = 'Connect√© au r√©seau P2P';
        } else {
            elements.connectionStatusDot.classList.remove('connected');
            elements.connectionStatusText.textContent = 'En attente de connexion...';
        }
    }

    function loadSignalingConfig() {
        const savedConfig = localStorage.getItem('signalingConfig');
        if (savedConfig) {
            try {
                const config = JSON.parse(savedConfig);
                elements.signalingHost.value = config.host || '';
                elements.signalingPort.value = config.port || '443';
                elements.signalingPath.value = config.path || '/';
            } catch (e) {
                console.error('Error loading signaling config:', e);
            }
        }
    }

    function saveSignalingConfig() {
        const host = elements.signalingHost.value.trim();
        const port = parseInt(elements.signalingPort.value) || 443;
        const path = elements.signalingPath.value.trim() || '/';

        if (!host) {
            showToast('Veuillez entrer l\'h√¥te du serveur', 'error');
            return;
        }

        const config = { host, port, path };
        localStorage.setItem('signalingConfig', JSON.stringify(config));
        showToast('Configuration du serveur sauvegard√©e', 'success');

        // Inform user that reload is needed
        showToast('Actualisez la page pour appliquer les changements', 'warning');
    }

    function resetSignalingConfig() {
        if (confirm('Voulez-vous vraiment r√©initialiser au serveur par d√©faut ?')) {
            localStorage.removeItem('signalingConfig');
            elements.signalingHost.value = '';
            elements.signalingPort.value = '443';
            elements.signalingPath.value = '/';
            showToast('Configuration r√©initialis√©e', 'success');
            showToast('Actualisez la page pour appliquer les changements', 'warning');
        }
    }

    function initializePeer() {
        const peerId = 'PT-' + generateId(8);

        try {
            state.peer = new Peer(peerId, CONFIG.peerOptions);

            state.peer.on('open', (id) => {
                state.myPeerId = id;
                elements.myPeerId.textContent = id;
                updateStatusBar('connected', 'Connect√© au r√©seau P2P');
                updateConnectionStatus();
                updateDiagnostics();
                appendSystemMessage('‚úÖ Connect√© au serveur de signalisation');
                appendSystemMessage('Pr√™t ! Partagez votre ID et entrez celui de votre correspondant pour vous connecter.');
                enableChat();
            });

            state.peer.on('connection', handleIncomingConnection);
            state.peer.on('error', handlePeerError);
            state.peer.on('disconnected', () => {
                console.log('Peer disconnected from signaling server');
                updateStatusBar('warning', 'Connexion serveur perdue. Reconnexion...');
                appendSystemMessage('‚ö†Ô∏è Connexion au serveur de signalisation perdue. Tentative de reconnexion...');
                // P2P connections remain active even if signaling server is lost
                // Reconnect to signaling server after delay
                setTimeout(() => {
                    try {
                        state.peer.reconnect();
                        console.log('Reconnecting to signaling server...');
                    } catch (e) {
                        console.error('Reconnect error:', e);
                        appendSystemMessage('‚ùå Impossible de se reconnecter au serveur. Essayez de rafra√Æchir la page.');
                    }
                }, 2000);
            });

        } catch (error) {
            console.error('Init error:', error);
            updateStatusBar('error', 'Erreur d\'initialisation');
            appendSystemMessage('‚ùå Erreur d\'initialisation: ' + error.message);
            appendSystemMessage('üí° Astuce: V√©rifiez votre connexion internet et les param√®tres du serveur de signalisation ‚öôÔ∏è');
        }
    }

    // ============================================
    // THE STREET - ROOM MANAGEMENT
    // ============================================
    function showTheStreet() {
        elements.theStreet.classList.add('active');
        elements.appContainer.classList.remove('active');
        elements.myRoomsSection.style.display = 'none';

        // Reset room state
        if (state.currentRoom) {
            leaveRoom();
        }

        // Load public rooms
        loadPublicRooms();
    }

    function showApp() {
        elements.theStreet.classList.remove('active');
        elements.appContainer.classList.add('active');
        elements.myRoomsSection.style.display = 'none';
    }

    function openCreateRoomModal() {
        elements.roomNameInput.value = '';
        elements.roomDescriptionInput.value = '';
        selectRoomVisibility('private');
        elements.createRoomModal.classList.add('show');
        elements.roomNameInput.focus();
    }

    function closeCreateRoomModal() {
        elements.createRoomModal.classList.remove('show');
    }

    function selectRoomVisibility(visibility) {
        state.creatingRoomVisibility = visibility;
        
        elements.visibilityPrivate.classList.remove('active');
        elements.visibilityPublic.classList.remove('active');
        
        if (visibility === 'private') {
            elements.visibilityPrivate.classList.add('active');
        } else {
            elements.visibilityPublic.classList.add('active');
        }
    }

    function createRoom() {
        const roomName = elements.roomNameInput.value.trim();
        const roomDescription = elements.roomDescriptionInput.value.trim();
        const visibility = state.creatingRoomVisibility;

        if (!roomName) {
            showToast('Veuillez entrer un nom de salon', 'error');
            return;
        }

        // Generate room ID
        const roomId = 'RM-' + generateId(6);
        
        const newRoom = {
            id: roomId,
            name: roomName,
            description: roomDescription,
            visibility: visibility,
            creator: state.myName,
            creatorId: state.myPeerId,
            participants: 0,
            createdAt: new Date().toISOString()
        };

        // Add to my rooms
        state.myRooms.push(newRoom);
        saveMyRooms();

        // If public, add to public rooms list
        if (visibility === 'public') {
            state.publicRooms.push(newRoom);
            savePublicRooms();
            showToast('Salon public cr√©√© avec succ√®s !', 'success');
        } else {
            showToast('Salon priv√© cr√©√© !', 'success');
        }

        closeCreateRoomModal();
        showMyRooms();
    }

    function joinRoom(roomId) {
        const room = findRoom(roomId);
        
        if (!room) {
            showToast('Salon introuvable', 'error');
            return;
        }

        state.currentRoom = room;
        state.isRoomCreator = (room.creatorId === state.myPeerId);

        // Initialize PeerJS if not already initialized
        if (!state.peer) {
            initializePeer();
        }

        showApp();
        
        // Update UI
        elements.roomName.textContent = room.name;
        elements.currentRoomId.textContent = `Salon: ${room.id} (${room.visibility === 'public' ? 'Public' : 'Priv√©'})`;
        elements.peerIdInput.placeholder = `ID du pair (PT-XXXXXXXX)`;
        
        // Connect to room creator
        if (room.creatorId && room.creatorId !== state.myPeerId) {
            connectToPeer(room.creatorId);
        }
    }

    function leaveRoom() {
        // Disconnect from all peers
        state.connections.forEach(({ conn }) => {
            if (conn && conn.open) {
                conn.close();
            }
        });
        state.connections.clear();
        state.pendingConnections.clear();
        state.currentRoom = null;
        state.isRoomCreator = false;

        elements.roomName.textContent = 'Chat P2P';
        elements.currentRoomId.textContent = 'Chiffrement E2E activ√©';
    }

    function showMyRooms() {
        elements.theStreet.classList.remove('active');
        elements.appContainer.classList.remove('active');
        elements.myRoomsSection.style.display = 'block';
        renderMyRooms();
    }

    function renderMyRooms() {
        if (state.myRooms.length === 0) {
            elements.myRoomsList.innerHTML = `
                <div class="no-rooms">
                    <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" style="opacity:0.3;">
                        <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V9a2 2 0 0 1 2-2h6"></path>
                        <polyline points="9 22 9 12 15 12 3"></polyline>
                    </svg>
                    <p>Vous n'avez pas encore cr√©√© de salon</p>
                    <p style="font-size:0.85rem;margin-top:10px;">Cr√©ez votre premier salon pour commencer !</p>
                </div>
            `;
            return;
        }

        elements.myRoomsList.innerHTML = state.myRooms.map(room => `
            <div class="room-card" onclick="joinRoom('${room.id}')">
                <div class="room-card-header">
                    <span class="room-name">${escapeHtml(room.name)}</span>
                    <span class="room-participants-badge">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                            <circle cx="9" cy="7" r="4"></circle>
                        </svg>
                        ${room.participants}
                    </span>
                </div>
                ${room.description ? `<div class="room-description">${escapeHtml(room.description)}</div>` : ''}
                <div class="room-creator">
                    <div class="room-creator-avatar">${(room.creator || '?')[0].toUpperCase()}</div>
                    <span>${room.visibility === 'public' ? 'üåê Public' : 'üîí Priv√©'}</span>
                </div>
                <button class="join-room-btn">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path>
                        <polyline points="15 3 21 3 21 9"></polyline>
                        <line x1="10" y1="14" x2="21" y2="3"></line>
                    </svg>
                    Rejoindre
                </button>
            </div>
        `).join('');
    }

    function loadPublicRooms() {
        // In a real app, this would load from a server
        // For now, use localStorage
        renderPublicRooms();
    }

    function renderPublicRooms() {
        if (state.publicRooms.length === 0) {
            elements.publicRoomsList.innerHTML = `
                <div class="no-rooms">
                    <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" style="opacity:0.3;">
                        <circle cx="12" cy="12" r="10"></circle>
                        <path d="M12 8v8"></path>
                    </svg>
                    <p>Aucun salon public disponible</p>
                    <p style="font-size:0.85rem;margin-top:10px;">Soyez le premier √† cr√©er un salon public !</p>
                </div>
            `;
            return;
        }

        elements.publicRoomsList.innerHTML = state.publicRooms.map(room => `
            <div class="room-card" onclick="joinRoom('${room.id}')">
                <div class="room-card-header">
                    <span class="room-name">${escapeHtml(room.name)}</span>
                    <span class="room-participants-badge">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                            <circle cx="9" cy="7" r="4"></circle>
                        </svg>
                        ${room.participants}
                    </span>
                </div>
                ${room.description ? `<div class="room-description">${escapeHtml(room.description)}</div>` : ''}
                <div class="room-creator">
                    <div class="room-creator-avatar">${(room.creator || '?')[0].toUpperCase()}</div>
                    <span>Par ${escapeHtml(room.creator)}</span>
                </div>
                <button class="join-room-btn">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path>
                        <polyline points="15 3 21 3 21 9"></polyline>
                        <line x1="10" y1="14" x2="21" y2="3"></line>
                    </svg>
                    Rejoindre
                </button>
            </div>
        `).join('');
    }

    function showRoomIdJoin() {
        elements.theStreet.classList.remove('active');
        elements.appContainer.classList.add('active');
        elements.peerIdInput.placeholder = `ID du salon (RM-XXXXXX)`;
        elements.peerIdInput.focus();
        showToast('Entrez l\'ID du salon pour rejoindre', 'info');
    }

    function findRoom(roomId) {
        // Search in public rooms
        let room = state.publicRooms.find(r => r.id === roomId);
        if (!room) {
            room = state.myRooms.find(r => r.id === roomId);
        }
        return room;
    }

    function saveMyRooms() {
        localStorage.setItem('myRooms', JSON.stringify(state.myRooms));
    }

    function savePublicRooms() {
        localStorage.setItem('publicRooms', JSON.stringify(state.publicRooms));
    }

    function deleteRoom(roomId, isPublic) {
        if (isPublic) {
            state.publicRooms = state.publicRooms.filter(r => r.id !== roomId);
            savePublicRooms();
        } else {
            state.myRooms = state.myRooms.filter(r => r.id !== roomId);
            saveMyRooms();
        }
        showToast('Salon supprim√©', 'success');
    }

    // ============================================
    // MESSAGING
    // ============================================
    // CONNECTION HANDLING
    // ============================================
    async function handleIncomingConnection(conn) {
        console.log('Incoming connection from:', conn.peer);

        if (state.connections.has(conn.peer)) {
            conn.close();
            return;
        }

        setupConnection(conn);
    }

    async function connectToPeer(peerId) {
        if (state.connections.has(peerId) || peerId === state.myPeerId) {
            return;
        }

        try {
            const conn = state.peer.connect(peerId, {
                reliable: true,
                serialization: 'json'
            });
            setupConnection(conn);
        } catch (error) {
            console.error('Connection error:', error);
        }
    }

    async function setupConnection(conn) {
        const peerId = conn.peer;

        state.pendingConnections.set(peerId, { conn, name: 'Connexion...' });
        updatePeersList();

        conn.on('open', async () => {
            // Send handshake with public key
            const publicKeyBase64 = await Crypto.exportPublicKey(state.myKeyPair.publicKey);
            conn.send({
                type: 'handshake',
                name: state.myName,
                publicKey: publicKeyBase64,
                room: state.currentRoom
            });
        });

        conn.on('data', async (data) => {
            await handleIncomingData(conn, data);
        });

        conn.on('close', () => {
            handlePeerDisconnect(peerId);
        });

        conn.on('error', (err) => {
            console.error('Connection error:', err);
            // Don't immediately disconnect on data channel errors during file transfer
            if (err.type === 'data-channel-error' && state.fileTransfers.size > 0) {
                console.log('Data channel error during file transfer - ignoring');
                return;
            }
            handlePeerDisconnect(peerId);
        });
    }

    async function handleIncomingData(conn, data) {
        const peerId = conn.peer;

        switch (data.type) {
            case 'handshake':
                await handleHandshake(conn, data);
                break;

            case 'encrypted':
                await handleEncryptedMessage(peerId, data);
                break;

            case 'file-start':
                handleFileStart(peerId, data);
                break;

            case 'file-chunk':
                handleFileChunk(peerId, data);
                break;

            case 'file-end':
                await handleFileEnd(peerId, data);
                break;

            case 'ping':
                // Respond to ping with pong
                const peerInfo = state.connections.get(peerId);
                if (peerInfo && peerInfo.conn) {
                    peerInfo.conn.send({ type: 'pong', timestamp: data.timestamp });
                }
                break;

            case 'pong':
                // Update last activity for this peer
                const info = state.connections.get(peerId);
                if (info) {
                    info.lastSeen = Date.now();
                }
                break;

            case 'typing':
                handleTypingIndicator(peerId, data);
                break;

            case 'peer-list':
                handlePeerList(data);
                break;
        }
    }

    async function handleHandshake(conn, data) {
        const peerId = conn.peer;

        try {
            // Check if this is a name update (no public key) or initial handshake
            const existingConnection = state.connections.get(peerId);
            
            if (data.publicKey && !existingConnection) {
                // Initial handshake - import public key and derive shared key
                const peerPublicKey = await Crypto.importPublicKey(data.publicKey);
                const sharedKey = await Crypto.deriveSharedKey(state.myKeyPair.privateKey, peerPublicKey);

                // Store new connection info
                state.connections.set(peerId, {
                    conn,
                    name: data.name || 'Anonyme',
                    publicKey: peerPublicKey,
                    sharedKey,
                    lastSeen: Date.now()
                });

                state.pendingConnections.delete(peerId);
                updatePeersList();
                updateDiagnostics();

                appendSystemMessage(`${data.name || 'Anonyme'} a rejoint le salon (E2E activ√©)`);
                showToast(`${data.name || 'Anonyme'} connect√©`, 'success');

                // If we're the room creator, share the peer list
                if (state.isRoomCreator) {
                    broadcastPeerList();
                }

                // Enable chat if not already
                enableChat();
            } else if (existingConnection) {
                // Name update - just update the name
                existingConnection.name = data.name || 'Anonyme';
                existingConnection.lastSeen = Date.now();
                updatePeersList();
            } else {
                // Invalid handshake - no connection and no public key
                console.warn('Invalid handshake: no existing connection and no public key');
                conn.close();
            }

        } catch (error) {
            console.error('Handshake error:', error);
            conn.close();
        }
    }

    function handlePeerDisconnect(peerId) {
        const peerInfo = state.connections.get(peerId);
        const name = peerInfo?.name || 'Un utilisateur';

        state.connections.delete(peerId);
        state.pendingConnections.delete(peerId);
        state.typingPeers.delete(peerId);

        updatePeersList();
        updateTypingIndicator();
        updateDiagnostics();

        appendSystemMessage(`${name} a quitt√© le salon`);
    }

    function broadcastPeerList() {
        const peerIds = Array.from(state.connections.keys());
        state.connections.forEach(({ conn }) => {
            conn.send({
                type: 'peer-list',
                peers: peerIds
            });
        });
    }

    function handlePeerList(data) {
        // Connect to any peers we're not already connected to
        data.peers.forEach(peerId => {
            if (!state.connections.has(peerId) && peerId !== state.myPeerId) {
                connectToPeer(peerId);
            }
        });
    }

    // ============================================
    // THE STREET - ROOM MANAGEMENT
    // ============================================
    function showTheStreet() {
        elements.theStreet.classList.add('active');
        elements.appContainer.classList.remove('active');
        elements.myRoomsSection.style.display = 'none';

        // Reset room state
        if (state.currentRoom) {
            leaveRoom();
        }

        // Load public rooms
        loadPublicRooms();
    }

    function showApp() {
        elements.theStreet.classList.remove('active');
        elements.appContainer.classList.add('active');
        elements.myRoomsSection.style.display = 'none';
    }

    function openCreateRoomModal() {
        elements.roomNameInput.value = '';
        elements.roomDescriptionInput.value = '';
        selectRoomVisibility('private');
        elements.createRoomModal.classList.add('show');
        elements.roomNameInput.focus();
    }

    function closeCreateRoomModal() {
        elements.createRoomModal.classList.remove('show');
    }

    function selectRoomVisibility(visibility) {
        state.creatingRoomVisibility = visibility;
        
        elements.visibilityPrivate.classList.remove('active');
        elements.visibilityPublic.classList.remove('active');
        
        if (visibility === 'private') {
            elements.visibilityPrivate.classList.add('active');
        } else {
            elements.visibilityPublic.classList.add('active');
        }
    }

    function createRoom() {
        const roomName = elements.roomNameInput.value.trim();
        const roomDescription = elements.roomDescriptionInput.value.trim();
        const visibility = state.creatingRoomVisibility;

        if (!roomName) {
            showToast('Veuillez entrer un nom de salon', 'error');
            return;
        }

        // Generate room ID
        const roomId = 'RM-' + generateId(6);
        
        const newRoom = {
            id: roomId,
            name: roomName,
            description: roomDescription,
            visibility: visibility,
            creator: state.myName,
            creatorId: state.myPeerId,
            participants: 0,
            createdAt: new Date().toISOString()
        };

        // Add to my rooms
        state.myRooms.push(newRoom);
        saveMyRooms();

        // If public, add to public rooms list
        if (visibility === 'public') {
            state.publicRooms.push(newRoom);
            savePublicRooms();
            showToast('Salon public cr√©√© avec succ√®s !', 'success');
        } else {
            showToast('Salon priv√© cr√©√© !', 'success');
        }

        closeCreateRoomModal();
        showMyRooms();
    }

    function joinRoom(roomId) {
        const room = findRoom(roomId);
        
        if (!room) {
            showToast('Salon introuvable', 'error');
            return;
        }

        state.currentRoom = room;
        state.isRoomCreator = (room.creatorId === state.myPeerId);

        // Initialize PeerJS if not already initialized
        if (!state.peer) {
            initializePeer();
        }

        showApp();
        
        // Update UI
        elements.roomName.textContent = room.name;
        elements.currentRoomId.textContent = `Salon: ${room.id} (${room.visibility === 'public' ? 'Public' : 'Priv√©'})`;
        elements.peerIdInput.placeholder = `ID du pair (PT-XXXXXXXX)`;
        
        // Connect to room creator
        if (room.creatorId && room.creatorId !== state.myPeerId) {
            connectToPeer(room.creatorId);
        }
    }

    function leaveRoom() {
        // Disconnect from all peers
        state.connections.forEach(({ conn }) => {
            if (conn && conn.open) {
                conn.close();
            }
        });
        state.connections.clear();
        state.pendingConnections.clear();
        state.currentRoom = null;
        state.isRoomCreator = false;

        elements.roomName.textContent = 'Chat P2P';
        elements.currentRoomId.textContent = 'Chiffrement E2E activ√©';
    }

    function showMyRooms() {
        elements.theStreet.classList.remove('active');
        elements.appContainer.classList.remove('active');
        elements.myRoomsSection.style.display = 'block';
        renderMyRooms();
    }

    function renderMyRooms() {
        if (state.myRooms.length === 0) {
            elements.myRoomsList.innerHTML = `
                <div class="no-rooms">
                    <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" style="opacity:0.3;">
                        <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V9a2 2 0 0 1 2-2h6"></path>
                        <polyline points="9 22 9 12 15 12 3"></polyline>
                    </svg>
                    <p>Vous n'avez pas encore cr√©√© de salon</p>
                    <p style="font-size:0.85rem;margin-top:10px;">Cr√©ez votre premier salon pour commencer !</p>
                </div>
            `;
            return;
        }

        elements.myRoomsList.innerHTML = state.myRooms.map(room => `
            <div class="room-card" onclick="joinRoom('${room.id}')">
                <div class="room-card-header">
                    <span class="room-name">${escapeHtml(room.name)}</span>
                    <span class="room-participants-badge">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                            <circle cx="9" cy="7" r="4"></circle>
                        </svg>
                        ${room.participants}
                    </span>
                </div>
                ${room.description ? `<div class="room-description">${escapeHtml(room.description)}</div>` : ''}
                <div class="room-creator">
                    <div class="room-creator-avatar">${(room.creator || '?')[0].toUpperCase()}</div>
                    <span>${room.visibility === 'public' ? 'üåê Public' : 'üîí Priv√©'}</span>
                </div>
                <button class="join-room-btn">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path>
                        <polyline points="15 3 21 3 21 9"></polyline>
                        <line x1="10" y1="14" x2="21" y2="3"></line>
                    </svg>
                    Rejoindre
                </button>
            </div>
        `).join('');
    }

    function loadPublicRooms() {
        // In a real app, this would load from a server
        // For now, use localStorage
        renderPublicRooms();
    }

    function renderPublicRooms() {
        if (state.publicRooms.length === 0) {
            elements.publicRoomsList.innerHTML = `
                <div class="no-rooms">
                    <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" style="opacity:0.3;">
                        <circle cx="12" cy="12" r="10"></circle>
                        <path d="M12 8v8"></path>
                    </svg>
                    <p>Aucun salon public disponible</p>
                    <p style="font-size:0.85rem;margin-top:10px;">Soyez le premier √† cr√©er un salon public !</p>
                </div>
            `;
            return;
        }

        elements.publicRoomsList.innerHTML = state.publicRooms.map(room => `
            <div class="room-card" onclick="joinRoom('${room.id}')">
                <div class="room-card-header">
                    <span class="room-name">${escapeHtml(room.name)}</span>
                    <span class="room-participants-badge">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                            <circle cx="9" cy="7" r="4"></circle>
                        </svg>
                        ${room.participants}
                    </span>
                </div>
                ${room.description ? `<div class="room-description">${escapeHtml(room.description)}</div>` : ''}
                <div class="room-creator">
                    <div class="room-creator-avatar">${(room.creator || '?')[0].toUpperCase()}</div>
                    <span>Par ${escapeHtml(room.creator)}</span>
                </div>
                <button class="join-room-btn">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path>
                        <polyline points="15 3 21 3 21 9"></polyline>
                        <line x1="10" y1="14" x2="21" y2="3"></line>
                    </svg>
                    Rejoindre
                </button>
            </div>
        `).join('');
    }

    function showRoomIdJoin() {
        elements.theStreet.classList.remove('active');
        elements.appContainer.classList.add('active');
        elements.peerIdInput.placeholder = `ID du salon (RM-XXXXXX)`;
        elements.peerIdInput.focus();
        showToast('Entrez l\'ID du salon pour rejoindre', 'info');
    }

    function findRoom(roomId) {
        // Search in public rooms
        let room = state.publicRooms.find(r => r.id === roomId);
        if (!room) {
            room = state.myRooms.find(r => r.id === roomId);
        }
        return room;
    }

    function saveMyRooms() {
        localStorage.setItem('myRooms', JSON.stringify(state.myRooms));
    }

    function savePublicRooms() {
        localStorage.setItem('publicRooms', JSON.stringify(state.publicRooms));
    }

    function deleteRoom(roomId, isPublic) {
        if (isPublic) {
            state.publicRooms = state.publicRooms.filter(r => r.id !== roomId);
            savePublicRooms();
        } else {
            state.myRooms = state.myRooms.filter(r => r.id !== roomId);
            saveMyRooms();
        }
        showToast('Salon supprim√©', 'success');
    }

    // ============================================
    // MESSAGING
    // ============================================
    // MESSAGING
    // ============================================
    async function sendMessage() {
        const content = elements.messageInput.value.trim();
        if (!content || state.connections.size === 0) return;

        const timestamp = new Date().toISOString();
        const messageData = {
            type: 'message',
            content,
            sender: state.myName,
            timestamp
        };

        // Encrypt and send to all peers
        for (const [peerId, { conn, sharedKey }] of state.connections) {
            try {
                const encrypted = await Crypto.encrypt(sharedKey, messageData);
                conn.send({ type: 'encrypted', payload: encrypted });
            } catch (error) {
                console.error('Encryption error:', error);
            }
        }

        // Display locally
        appendMessage(content, 'sent', state.myName, timestamp, true);

        // Clear input
        elements.messageInput.value = '';
        elements.messageInput.style.height = 'auto';

        // Stop typing indicator
        sendTypingStatus(false);
    }

    async function handleEncryptedMessage(peerId, data) {
        const peerInfo = state.connections.get(peerId);
        if (!peerInfo) return;

        try {
            const decrypted = await Crypto.decrypt(peerInfo.sharedKey, data.payload);

            if (decrypted.type === 'message') {
                appendMessage(decrypted.content, 'received', decrypted.sender, decrypted.timestamp, true);
                playNotificationSound();
            }
        } catch (error) {
            console.error('Decryption error:', error);
        }
    }

    function appendMessage(content, type, sender, timestamp, encrypted = false) {
        const messageDiv = document.createElement('div');
        messageDiv.className = `message ${type}`;

        const time = timestamp ? formatTime(new Date(timestamp)) : formatTime(new Date());

        if (type === 'system') {
            messageDiv.textContent = content;
        } else {
            messageDiv.innerHTML = `
                <div class="message-header">
                    <span class="message-sender">${escapeHtml(sender)}</span>
                    <span class="message-time">${time}</span>
                </div>
                <div class="message-content">${escapeHtml(content)}</div>
                ${encrypted ? '<div class="message-encryption"><svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 10 0v4"></path></svg> Chiffr√© E2E</div>' : ''}
            `;
        }

        elements.messagesContainer.appendChild(messageDiv);
        scrollToBottom();
    }

    function appendSystemMessage(content) {
        appendMessage(content, 'system');
    }

    // ============================================
    // THE STREET - ROOM MANAGEMENT
    // ============================================
    function showTheStreet() {
        elements.theStreet.classList.add('active');
        elements.appContainer.classList.remove('active');
        elements.myRoomsSection.style.display = 'none';

        // Reset room state
        if (state.currentRoom) {
            leaveRoom();
        }

        // Load public rooms
        loadPublicRooms();
    }

    function showApp() {
        elements.theStreet.classList.remove('active');
        elements.appContainer.classList.add('active');
        elements.myRoomsSection.style.display = 'none';
    }

    function openCreateRoomModal() {
        elements.roomNameInput.value = '';
        elements.roomDescriptionInput.value = '';
        selectRoomVisibility('private');
        elements.createRoomModal.classList.add('show');
        elements.roomNameInput.focus();
    }

    function closeCreateRoomModal() {
        elements.createRoomModal.classList.remove('show');
    }

    function selectRoomVisibility(visibility) {
        state.creatingRoomVisibility = visibility;
        
        elements.visibilityPrivate.classList.remove('active');
        elements.visibilityPublic.classList.remove('active');
        
        if (visibility === 'private') {
            elements.visibilityPrivate.classList.add('active');
        } else {
            elements.visibilityPublic.classList.add('active');
        }
    }

    function createRoom() {
        const roomName = elements.roomNameInput.value.trim();
        const roomDescription = elements.roomDescriptionInput.value.trim();
        const visibility = state.creatingRoomVisibility;

        if (!roomName) {
            showToast('Veuillez entrer un nom de salon', 'error');
            return;
        }

        // Generate room ID
        const roomId = 'RM-' + generateId(6);
        
        const newRoom = {
            id: roomId,
            name: roomName,
            description: roomDescription,
            visibility: visibility,
            creator: state.myName,
            creatorId: state.myPeerId,
            participants: 0,
            createdAt: new Date().toISOString()
        };

        // Add to my rooms
        state.myRooms.push(newRoom);
        saveMyRooms();

        // If public, add to public rooms list
        if (visibility === 'public') {
            state.publicRooms.push(newRoom);
            savePublicRooms();
            showToast('Salon public cr√©√© avec succ√®s !', 'success');
        } else {
            showToast('Salon priv√© cr√©√© !', 'success');
        }

        closeCreateRoomModal();
        showMyRooms();
    }

    function joinRoom(roomId) {
        const room = findRoom(roomId);
        
        if (!room) {
            showToast('Salon introuvable', 'error');
            return;
        }

        state.currentRoom = room;
        state.isRoomCreator = (room.creatorId === state.myPeerId);

        // Initialize PeerJS if not already initialized
        if (!state.peer) {
            initializePeer();
        }

        showApp();
        
        // Update UI
        elements.roomName.textContent = room.name;
        elements.currentRoomId.textContent = `Salon: ${room.id} (${room.visibility === 'public' ? 'Public' : 'Priv√©'})`;
        elements.peerIdInput.placeholder = `ID du pair (PT-XXXXXXXX)`;
        
        // Connect to room creator
        if (room.creatorId && room.creatorId !== state.myPeerId) {
            connectToPeer(room.creatorId);
        }
    }

    function leaveRoom() {
        // Disconnect from all peers
        state.connections.forEach(({ conn }) => {
            if (conn && conn.open) {
                conn.close();
            }
        });
        state.connections.clear();
        state.pendingConnections.clear();
        state.currentRoom = null;
        state.isRoomCreator = false;

        elements.roomName.textContent = 'Chat P2P';
        elements.currentRoomId.textContent = 'Chiffrement E2E activ√©';
    }

    function showMyRooms() {
        elements.theStreet.classList.remove('active');
        elements.appContainer.classList.remove('active');
        elements.myRoomsSection.style.display = 'block';
        renderMyRooms();
    }

    function renderMyRooms() {
        if (state.myRooms.length === 0) {
            elements.myRoomsList.innerHTML = `
                <div class="no-rooms">
                    <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" style="opacity:0.3;">
                        <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V9a2 2 0 0 1 2-2h6"></path>
                        <polyline points="9 22 9 12 15 12 3"></polyline>
                    </svg>
                    <p>Vous n'avez pas encore cr√©√© de salon</p>
                    <p style="font-size:0.85rem;margin-top:10px;">Cr√©ez votre premier salon pour commencer !</p>
                </div>
            `;
            return;
        }

        elements.myRoomsList.innerHTML = state.myRooms.map(room => `
            <div class="room-card" onclick="joinRoom('${room.id}')">
                <div class="room-card-header">
                    <span class="room-name">${escapeHtml(room.name)}</span>
                    <span class="room-participants-badge">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                            <circle cx="9" cy="7" r="4"></circle>
                        </svg>
                        ${room.participants}
                    </span>
                </div>
                ${room.description ? `<div class="room-description">${escapeHtml(room.description)}</div>` : ''}
                <div class="room-creator">
                    <div class="room-creator-avatar">${(room.creator || '?')[0].toUpperCase()}</div>
                    <span>${room.visibility === 'public' ? 'üåê Public' : 'üîí Priv√©'}</span>
                </div>
                <button class="join-room-btn">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path>
                        <polyline points="15 3 21 3 21 9"></polyline>
                        <line x1="10" y1="14" x2="21" y2="3"></line>
                    </svg>
                    Rejoindre
                </button>
            </div>
        `).join('');
    }

    function loadPublicRooms() {
        // In a real app, this would load from a server
        // For now, use localStorage
        renderPublicRooms();
    }

    function renderPublicRooms() {
        if (state.publicRooms.length === 0) {
            elements.publicRoomsList.innerHTML = `
                <div class="no-rooms">
                    <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" style="opacity:0.3;">
                        <circle cx="12" cy="12" r="10"></circle>
                        <path d="M12 8v8"></path>
                    </svg>
                    <p>Aucun salon public disponible</p>
                    <p style="font-size:0.85rem;margin-top:10px;">Soyez le premier √† cr√©er un salon public !</p>
                </div>
            `;
            return;
        }

        elements.publicRoomsList.innerHTML = state.publicRooms.map(room => `
            <div class="room-card" onclick="joinRoom('${room.id}')">
                <div class="room-card-header">
                    <span class="room-name">${escapeHtml(room.name)}</span>
                    <span class="room-participants-badge">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                            <circle cx="9" cy="7" r="4"></circle>
                        </svg>
                        ${room.participants}
                    </span>
                </div>
                ${room.description ? `<div class="room-description">${escapeHtml(room.description)}</div>` : ''}
                <div class="room-creator">
                    <div class="room-creator-avatar">${(room.creator || '?')[0].toUpperCase()}</div>
                    <span>Par ${escapeHtml(room.creator)}</span>
                </div>
                <button class="join-room-btn">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path>
                        <polyline points="15 3 21 3 21 9"></polyline>
                        <line x1="10" y1="14" x2="21" y2="3"></line>
                    </svg>
                    Rejoindre
                </button>
            </div>
        `).join('');
    }

    function showRoomIdJoin() {
        elements.theStreet.classList.remove('active');
        elements.appContainer.classList.add('active');
        elements.peerIdInput.placeholder = `ID du salon (RM-XXXXXX)`;
        elements.peerIdInput.focus();
        showToast('Entrez l\'ID du salon pour rejoindre', 'info');
    }

    function findRoom(roomId) {
        // Search in public rooms
        let room = state.publicRooms.find(r => r.id === roomId);
        if (!room) {
            room = state.myRooms.find(r => r.id === roomId);
        }
        return room;
    }

    function saveMyRooms() {
        localStorage.setItem('myRooms', JSON.stringify(state.myRooms));
    }

    function savePublicRooms() {
        localStorage.setItem('publicRooms', JSON.stringify(state.publicRooms));
    }

    function deleteRoom(roomId, isPublic) {
        if (isPublic) {
            state.publicRooms = state.publicRooms.filter(r => r.id !== roomId);
            savePublicRooms();
        } else {
            state.myRooms = state.myRooms.filter(r => r.id !== roomId);
            saveMyRooms();
        }
        showToast('Salon supprim√©', 'success');
    }

    // ============================================
    // MESSAGING
    // ============================================
    // FILE TRANSFER
    // ============================================
    async function handleFileSelect(e) {
        const files = e.target.files;
        if (!files.length || state.connections.size === 0) return;

        for (const file of files) {
            if (file.size > CONFIG.maxFileSize) {
                showToast(`${file.name} est trop volumineux (max 100MB)`, 'error');
                continue;
            }
            await sendFile(file);
        }

        elements.fileInput.value = '';
    }

    async function sendFile(file) {
        const transferId = generateId(12);
        const arrayBuffer = await file.arrayBuffer();

        // Create message element with progress
        const messageId = 'file-' + transferId;
        appendFileMessage(messageId, file.name, file.size, file.type, 'sent', 0);

        // Send file to all peers
        for (const [peerId, { conn, sharedKey }] of state.connections) {
            try {
                // Encrypt the file
                const { iv, encrypted } = await Crypto.encryptFile(sharedKey, arrayBuffer);

                // Send file metadata
                conn.send({
                    type: 'file-start',
                    transferId,
                    fileName: file.name,
                    fileSize: encrypted.length,
                    fileType: file.type,
                    iv: Array.from(iv),
                    sender: state.myName,
                    timestamp: new Date().toISOString()
                });

                // Send chunks - use smaller chunk size for binary data
                const chunkSize = 4096; // 4KB chunks for binary data (smaller than JSON limit)
                const totalChunks = Math.ceil(encrypted.length / chunkSize);
                
                // Send chunks with delay to avoid connection overload
                for (let i = 0; i < totalChunks; i++) {
                    const start = i * chunkSize;
                    const end = Math.min(start + chunkSize, encrypted.length);
                    const chunk = encrypted.slice(start, end);

                    // Convert to base64 to avoid array size issues
                    const chunkBase64 = btoa(String.fromCharCode(...chunk));

                    conn.send({
                        type: 'file-chunk',
                        transferId,
                        chunkIndex: i,
                        totalChunks,
                        data: chunkBase64
                    });

                    // Update progress
                    const progress = ((i + 1) / totalChunks) * 100;
                    updateFileProgress(messageId, progress);

                    // Add small delay between chunks to avoid connection overload
                    await new Promise(resolve => setTimeout(resolve, 10));
                }

                // Add delay before sending completion
                await new Promise(resolve => setTimeout(resolve, 100));

                // Send completion
                conn.send({
                    type: 'file-end',
                    transferId
                });

            } catch (error) {
                console.error('File send error:', error);
                showToast(`Erreur d'envoi de ${file.name}`, 'error');
            }
        }

        updateFileProgress(messageId, 100, true);
    }

    function handleFileStart(peerId, data) {
        // Calculate expected chunks based on 4KB chunk size
        const chunkSize = 4096;
        state.fileTransfers.set(data.transferId, {
            chunks: new Array(Math.ceil(data.fileSize / chunkSize)),
            metadata: data,
            receivedChunks: 0,
            peerId
        });

        const messageId = 'file-' + data.transferId;
        appendFileMessage(messageId, data.fileName, data.fileSize, data.fileType, 'received', 0, data.sender, data.timestamp);
    }

    function handleFileChunk(peerId, data) {
        const transfer = state.fileTransfers.get(data.transferId);
        if (!transfer) return;

        // Decode base64 chunk to Uint8Array
        const binaryString = atob(data.data);
        const chunk = new Uint8Array(binaryString.length);
        for (let i = 0; i < binaryString.length; i++) {
            chunk[i] = binaryString.charCodeAt(i);
        }

        transfer.chunks[data.chunkIndex] = chunk;
        transfer.receivedChunks++;

        const progress = (transfer.receivedChunks / data.totalChunks) * 100;
        updateFileProgress('file-' + data.transferId, progress);
    }

    async function handleFileEnd(peerId, data) {
        const transfer = state.fileTransfers.get(data.transferId);
        if (!transfer) return;

        try {
            // Combine chunks - filter out null/undefined chunks
            const validChunks = transfer.chunks.filter(chunk => chunk !== null && chunk !== undefined);
            const totalLength = validChunks.reduce((sum, chunk) => sum + chunk.length, 0);
            const combined = new Uint8Array(totalLength);
            let offset = 0;
            for (const chunk of validChunks) {
                combined.set(chunk, offset);
                offset += chunk.length;
            }

            // Decrypt file
            const peerInfo = state.connections.get(peerId);
            if (!peerInfo) return;

            const iv = new Uint8Array(transfer.metadata.iv);
            const decrypted = await Crypto.decryptFile(peerInfo.sharedKey, iv, combined);

            // Create blob and download link
            const blob = new Blob([decrypted], { type: transfer.metadata.fileType });
            const url = URL.createObjectURL(blob);

            updateFileDownload('file-' + data.transferId, url, transfer.metadata.fileName, transfer.metadata.fileType, blob);

            playNotificationSound();

        } catch (error) {
            console.error('File receive error:', error);
            showToast('Erreur de r√©ception du fichier', 'error');
        }

        state.fileTransfers.delete(data.transferId);
    }

    function appendFileMessage(messageId, fileName, fileSize, fileType, type, progress, sender = state.myName, timestamp = null) {
        const messageDiv = document.createElement('div');
        messageDiv.className = `message ${type}`;
        messageDiv.id = messageId;

        const time = timestamp ? formatTime(new Date(timestamp)) : formatTime(new Date());
        const isImage = fileType.startsWith('image/');

        messageDiv.innerHTML = `
            <div class="message-header">
                <span class="message-sender">${escapeHtml(sender)}</span>
                <span class="message-time">${time}</span>
            </div>
            <div class="file-message">
                <div class="file-info">
                    <div class="file-icon">
                        ${isImage ?
                            '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><circle cx="8.5" cy="8.5" r="1.5"></circle><polyline points="21 15 16 10 5 21"></polyline></svg>' :
                            '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline></svg>'
                        }
                    </div>
                    <div class="file-details">
                        <div class="file-name">${escapeHtml(fileName)}</div>
                        <div class="file-size">${formatFileSize(fileSize)}</div>
                    </div>
                </div>
                <div class="file-progress">
                    <div class="file-progress-bar" style="width: ${progress}%"></div>
                </div>
                <div class="file-actions"></div>
            </div>
            <div class="message-encryption"><svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 10 0v4"></path></svg> Fichier chiffr√© E2E</div>
        `;

        elements.messagesContainer.appendChild(messageDiv);
        scrollToBottom();
    }

    function updateFileProgress(messageId, progress, complete = false) {
        const el = document.getElementById(messageId);
        if (!el) return;

        const progressBar = el.querySelector('.file-progress-bar');
        if (progressBar) {
            progressBar.style.width = progress + '%';
        }

        if (complete) {
            const progressEl = el.querySelector('.file-progress');
            if (progressEl) progressEl.style.display = 'none';
        }
    }

    function updateFileDownload(messageId, url, fileName, fileType, blob) {
        const el = document.getElementById(messageId);
        if (!el) return;

        const actionsEl = el.querySelector('.file-actions');
        const progressEl = el.querySelector('.file-progress');

        if (progressEl) progressEl.style.display = 'none';

        // Show image preview if applicable
        if (fileType.startsWith('image/')) {
            const preview = document.createElement('img');
            preview.src = url;
            preview.className = 'image-preview';
            preview.onclick = () => {
                elements.modalImage.src = url;
                elements.imageModal.classList.add('show');
            };
            actionsEl.before(preview);
        }

        actionsEl.innerHTML = `
            <button class="file-download" onclick="downloadFile('${url}', '${escapeHtml(fileName)}')">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                    <polyline points="7 10 12 15 17 10"></polyline>
                    <line x1="12" y1="15" x2="12" y2="3"></line>
                </svg>
                T√©l√©charger
            </button>
        `;
    }

    function downloadFile(url, fileName) {
        const a = document.createElement('a');
        a.href = url;
        a.download = fileName;
        a.click();
    }
    window.downloadFile = downloadFile;

    // ============================================
    // TYPING INDICATOR
    // ============================================
    function handleTyping() {
        // Auto-resize
        elements.messageInput.style.height = 'auto';
        elements.messageInput.style.height = Math.min(elements.messageInput.scrollHeight, 120) + 'px';

        if (!state.isTyping) {
            state.isTyping = true;
            sendTypingStatus(true);
        }

        clearTimeout(state.typingTimer);
        state.typingTimer = setTimeout(() => {
            state.isTyping = false;
            sendTypingStatus(false);
        }, CONFIG.typingTimeout);
    }

    function sendTypingStatus(isTyping) {
        state.connections.forEach(({ conn }) => {
            conn.send({
                type: 'typing',
                isTyping,
                name: state.myName
            });
        });
    }

    function handleTypingIndicator(peerId, data) {
        if (data.isTyping) {
            state.typingPeers.add(data.name || 'Quelqu\'un');
        } else {
            state.typingPeers.delete(data.name || 'Quelqu\'un');
        }
        updateTypingIndicator();
    }

    function updateTypingIndicator() {
        if (state.typingPeers.size > 0) {
            const names = Array.from(state.typingPeers);
            let text;
            if (names.length === 1) {
                text = `${names[0]} √©crit...`;
            } else if (names.length === 2) {
                text = `${names[0]} et ${names[1]} √©crivent...`;
            } else {
                text = `${names.length} personnes √©crivent...`;
            }
            elements.typingNames.textContent = text;
            elements.typingIndicator.classList.add('active');
        } else {
            elements.typingIndicator.classList.remove('active');
        }
    }

    // ============================================
    // THE STREET - ROOM MANAGEMENT
    // ============================================
    function showTheStreet() {
        elements.theStreet.classList.add('active');
        elements.appContainer.classList.remove('active');
        elements.myRoomsSection.style.display = 'none';

        // Reset room state
        if (state.currentRoom) {
            leaveRoom();
        }

        // Load public rooms
        loadPublicRooms();
    }

    function showApp() {
        elements.theStreet.classList.remove('active');
        elements.appContainer.classList.add('active');
        elements.myRoomsSection.style.display = 'none';
    }

    function openCreateRoomModal() {
        elements.roomNameInput.value = '';
        elements.roomDescriptionInput.value = '';
        selectRoomVisibility('private');
        elements.createRoomModal.classList.add('show');
        elements.roomNameInput.focus();
    }

    function closeCreateRoomModal() {
        elements.createRoomModal.classList.remove('show');
    }

    function selectRoomVisibility(visibility) {
        state.creatingRoomVisibility = visibility;
        
        elements.visibilityPrivate.classList.remove('active');
        elements.visibilityPublic.classList.remove('active');
        
        if (visibility === 'private') {
            elements.visibilityPrivate.classList.add('active');
        } else {
            elements.visibilityPublic.classList.add('active');
        }
    }

    function createRoom() {
        const roomName = elements.roomNameInput.value.trim();
        const roomDescription = elements.roomDescriptionInput.value.trim();
        const visibility = state.creatingRoomVisibility;

        if (!roomName) {
            showToast('Veuillez entrer un nom de salon', 'error');
            return;
        }

        // Generate room ID
        const roomId = 'RM-' + generateId(6);
        
        const newRoom = {
            id: roomId,
            name: roomName,
            description: roomDescription,
            visibility: visibility,
            creator: state.myName,
            creatorId: state.myPeerId,
            participants: 0,
            createdAt: new Date().toISOString()
        };

        // Add to my rooms
        state.myRooms.push(newRoom);
        saveMyRooms();

        // If public, add to public rooms list
        if (visibility === 'public') {
            state.publicRooms.push(newRoom);
            savePublicRooms();
            showToast('Salon public cr√©√© avec succ√®s !', 'success');
        } else {
            showToast('Salon priv√© cr√©√© !', 'success');
        }

        closeCreateRoomModal();
        showMyRooms();
    }

    function joinRoom(roomId) {
        const room = findRoom(roomId);
        
        if (!room) {
            showToast('Salon introuvable', 'error');
            return;
        }

        state.currentRoom = room;
        state.isRoomCreator = (room.creatorId === state.myPeerId);

        // Initialize PeerJS if not already initialized
        if (!state.peer) {
            initializePeer();
        }

        showApp();
        
        // Update UI
        elements.roomName.textContent = room.name;
        elements.currentRoomId.textContent = `Salon: ${room.id} (${room.visibility === 'public' ? 'Public' : 'Priv√©'})`;
        elements.peerIdInput.placeholder = `ID du pair (PT-XXXXXXXX)`;
        
        // Connect to room creator
        if (room.creatorId && room.creatorId !== state.myPeerId) {
            connectToPeer(room.creatorId);
        }
    }

    function leaveRoom() {
        // Disconnect from all peers
        state.connections.forEach(({ conn }) => {
            if (conn && conn.open) {
                conn.close();
            }
        });
        state.connections.clear();
        state.pendingConnections.clear();
        state.currentRoom = null;
        state.isRoomCreator = false;

        elements.roomName.textContent = 'Chat P2P';
        elements.currentRoomId.textContent = 'Chiffrement E2E activ√©';
    }

    function showMyRooms() {
        elements.theStreet.classList.remove('active');
        elements.appContainer.classList.remove('active');
        elements.myRoomsSection.style.display = 'block';
        renderMyRooms();
    }

    function renderMyRooms() {
        if (state.myRooms.length === 0) {
            elements.myRoomsList.innerHTML = `
                <div class="no-rooms">
                    <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" style="opacity:0.3;">
                        <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V9a2 2 0 0 1 2-2h6"></path>
                        <polyline points="9 22 9 12 15 12 3"></polyline>
                    </svg>
                    <p>Vous n'avez pas encore cr√©√© de salon</p>
                    <p style="font-size:0.85rem;margin-top:10px;">Cr√©ez votre premier salon pour commencer !</p>
                </div>
            `;
            return;
        }

        elements.myRoomsList.innerHTML = state.myRooms.map(room => `
            <div class="room-card" onclick="joinRoom('${room.id}')">
                <div class="room-card-header">
                    <span class="room-name">${escapeHtml(room.name)}</span>
                    <span class="room-participants-badge">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                            <circle cx="9" cy="7" r="4"></circle>
                        </svg>
                        ${room.participants}
                    </span>
                </div>
                ${room.description ? `<div class="room-description">${escapeHtml(room.description)}</div>` : ''}
                <div class="room-creator">
                    <div class="room-creator-avatar">${(room.creator || '?')[0].toUpperCase()}</div>
                    <span>${room.visibility === 'public' ? 'üåê Public' : 'üîí Priv√©'}</span>
                </div>
                <button class="join-room-btn">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path>
                        <polyline points="15 3 21 3 21 9"></polyline>
                        <line x1="10" y1="14" x2="21" y2="3"></line>
                    </svg>
                    Rejoindre
                </button>
            </div>
        `).join('');
    }

    function loadPublicRooms() {
        // In a real app, this would load from a server
        // For now, use localStorage
        renderPublicRooms();
    }

    function renderPublicRooms() {
        if (state.publicRooms.length === 0) {
            elements.publicRoomsList.innerHTML = `
                <div class="no-rooms">
                    <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" style="opacity:0.3;">
                        <circle cx="12" cy="12" r="10"></circle>
                        <path d="M12 8v8"></path>
                    </svg>
                    <p>Aucun salon public disponible</p>
                    <p style="font-size:0.85rem;margin-top:10px;">Soyez le premier √† cr√©er un salon public !</p>
                </div>
            `;
            return;
        }

        elements.publicRoomsList.innerHTML = state.publicRooms.map(room => `
            <div class="room-card" onclick="joinRoom('${room.id}')">
                <div class="room-card-header">
                    <span class="room-name">${escapeHtml(room.name)}</span>
                    <span class="room-participants-badge">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                            <circle cx="9" cy="7" r="4"></circle>
                        </svg>
                        ${room.participants}
                    </span>
                </div>
                ${room.description ? `<div class="room-description">${escapeHtml(room.description)}</div>` : ''}
                <div class="room-creator">
                    <div class="room-creator-avatar">${(room.creator || '?')[0].toUpperCase()}</div>
                    <span>Par ${escapeHtml(room.creator)}</span>
                </div>
                <button class="join-room-btn">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path>
                        <polyline points="15 3 21 3 21 9"></polyline>
                        <line x1="10" y1="14" x2="21" y2="3"></line>
                    </svg>
                    Rejoindre
                </button>
            </div>
        `).join('');
    }

    function showRoomIdJoin() {
        elements.theStreet.classList.remove('active');
        elements.appContainer.classList.add('active');
        elements.peerIdInput.placeholder = `ID du salon (RM-XXXXXX)`;
        elements.peerIdInput.focus();
        showToast('Entrez l\'ID du salon pour rejoindre', 'info');
    }

    function findRoom(roomId) {
        // Search in public rooms
        let room = state.publicRooms.find(r => r.id === roomId);
        if (!room) {
            room = state.myRooms.find(r => r.id === roomId);
        }
        return room;
    }

    function saveMyRooms() {
        localStorage.setItem('myRooms', JSON.stringify(state.myRooms));
    }

    function savePublicRooms() {
        localStorage.setItem('publicRooms', JSON.stringify(state.publicRooms));
    }

    function deleteRoom(roomId, isPublic) {
        if (isPublic) {
            state.publicRooms = state.publicRooms.filter(r => r.id !== roomId);
            savePublicRooms();
        } else {
            state.myRooms = state.myRooms.filter(r => r.id !== roomId);
            saveMyRooms();
        }
        showToast('Salon supprim√©', 'success');
    }

    // ============================================
    // MESSAGING
    // ============================================
    // UI UPDATES
    // ============================================
    function updatePeersList() {
        const allPeers = [
            ...Array.from(state.connections.entries()).map(([id, info]) => ({ id, ...info, connected: true })),
            ...Array.from(state.pendingConnections.entries()).map(([id, info]) => ({ id, ...info, connected: false }))
        ];

        if (allPeers.length === 0) {
            elements.peersList.innerHTML = `
                <div style="color:#64748b;font-size:0.85rem;text-align:center;padding:20px;">
                    Aucun participant connect√©
                </div>
            `;
        } else {
            elements.peersList.innerHTML = allPeers.map(peer => `
                <div class="peer-item ${peer.connected ? 'connected' : ''}">
                    <div class="peer-avatar">${(peer.name || '?')[0].toUpperCase()}</div>
                    <div class="peer-details">
                        <div class="peer-name">${escapeHtml(peer.name || 'Connexion...')}</div>
                        <div class="peer-status ${peer.connected ? 'online' : ''}">
                            <span class="status-dot"></span>
                            ${peer.connected ? 'Connect√©' : 'Connexion...'}
                        </div>
                    </div>
                    ${peer.connected ? '<span class="encryption-badge">E2E</span>' : ''}
                </div>
            `).join('');
        }

        const count = state.connections.size;
        elements.participantsCount.textContent = count;
        elements.headerParticipants.textContent = count;
    }

    function enableChat() {
        elements.messageInput.disabled = false;
        elements.messageInput.placeholder = 'Tapez votre message...';
        elements.sendBtn.disabled = false;
    }

    function updateStatusBar(status, message) {
        elements.statusBar.className = 'status-bar ' + status;
        elements.statusBar.innerHTML = status === 'connecting'
            ? `<div class="spinner"></div><span>${message}</span>`
            : `<span>${message}</span>`;
    }

    function toggleMobileSidebar() {
        const sidebar = elements.sidebar;
        const overlay = elements.sidebarOverlay;
        const isShown = sidebar.classList.contains('mobile-show');

        if (isShown) {
            // Hide sidebar
            sidebar.classList.remove('mobile-show');
            overlay.classList.remove('show');
        } else {
            // Show sidebar
            sidebar.classList.add('mobile-show');
            overlay.classList.add('show');
        }
    }

    // ============================================
    // THE STREET - ROOM MANAGEMENT
    // ============================================
    function showTheStreet() {
        elements.theStreet.classList.add('active');
        elements.appContainer.classList.remove('active');
        elements.myRoomsSection.style.display = 'none';

        // Reset room state
        if (state.currentRoom) {
            leaveRoom();
        }

        // Load public rooms
        loadPublicRooms();
    }

    function showApp() {
        elements.theStreet.classList.remove('active');
        elements.appContainer.classList.add('active');
        elements.myRoomsSection.style.display = 'none';
    }

    function openCreateRoomModal() {
        elements.roomNameInput.value = '';
        elements.roomDescriptionInput.value = '';
        selectRoomVisibility('private');
        elements.createRoomModal.classList.add('show');
        elements.roomNameInput.focus();
    }

    function closeCreateRoomModal() {
        elements.createRoomModal.classList.remove('show');
    }

    function selectRoomVisibility(visibility) {
        state.creatingRoomVisibility = visibility;
        
        elements.visibilityPrivate.classList.remove('active');
        elements.visibilityPublic.classList.remove('active');
        
        if (visibility === 'private') {
            elements.visibilityPrivate.classList.add('active');
        } else {
            elements.visibilityPublic.classList.add('active');
        }
    }

    function createRoom() {
        const roomName = elements.roomNameInput.value.trim();
        const roomDescription = elements.roomDescriptionInput.value.trim();
        const visibility = state.creatingRoomVisibility;

        if (!roomName) {
            showToast('Veuillez entrer un nom de salon', 'error');
            return;
        }

        // Generate room ID
        const roomId = 'RM-' + generateId(6);
        
        const newRoom = {
            id: roomId,
            name: roomName,
            description: roomDescription,
            visibility: visibility,
            creator: state.myName,
            creatorId: state.myPeerId,
            participants: 0,
            createdAt: new Date().toISOString()
        };

        // Add to my rooms
        state.myRooms.push(newRoom);
        saveMyRooms();

        // If public, add to public rooms list
        if (visibility === 'public') {
            state.publicRooms.push(newRoom);
            savePublicRooms();
            showToast('Salon public cr√©√© avec succ√®s !', 'success');
        } else {
            showToast('Salon priv√© cr√©√© !', 'success');
        }

        closeCreateRoomModal();
        showMyRooms();
    }

    function joinRoom(roomId) {
        const room = findRoom(roomId);
        
        if (!room) {
            showToast('Salon introuvable', 'error');
            return;
        }

        state.currentRoom = room;
        state.isRoomCreator = (room.creatorId === state.myPeerId);

        // Initialize PeerJS if not already initialized
        if (!state.peer) {
            initializePeer();
        }

        showApp();
        
        // Update UI
        elements.roomName.textContent = room.name;
        elements.currentRoomId.textContent = `Salon: ${room.id} (${room.visibility === 'public' ? 'Public' : 'Priv√©'})`;
        elements.peerIdInput.placeholder = `ID du pair (PT-XXXXXXXX)`;
        
        // Connect to room creator
        if (room.creatorId && room.creatorId !== state.myPeerId) {
            connectToPeer(room.creatorId);
        }
    }

    function leaveRoom() {
        // Disconnect from all peers
        state.connections.forEach(({ conn }) => {
            if (conn && conn.open) {
                conn.close();
            }
        });
        state.connections.clear();
        state.pendingConnections.clear();
        state.currentRoom = null;
        state.isRoomCreator = false;

        elements.roomName.textContent = 'Chat P2P';
        elements.currentRoomId.textContent = 'Chiffrement E2E activ√©';
    }

    function showMyRooms() {
        elements.theStreet.classList.remove('active');
        elements.appContainer.classList.remove('active');
        elements.myRoomsSection.style.display = 'block';
        renderMyRooms();
    }

    function renderMyRooms() {
        if (state.myRooms.length === 0) {
            elements.myRoomsList.innerHTML = `
                <div class="no-rooms">
                    <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" style="opacity:0.3;">
                        <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V9a2 2 0 0 1 2-2h6"></path>
                        <polyline points="9 22 9 12 15 12 3"></polyline>
                    </svg>
                    <p>Vous n'avez pas encore cr√©√© de salon</p>
                    <p style="font-size:0.85rem;margin-top:10px;">Cr√©ez votre premier salon pour commencer !</p>
                </div>
            `;
            return;
        }

        elements.myRoomsList.innerHTML = state.myRooms.map(room => `
            <div class="room-card" onclick="joinRoom('${room.id}')">
                <div class="room-card-header">
                    <span class="room-name">${escapeHtml(room.name)}</span>
                    <span class="room-participants-badge">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                            <circle cx="9" cy="7" r="4"></circle>
                        </svg>
                        ${room.participants}
                    </span>
                </div>
                ${room.description ? `<div class="room-description">${escapeHtml(room.description)}</div>` : ''}
                <div class="room-creator">
                    <div class="room-creator-avatar">${(room.creator || '?')[0].toUpperCase()}</div>
                    <span>${room.visibility === 'public' ? 'üåê Public' : 'üîí Priv√©'}</span>
                </div>
                <button class="join-room-btn">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path>
                        <polyline points="15 3 21 3 21 9"></polyline>
                        <line x1="10" y1="14" x2="21" y2="3"></line>
                    </svg>
                    Rejoindre
                </button>
            </div>
        `).join('');
    }

    function loadPublicRooms() {
        // In a real app, this would load from a server
        // For now, use localStorage
        renderPublicRooms();
    }

    function renderPublicRooms() {
        if (state.publicRooms.length === 0) {
            elements.publicRoomsList.innerHTML = `
                <div class="no-rooms">
                    <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" style="opacity:0.3;">
                        <circle cx="12" cy="12" r="10"></circle>
                        <path d="M12 8v8"></path>
                    </svg>
                    <p>Aucun salon public disponible</p>
                    <p style="font-size:0.85rem;margin-top:10px;">Soyez le premier √† cr√©er un salon public !</p>
                </div>
            `;
            return;
        }

        elements.publicRoomsList.innerHTML = state.publicRooms.map(room => `
            <div class="room-card" onclick="joinRoom('${room.id}')">
                <div class="room-card-header">
                    <span class="room-name">${escapeHtml(room.name)}</span>
                    <span class="room-participants-badge">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                            <circle cx="9" cy="7" r="4"></circle>
                        </svg>
                        ${room.participants}
                    </span>
                </div>
                ${room.description ? `<div class="room-description">${escapeHtml(room.description)}</div>` : ''}
                <div class="room-creator">
                    <div class="room-creator-avatar">${(room.creator || '?')[0].toUpperCase()}</div>
                    <span>Par ${escapeHtml(room.creator)}</span>
                </div>
                <button class="join-room-btn">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path>
                        <polyline points="15 3 21 3 21 9"></polyline>
                        <line x1="10" y1="14" x2="21" y2="3"></line>
                    </svg>
                    Rejoindre
                </button>
            </div>
        `).join('');
    }

    function showRoomIdJoin() {
        elements.theStreet.classList.remove('active');
        elements.appContainer.classList.add('active');
        elements.peerIdInput.placeholder = `ID du salon (RM-XXXXXX)`;
        elements.peerIdInput.focus();
        showToast('Entrez l\'ID du salon pour rejoindre', 'info');
    }

    function findRoom(roomId) {
        // Search in public rooms
        let room = state.publicRooms.find(r => r.id === roomId);
        if (!room) {
            room = state.myRooms.find(r => r.id === roomId);
        }
        return room;
    }

    function saveMyRooms() {
        localStorage.setItem('myRooms', JSON.stringify(state.myRooms));
    }

    function savePublicRooms() {
        localStorage.setItem('publicRooms', JSON.stringify(state.publicRooms));
    }

    function deleteRoom(roomId, isPublic) {
        if (isPublic) {
            state.publicRooms = state.publicRooms.filter(r => r.id !== roomId);
            savePublicRooms();
        } else {
            state.myRooms = state.myRooms.filter(r => r.id !== roomId);
            saveMyRooms();
        }
        showToast('Salon supprim√©', 'success');
    }

    // ============================================
    // MESSAGING
    // ============================================
    // UTILITY FUNCTIONS
    // ============================================
    function generateId(length) {
        const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
        let result = '';
        for (let i = 0; i < length; i++) {
            result += chars[Math.floor(Math.random() * chars.length)];
        }
        return result;
    }

    function formatTime(date) {
        return date.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' });
    }

    function formatFileSize(bytes) {
        if (bytes < 1024) return bytes + ' B';
        if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
        return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
    }

    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    function scrollToBottom() {
        elements.messagesContainer.scrollTop = elements.messagesContainer.scrollHeight;
    }

    function showToast(message, type = 'info') {
        elements.toast.textContent = message;
        elements.toast.className = `toast ${type} show`;
        setTimeout(() => elements.toast.classList.remove('show'), 3000);
    }

    function playNotificationSound() {
        try {
            const ctx = new (window.AudioContext || window.webkitAudioContext)();
            const osc = ctx.createOscillator();
            const gain = ctx.createGain();
            osc.connect(gain);
            gain.connect(ctx.destination);
            osc.frequency.value = 800;
            gain.gain.setValueAtTime(0.1, ctx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.15);
            osc.start();
            osc.stop(ctx.currentTime + 0.15);
        } catch (e) {}
    }

    // Event handlers
    function handleNameChange(e) {
        state.myName = e.target.value.trim() || 'Anonyme';
        localStorage.setItem('peerName', state.myName);

        // Update all connected peers
        state.connections.forEach(({ conn }) => {
            conn.send({
                type: 'handshake',
                name: state.myName,
                publicKey: null // Don't resend key
            });
        });
    }

    function copyPeerId() {
        if (!state.myPeerId) return;
        navigator.clipboard.writeText(state.myPeerId).then(() => {
            showToast('ID copi√© !', 'success');
        });
    }

    function handleMessageKeydown(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            sendMessage();
        }
    }

    function handlePeerError(err) {
        console.error('Peer error:', err);
        let message = 'Erreur de connexion';
        let isCritical = false;

        if (err.type === 'peer-unavailable') {
            message = 'Pair introuvable. V√©rifiez l\'ID et r√©essayez.';
            updateStatusBar('error', message);
            showToast(message, 'error');
        } else if (err.type === 'network' || err.type === 'server-error') {
            // Network errors are usually temporary and don't affect existing P2P connections
            message = 'Erreur r√©seau temporaire. Connexions P2P actives.';
            console.log('Temporary network error - P2P connections remain active');
            updateStatusBar('connecting', 'Reconnexion au serveur...');
            // Don't show error toast for temporary network issues, but show system message
            appendSystemMessage('‚ö†Ô∏è Erreur de connexion au serveur de signalisation. Les connexions P2P restent actives. Reconnexion en cours...');
        } else if (err.type === 'peer-error') {
            message = 'Erreur de connexion au pair. V√©rifiez votre configuration ICE.';
            isCritical = true;
            updateStatusBar('error', message);
            showToast(message, 'error');
        } else if (err.type === 'ssl-unavailable') {
            message = 'Erreur SSL. V√©rifiez que vous utilisez HTTPS.';
            isCritical = true;
            updateStatusBar('error', message);
            showToast(message, 'error');
        } else if (err.type === 'server-error') {
            message = 'Erreur du serveur de signalisation.';
            updateStatusBar('error', message);
            showToast(message, 'warning');
        } else {
            message = `Erreur: ${err.type || 'Connexion √©chou√©e'}`;
            isCritical = true;
            updateStatusBar('error', message);
            showToast(message, 'error');
        }

        // If critical error, show help message
        if (isCritical) {
            appendSystemMessage('üí° Astuce: Si vous avez des probl√®mes de connexion, essayez d\'ajouter des serveurs TURN suppl√©mentaires dans les param√®tres ‚öôÔ∏è');
        }
    }

    // Initialize
    document.addEventListener('DOMContentLoaded', init);

    // Cleanup
    window.addEventListener('beforeunload', () => {
        state.connections.forEach(({ conn }) => conn.close());
        if (state.peer) state.peer.destroy();
    });

    // Expose connect function for manual connection
    window.connectToPeer = connectToPeer;
    </script>
</body>
</html>
