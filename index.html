<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PeerText - Messagerie P2P Chiffrée</title>
    <!-- PeerJS via jsDelivr (meilleur support des source maps) -->
    <script src="https://cdn.jsdelivr.net/npm/peerjs@1.5.4/dist/peerjs.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background: linear-gradient(135deg, #1a1a2e, #16213e, #0f3460);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            padding: 20px;
            color: #fff;
        }

        .container {
            width: 100%;
            max-width: 1100px;
            background: rgba(15, 23, 42, 0.9);
            backdrop-filter: blur(12px);
            border-radius: 24px;
            overflow: hidden;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.75);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        header {
            background: rgba(11, 18, 39, 0.95);
            padding: 20px 25px;
            text-align: center;
            border-bottom: 1px solid rgba(99, 179, 237, 0.3);
            position: relative;
        }

        h1 {
            font-size: 2.2rem;
            background: linear-gradient(to right, #63b3ed, #81e6d9, #f093fb);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            display: inline-flex;
            align-items: center;
            gap: 12px;
        }

        .subtitle {
            color: #94a3b8;
            font-size: 1rem;
            margin-top: 8px;
        }

        .badges {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 12px;
            flex-wrap: wrap;
        }

        .badge {
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .badge.e2e {
            background: rgba(52, 211, 153, 0.2);
            color: #34d399;
            border: 1px solid rgba(52, 211, 153, 0.3);
        }

        .badge.p2p {
            background: rgba(99, 179, 237, 0.2);
            color: #63b3ed;
            border: 1px solid rgba(99, 179, 237, 0.3);
        }

        .badge.files {
            background: rgba(251, 191, 36, 0.2);
            color: #fbbf24;
            border: 1px solid rgba(251, 191, 36, 0.3);
        }

        .badge.rooms {
            background: rgba(167, 139, 250, 0.2);
            color: #a78bfa;
            border: 1px solid rgba(167, 139, 250, 0.3);
        }

        /* Mobile menu button */
        .mobile-menu-btn {
            position: absolute;
            top: 20px;
            left: 25px;
            width: 40px;
            height: 40px;
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            background: rgba(30, 41, 59, 0.8);
            color: #94a3b8;
            cursor: pointer;
            display: none;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .mobile-menu-btn:hover {
            background: rgba(51, 65, 85, 0.8);
            color: #e2e8f0;
        }

        .mobile-menu-btn:active {
            transform: scale(0.95);
        }

        /* Close button for mobile sidebar */
        .mobile-close-btn {
            position: absolute;
            top: 20px;
            right: 25px;
            width: 40px;
            height: 40px;
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            background: rgba(30, 41, 59, 0.8);
            color: #94a3b8;
            cursor: pointer;
            display: none;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            z-index: 101;
        }

        .mobile-close-btn:hover {
            background: rgba(51, 65, 85, 0.8);
            color: #e2e8f0;
        }

        /* Overlay for mobile sidebar */
        .sidebar-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 99;
            display: none;
        }

        .sidebar-overlay.show {
            display: block;
        }

        .main-layout {
            display: grid;
            grid-template-columns: 280px 1fr;
            min-height: 600px;
        }

        /* Sidebar */
        .sidebar {
            background: rgba(11, 18, 39, 0.8);
            border-right: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            flex-direction: column;
        }

        .sidebar-section {
            padding: 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .sidebar-section h3 {
            color: #94a3b8;
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .my-info {
            background: rgba(99, 179, 237, 0.1);
            border-radius: 12px;
            padding: 12px;
            border: 1px solid rgba(99, 179, 237, 0.2);
        }

        .my-id {
            font-family: monospace;
            font-size: 0.9rem;
            color: #63b3ed;
            word-break: break-all;
            margin-bottom: 8px;
        }

        .copy-btn {
            width: 100%;
            padding: 8px;
            background: rgba(99, 179, 237, 0.2);
            border: 1px solid rgba(99, 179, 237, 0.3);
            color: #63b3ed;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.85rem;
            transition: all 0.2s;
        }

        .copy-btn:hover {
            background: rgba(99, 179, 237, 0.3);
        }

        .input-field {
            width: 100%;
            padding: 12px 14px;
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.15);
            background: rgba(11, 22, 47, 0.7);
            color: white;
            font-size: 0.95rem;
            transition: all 0.3s;
            margin-bottom: 10px;
        }

        .input-field:focus {
            outline: none;
            border-color: rgba(99, 179, 237, 0.6);
            box-shadow: 0 0 0 3px rgba(99, 179, 237, 0.15);
        }

        .input-field::placeholder {
            color: #64748b;
        }

        .btn {
            padding: 10px 16px;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            width: 100%;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-primary {
            background: linear-gradient(45deg, #4f46e5, #7c3aed);
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(79, 70, 229, 0.4);
        }

        .btn-secondary {
            background: rgba(30, 41, 59, 0.8);
            color: #94a3b8;
            border: 1px solid rgba(148, 163, 184, 0.2);
        }

        .btn-secondary:hover:not(:disabled) {
            background: rgba(51, 65, 85, 0.8);
            color: #cbd5e1;
        }

        .btn-success {
            background: linear-gradient(45deg, #059669, #10b981);
            color: white;
        }

        .btn-danger {
            background: linear-gradient(45deg, #dc2626, #ef4444);
            color: white;
        }

        /* Peers list */
        .peers-list {
            flex: 1;
            overflow-y: auto;
            padding: 10px 20px;
        }

        .peer-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 12px;
            border-radius: 10px;
            margin-bottom: 8px;
            background: rgba(30, 41, 59, 0.5);
            border: 1px solid rgba(255, 255, 255, 0.05);
            transition: all 0.2s;
        }

        .peer-item:hover {
            background: rgba(30, 41, 59, 0.8);
        }

        .peer-item.connected {
            border-color: rgba(52, 211, 153, 0.3);
        }

        .peer-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: linear-gradient(45deg, #4f46e5, #7c3aed);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 0.9rem;
            flex-shrink: 0;
        }

        .peer-details {
            flex: 1;
            min-width: 0;
        }

        .peer-name {
            color: #e2e8f0;
            font-weight: 500;
            font-size: 0.9rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .peer-status {
            font-size: 0.75rem;
            color: #64748b;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .peer-status.online {
            color: #34d399;
        }

        .status-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: currentColor;
        }

        .encryption-badge {
            font-size: 0.7rem;
            padding: 2px 6px;
            border-radius: 4px;
            background: rgba(52, 211, 153, 0.2);
            color: #34d399;
        }

        .role-badge {
            font-size: 0.65rem;
            padding: 2px 6px;
            border-radius: 4px;
            margin-left: 6px;
        }

        .role-badge.admin {
            background: rgba(251, 191, 36, 0.2);
            color: #fbbf24;
        }

        .role-badge.creator {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
        }

        .peer-actions {
            display: flex;
            gap: 4px;
            margin-left: 8px;
        }

        .peer-action-btn {
            background: rgba(255, 255, 255, 0.1);
            border: none;
            color: #94a3b8;
            padding: 4px 8px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.85rem;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .peer-action-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            color: #e2e8f0;
        }

        /* Main chat area */
        .chat-area {
            display: flex;
            flex-direction: column;
            background: rgba(15, 23, 42, 0.5);
        }

        .chat-header {
            padding: 16px 20px;
            background: rgba(11, 18, 39, 0.8);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .chat-header-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .chat-header-info h2 {
            color: #e2e8f0;
            font-size: 1.1rem;
        }

        .chat-header-info .room-id {
            font-size: 0.8rem;
            color: #64748b;
            font-family: monospace;
        }

        .participants-count {
            display: flex;
            align-items: center;
            gap: 6px;
            color: #94a3b8;
            font-size: 0.85rem;
        }

        .messages-container {
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 12px;
            min-height: 0;
            scroll-behavior: smooth;
        }

        .message {
            max-width: 75%;
            padding: 12px 16px;
            border-radius: 16px;
            position: relative;
            animation: fadeIn 0.3s ease;
            word-wrap: break-word;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .message.sent {
            background: linear-gradient(45deg, #4f46e5, #6366f1);
            color: white;
            align-self: flex-end;
            border-bottom-right-radius: 4px;
        }

        .message.received {
            background: rgba(30, 41, 59, 0.9);
            color: #e2e8f0;
            align-self: flex-start;
            border-bottom-left-radius: 4px;
        }

        .message.system {
            background: rgba(30, 41, 59, 0.5);
            color: #94a3b8;
            align-self: center;
            max-width: 90%;
            font-size: 0.85rem;
            border-radius: 10px;
            text-align: center;
        }

        .message-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 4px;
            gap: 12px;
        }

        .message-sender {
            font-weight: 600;
            font-size: 0.8rem;
            color: #81e6d9;
        }

        .message.sent .message-sender {
            color: rgba(255, 255, 255, 0.8);
        }

        .message-time {
            font-size: 0.7rem;
            opacity: 0.7;
        }

        .message-content {
            line-height: 1.4;
        }

        .message-encryption {
            font-size: 0.65rem;
            margin-top: 4px;
            opacity: 0.6;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        /* File message */
        .file-message {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 10px;
            padding: 12px;
            margin-top: 8px;
        }

        .file-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .file-icon {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            background: rgba(99, 179, 237, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            color: #63b3ed;
        }

        .file-details {
            flex: 1;
        }

        .file-name {
            font-weight: 500;
            font-size: 0.9rem;
            word-break: break-all;
        }

        .file-size {
            font-size: 0.75rem;
            opacity: 0.7;
        }

        .file-progress {
            margin-top: 8px;
            height: 4px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 2px;
            overflow: hidden;
        }

        .file-progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #4f46e5, #7c3aed);
            transition: width 0.3s;
        }

        .file-download {
            margin-top: 8px;
            padding: 8px 12px;
            background: rgba(99, 179, 237, 0.2);
            border: none;
            border-radius: 6px;
            color: #63b3ed;
            cursor: pointer;
            font-size: 0.85rem;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .file-download:hover {
            background: rgba(99, 179, 237, 0.3);
        }

        /* Image preview */
        .image-preview {
            max-width: 300px;
            max-height: 200px;
            border-radius: 8px;
            margin-top: 8px;
            cursor: pointer;
        }

        /* Settings modal styles */
        .settings-modal {
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .settings-section {
            margin-bottom: 20px;
            padding-bottom: 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .settings-section:last-child {
            border-bottom: none;
        }

        .settings-section h4 {
            color: #e2e8f0;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .ice-server-item {
            background: rgba(30, 41, 59, 0.5);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 12px;
            margin-bottom: 10px;
            display: flex;
            align-items: flex-start;
            gap: 10px;
        }

        .ice-server-details {
            flex: 1;
        }

        .ice-server-details .server-url {
            color: #63b3ed;
            font-family: monospace;
            font-size: 0.85rem;
            margin-bottom: 4px;
        }

        .ice-server-details .server-credentials {
            color: #64748b;
            font-size: 0.75rem;
        }

        .ice-server-type {
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 0.7rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .ice-server-type.stun {
            background: rgba(99, 179, 237, 0.2);
            color: #63b3ed;
        }

        .ice-server-type.turn {
            background: rgba(251, 191, 36, 0.2);
            color: #fbbf24;
        }

        .ice-server-type.turns {
            background: rgba(52, 211, 153, 0.2);
            color: #34d399;
        }

        .delete-ice-server {
            background: none;
            border: none;
            color: #ef4444;
            cursor: pointer;
            padding: 4px;
            border-radius: 4px;
            transition: all 0.2s;
        }

        .delete-ice-server:hover {
            background: rgba(239, 68, 68, 0.1);
        }

        .add-ice-server-form {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 10px;
        }

        .add-ice-server-form .full-width {
            grid-column: 1 / -1;
        }

        .connection-status {
            padding: 12px;
            border-radius: 10px;
            background: rgba(30, 41, 59, 0.5);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .connection-status .status-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.85rem;
        }

        .connection-status .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #64748b;
        }

        .connection-status .status-dot.connected {
            background: #34d399;
        }

        .connection-status .status-dot.connecting {
            background: #fbbf24;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .reset-btn {
            background: rgba(239, 68, 68, 0.2);
            border: 1px solid rgba(239, 68, 68, 0.3);
            color: #ef4444;
        }

        .reset-btn:hover:not(:disabled) {
            background: rgba(239, 68, 68, 0.3);
        }

        /* Settings button in header */
        .settings-btn {
            position: absolute;
            top: 20px;
            right: 25px;
            width: 40px;
            height: 40px;
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            background: rgba(30, 41, 59, 0.8);
            color: #94a3b8;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .settings-btn:hover {
            background: rgba(51, 65, 85, 0.8);
            color: #e2e8f0;
            transform: rotate(90deg);
        }

        /* Input area */
        .input-area {
            padding: 16px 20px;
            background: rgba(11, 18, 39, 0.8);
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .input-row {
            display: flex;
            gap: 10px;
            align-items: flex-end;
        }

        .input-actions {
            display: flex;
            gap: 8px;
        }

        .action-btn {
            width: 44px;
            height: 44px;
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            background: rgba(30, 41, 59, 0.8);
            color: #94a3b8;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .action-btn:hover {
            background: rgba(51, 65, 85, 0.8);
            color: #e2e8f0;
        }

        .action-btn.active {
            background: rgba(99, 179, 237, 0.2);
            color: #63b3ed;
            border-color: rgba(99, 179, 237, 0.3);
        }

        .message-input-wrapper {
            flex: 1;
            position: relative;
        }

        .message-input {
            width: 100%;
            padding: 12px 16px;
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            background: rgba(30, 41, 59, 0.8);
            color: white;
            font-size: 0.95rem;
            resize: none;
            min-height: 44px;
            max-height: 120px;
        }

        .message-input:focus {
            outline: none;
            border-color: rgba(99, 179, 237, 0.5);
        }

        .message-input:disabled {
            opacity: 0.5;
        }

        .send-btn {
            width: 44px;
            height: 44px;
            border-radius: 12px;
            border: none;
            background: linear-gradient(45deg, #4f46e5, #7c3aed);
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .send-btn:hover:not(:disabled) {
            transform: scale(1.05);
        }

        .send-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Typing indicator */
        .typing-indicator {
            padding: 8px 20px;
            color: #64748b;
            font-size: 0.8rem;
            display: none;
        }

        .typing-indicator.active {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .typing-dots {
            display: flex;
            gap: 3px;
        }

        .typing-dots span {
            width: 5px;
            height: 5px;
            border-radius: 50%;
            background: #64748b;
            animation: bounce 1.4s infinite ease-in-out;
        }

        .typing-dots span:nth-child(1) { animation-delay: 0s; }
        .typing-dots span:nth-child(2) { animation-delay: 0.2s; }
        .typing-dots span:nth-child(3) { animation-delay: 0.4s; }

        @keyframes bounce {
            0%, 80%, 100% { transform: translateY(0); }
            40% { transform: translateY(-5px); }
        }

        /* File input hidden */
        #file-input {
            display: none;
        }

        /* Toast */
        .toast {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: rgba(17, 24, 39, 0.95);
            color: white;
            padding: 14px 24px;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
            z-index: 1000;
            transition: transform 0.3s;
            border: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .toast.show {
            transform: translateX(-50%) translateY(0);
        }

        .toast.success { border-color: rgba(52, 211, 153, 0.5); }
        .toast.error { border-color: rgba(239, 68, 68, 0.5); }
        .toast.warning { border-color: rgba(251, 191, 36, 0.5); }

        /* Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s;
        }

        .modal-overlay.show {
            opacity: 1;
            visibility: visible;
        }

        .modal {
            background: rgba(15, 23, 42, 0.98);
            border-radius: 20px;
            padding: 24px;
            max-width: 450px;
            width: 90%;
            border: 1px solid rgba(255, 255, 255, 0.1);
            transform: scale(0.9);
            transition: transform 0.3s;
        }

        .modal-overlay.show .modal {
            transform: scale(1);
        }

        .modal h3 {
            color: #e2e8f0;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .modal-actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .modal-actions .btn {
            flex: 1;
        }

        /* Connection status bar */
        .status-bar {
            padding: 8px 20px;
            background: rgba(11, 18, 39, 0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            font-size: 0.8rem;
            border-top: 1px solid rgba(255, 255, 255, 0.05);
        }

        .status-bar.connecting {
            color: #fbbf24;
        }

        .status-bar.connected {
            color: #34d399;
        }

        .status-bar.error {
            color: #f87171;
        }

        .spinner {
            width: 14px;
            height: 14px;
            border: 2px solid currentColor;
            border-top-color: transparent;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Responsive */
        @media (max-width: 768px) {
            .mobile-menu-btn {
                display: flex;
            }

            .mobile-close-btn {
                display: flex;
            }

            .main-layout {
                grid-template-columns: 1fr;
            }

            .sidebar {
                display: none;
            }

            .sidebar.mobile-show {
                display: flex;
                position: fixed;
                top: 0;
                left: 0;
                bottom: 0;
                width: 280px;
                z-index: 100;
                box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.9);
            }

            h1 {
                font-size: 1.6rem;
            }

            .badges {
                display: none;
            }
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(99, 179, 237, 0.4);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: rgba(99, 179, 237, 0.6);
        }

        ::-webkit-scrollbar-corner {
            background: rgba(255, 255, 255, 0.05);
        }

        /* Firefox scrollbar */
        * {
            scrollbar-width: thin;
            scrollbar-color: rgba(99, 179, 237, 0.4) rgba(255, 255, 255, 0.05);
        }

        /* Room creation section */
        .room-options {
            display: flex;
            gap: 8px;
            margin-bottom: 10px;
        }

        .room-option {
            flex: 1;
            padding: 10px;
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            background: rgba(30, 41, 59, 0.5);
            color: #94a3b8;
            cursor: pointer;
            text-align: center;
            font-size: 0.8rem;
            transition: all 0.2s;
        }

        .room-option:hover, .room-option.active {
            border-color: rgba(99, 179, 237, 0.5);
            color: #63b3ed;
            background: rgba(99, 179, 237, 0.1);
        }

        .encryption-info {
            background: rgba(52, 211, 153, 0.1);
            border: 1px solid rgba(52, 211, 153, 0.2);
            border-radius: 8px;
            padding: 10px;
            margin-top: 10px;
            font-size: 0.75rem;
            color: #34d399;
            display: flex;
            align-items: flex-start;
            gap: 8px;
        }

        .encryption-info svg {
            flex-shrink: 0;
            margin-top: 2px;
        }

        /* Tabs for Rooms and DM */
        .tabs-container {
            display: flex;
            gap: 10px;
            padding: 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            background: rgba(11, 18, 39, 0.8);
        }

        .tab {
            flex: 1;
            padding: 12px 20px;
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            background: rgba(30, 41, 59, 0.5);
            color: #94a3b8;
            cursor: pointer;
            text-align: center;
            font-size: 0.9rem;
            font-weight: 600;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .tab:hover {
            border-color: rgba(99, 179, 237, 0.5);
            color: #63b3ed;
            background: rgba(99, 179, 237, 0.1);
        }

        .tab.active {
            border-color: rgba(99, 179, 237, 0.6);
            color: #fff;
            background: linear-gradient(45deg, #4f46e5, #7c3aed);
            box-shadow: 0 4px 12px rgba(79, 70, 229, 0.3);
        }

        /* Section containers */
        .section-container {
            display: none;
            flex-direction: column;
            height: 100%;
        }

        .section-container.active {
            display: flex;
        }

        /* Rooms section */
        .rooms-header {
            padding: 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .rooms-header h2 {
            color: #e2e8f0;
            font-size: 1.3rem;
            margin-bottom: 10px;
        }

        .rooms-actions {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 10px;
        }

        .rooms-actions-full {
            display: flex;
            gap: 10px;
        }

        .rooms-list {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
        }

        .room-card {
            background: rgba(30, 41, 59, 0.5);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .room-card:hover {
            border-color: rgba(99, 179, 237, 0.4);
            background: rgba(30, 41, 59, 0.7);
            transform: translateY(-2px);
        }

        .room-card.active {
            border-color: rgba(99, 179, 237, 0.6);
            background: rgba(99, 179, 237, 0.1);
        }

        .room-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 8px;
        }

        .room-card-name {
            color: #e2e8f0;
            font-size: 1rem;
            font-weight: 600;
        }

        .room-card-badge {
            padding: 3px 8px;
            border-radius: 6px;
            font-size: 0.7rem;
            font-weight: 600;
            background: rgba(52, 211, 153, 0.2);
            color: #34d399;
        }

        .room-card-info {
            color: #94a3b8;
            font-size: 0.85rem;
            margin-bottom: 8px;
        }

        .room-card-participants {
            display: flex;
            align-items: center;
            gap: 6px;
            color: #64748b;
            font-size: 0.8rem;
        }

        /* Room detail view */
        .room-detail {
            display: none;
            flex-direction: column;
            height: 100%;
        }

        .room-detail.active {
            display: flex;
        }

        .room-detail-header {
            padding: 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .room-detail-title h2 {
            color: #e2e8f0;
            font-size: 1.2rem;
            margin-bottom: 4px;
        }

        .room-detail-id {
            color: #94a3b8;
            font-size: 0.85rem;
        }

        .room-detail-actions {
            display: flex;
            gap: 8px;
        }

        /* Join requests section */
        .join-requests-section {
            background: rgba(251, 191, 36, 0.1);
            border: 1px solid rgba(251, 191, 36, 0.2);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 16px;
        }

        .join-requests-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .join-requests-title {
            color: #fbbf24;
            font-size: 0.95rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .join-request-item {
            background: rgba(11, 22, 47, 0.5);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .join-request-info {
            color: #e2e8f0;
            font-size: 0.9rem;
        }

        .join-request-time {
            color: #64748b;
            font-size: 0.75rem;
        }

        .join-request-actions {
            display: flex;
            gap: 6px;
        }

        /* DM section */
        .dm-contacts {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
        }

        .dm-contact {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 14px;
            border-radius: 10px;
            background: rgba(30, 41, 59, 0.5);
            border: 1px solid rgba(255, 255, 255, 0.1);
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .dm-contact:hover {
            border-color: rgba(99, 179, 237, 0.4);
            background: rgba(30, 41, 59, 0.7);
        }

        .dm-contact.active {
            border-color: rgba(99, 179, 237, 0.6);
            background: rgba(99, 179, 237, 0.1);
        }

        .dm-contact-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, #4f46e5, #7c3aed);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            color: #fff;
            font-weight: 600;
        }

        .dm-contact-info {
            flex: 1;
        }

        .dm-contact-name {
            color: #e2e8f0;
            font-size: 0.95rem;
            font-weight: 600;
        }

        .dm-contact-status {
            color: #94a3b8;
            font-size: 0.8rem;
        }

        .dm-contact-unread {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #ef4444;
            color: #fff;
            font-size: 0.7rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .dm-delete-btn {
            background: transparent;
            border: none;
            color: #64748b;
            cursor: pointer;
            padding: 6px;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            opacity: 0;
        }

        .dm-contact:hover .dm-delete-btn {
            opacity: 1;
        }

        .dm-delete-btn:hover {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
        }

        /* Friends section in sidebar */
        .friends-section {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .friends-list {
            flex: 1;
            overflow-y: auto;
            padding: 10px 0;
        }

        .friend-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 14px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .friend-item:hover {
            background: rgba(30, 41, 59, 0.5);
        }

        .friend-item.offline {
            opacity: 0.6;
        }

        .friend-status {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #64748b;
        }

        .friend-status.online {
            background: #34d399;
            box-shadow: 0 0 8px rgba(52, 211, 153, 0.5);
        }

        .friend-name {
            color: #e2e8f0;
            font-size: 0.9rem;
            flex: 1;
        }

        /* Settings for DM restrictions */
        .dm-settings {
            background: rgba(30, 41, 59, 0.5);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 12px;
            margin-top: 10px;
        }

        .dm-settings h4 {
            color: #94a3b8;
            font-size: 0.8rem;
            margin-bottom: 8px;
            text-transform: uppercase;
        }

        .toggle-switch {
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
        }

        .toggle-input {
            width: 44px;
            height: 24px;
            background: rgba(100, 116, 139, 0.3);
            border-radius: 12px;
            position: relative;
            transition: all 0.3s;
        }

        .toggle-input.active {
            background: #4f46e5;
        }

        .toggle-input::after {
            content: '';
            position: absolute;
            width: 18px;
            height: 18px;
            background: #fff;
            border-radius: 50%;
            top: 3px;
            left: 3px;
            transition: all 0.3s;
        }

        .toggle-input.active::after {
            left: 23px;
        }

        .toggle-label {
            color: #94a3b8;
            font-size: 0.85rem;
        }

        /* Add friend form */
        .add-friend-form {
            display: flex;
            gap: 8px;
            margin-top: 10px;
        }

        .add-friend-form input {
            flex: 1;
        }

        /* Room creation modal */
        .room-creation-form {
            display: grid;
            gap: 12px;
        }

        .room-creation-field label {
            display: block;
            color: #94a3b8;
            font-size: 0.85rem;
            margin-bottom: 6px;
        }

        /* Access code display */
        .access-code-display {
            background: rgba(99, 179, 237, 0.1);
            border: 1px solid rgba(99, 179, 237, 0.2);
            border-radius: 8px;
            padding: 12px;
            margin-top: 12px;
        }

        .access-code-label {
            color: #94a3b8;
            font-size: 0.8rem;
            margin-bottom: 6px;
        }

        .access-code-value {
            color: #63b3ed;
            font-family: monospace;
            font-size: 1rem;
            word-break: break-all;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <button class="mobile-menu-btn" id="mobile-menu-btn" title="Menu">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="3" y1="12" x2="21" y2="12"></line>
                    <line x1="3" y1="6" x2="21" y2="6"></line>
                    <line x1="3" y1="18" x2="21" y2="18"></line>
                </svg>
            </button>
            <button class="settings-btn" id="settings-btn" title="Paramètres de connexion">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="3"></circle>
                    <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path>
                </svg>
            </button>
            <h1>PeerText</h1>
            <p class="subtitle">Messagerie P2P chiffrée de bout en bout</p>
            <div class="badges">
                <span class="badge e2e">
                    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
                        <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
                    </svg>
                    Chiffrement E2E AES-256
                </span>
                <span class="badge p2p">
                    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="2"></circle>
                        <path d="M16.24 7.76a6 6 0 0 1 0 8.49m-8.48-.01a6 6 0 0 1 0-8.49m11.31-2.82a10 10 0 0 1 0 14.14m-14.14 0a10 10 0 0 1 0-14.14"></path>
                    </svg>
                    WebRTC P2P
                </span>
                <span class="badge files">
                    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                        <polyline points="14 2 14 8 20 8"></polyline>
                    </svg>
                    Transfert de fichiers
                </span>
                <span class="badge rooms">
                    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                        <circle cx="9" cy="7" r="4"></circle>
                        <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                        <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                    </svg>
                    Salons multi-utilisateurs
                </span>
            </div>
        </header>

        <!-- Mobile sidebar overlay -->
        <div class="sidebar-overlay" id="sidebar-overlay"></div>

        <div class="main-layout">
            <!-- Sidebar -->
            <button class="mobile-close-btn" id="mobile-close-btn" title="Fermer">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="18" y1="6" x2="6" y2="18"></line>
                    <line x1="6" y1="6" x2="18" y2="18"></line>
                </svg>
            </button>
            <div class="sidebar" id="sidebar">
                <div class="sidebar-section">
                    <h3>
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                            <circle cx="12" cy="7" r="4"></circle>
                        </svg>
                        Mon profil
                    </h3>
                    <input type="text" id="my-name" class="input-field" placeholder="Votre pseudo" maxlength="20">
                    <div class="my-info">
                        <div class="my-id" id="my-peer-id">Connexion...</div>
                        <button class="copy-btn" id="copy-id-btn">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="display:inline;vertical-align:middle;margin-right:4px;">
                                <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                                <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                            </svg>
                            Copier mon ID
                        </button>
                    </div>
                </div>

                <div class="sidebar-section">
                    <h3>
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path>
                            <polyline points="15 3 21 3 21 9"></polyline>
                            <line x1="10" y1="14" x2="21" y2="3"></line>
                        </svg>
                        Connexion directe
                    </h3>
                    <input type="text" id="peer-id-input" class="input-field" placeholder="ID du pair (PT-XXXXXXXX)" style="text-transform:uppercase;">
                    <button class="btn btn-primary" id="connect-peer-btn">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path>
                            <polyline points="15 3 21 3 21 9"></polyline>
                            <line x1="10" y1="14" x2="21" y2="3"></line>
                        </svg>
                        Se connecter
                    </button>
                    <div class="encryption-info">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path>
                        </svg>
                        <span>Échangez vos IDs (PT-XXXXXXXX) puis connectez-vous. Chiffrement AES-256-GCM automatique.</span>
                    </div>
                </div>

                <!-- Friends section -->
                <div class="sidebar-section friends-section">
                    <h3>
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                            <circle cx="8.5" cy="7" r="4"></circle>
                            <line x1="20" y1="8" x2="20" y2="14"></line>
                            <line x1="23" y1="11" x2="17" y2="11"></line>
                        </svg>
                        Amis
                    </h3>
                    <div class="friends-list" id="friends-list">
                        <div style="color:#64748b;font-size:0.85rem;text-align:center;padding:20px;">
                            Aucun ami. Ajoutez-en un !
                        </div>
                    </div>
                    <div class="add-friend-form">
                        <input type="text" id="add-friend-input" class="input-field" placeholder="ID de l'ami (PT-XXXXXXXX)" style="margin-bottom:0;">
                        <button class="btn btn-primary" id="add-friend-btn" style="width:auto;padding:10px 14px;">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <line x1="12" y1="5" x2="12" y2="19"></line>
                                <line x1="5" y1="12" x2="19" y2="12"></line>
                            </svg>
                        </button>
                    </div>
                </div>

                <!-- Room participants section -->
                <div class="sidebar-section" style="flex:1;display:flex;flex-direction:column;">
                    <h3>
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                            <circle cx="9" cy="7" r="4"></circle>
                            <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                            <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                        </svg>
                        Participants (<span id="participants-count">0</span>)
                    </h3>
                    <div class="peers-list" id="peers-list">
                        <div style="color:#64748b;font-size:0.85rem;text-align:center;padding:20px;">
                            Rejoignez un salon pour voir les participants
                        </div>
                    </div>
                </div>

                <!-- DM Settings -->
                <div class="sidebar-section">
                    <h3>
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="3"></circle>
                            <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path>
                        </svg>
                        Paramètres DM
                    </h3>
                    <div class="dm-settings">
                        <h4>Restrictions</h4>
                        <div class="toggle-switch" id="accept-dm-toggle">
                            <div class="toggle-input active"></div>
                            <span class="toggle-label">Accepter les messages de non-amis</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Main area with tabs -->
            <div class="main-area">
                <!-- Tabs -->
                <div class="tabs-container" id="tabs-container">
                    <div class="tab active" id="rooms-tab" data-tab="rooms">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                            <circle cx="9" cy="7" r="4"></circle>
                            <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                            <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                        </svg>
                        Salons
                    </div>
                    <div class="tab" id="users-tab" data-tab="users">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                            <circle cx="9" cy="7" r="4"></circle>
                            <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                            <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                        </svg>
                        Utilisateurs connectés
                    </div>
                    <div class="tab" id="dm-tab" data-tab="dm">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
                        </svg>
                        Messages privés
                    </div>
                </div>

                <!-- Rooms Section -->
                <div class="section-container active" id="rooms-section">
                    <!-- Rooms list view -->
                    <div class="rooms-view" id="rooms-list-view">
                        <div class="rooms-header">
                            <h2>Mes salons privés</h2>
                            <div class="rooms-actions">
                                <button class="btn btn-secondary" id="refresh-rooms-btn" title="Actualiser la liste" style="width:auto;padding:8px 12px;">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M23 4v6h-6M1 20v-6h6M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path>
                                    </svg>
                                </button>
                                <input type="text" id="join-room-id-input" class="input-field" placeholder="ID du salon à rejoindre">
                                <button class="btn btn-primary" id="join-room-btn">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path>
                                        <polyline points="15 3 21 3 21 9"></polyline>
                                        <line x1="10" y1="14" x2="21" y2="3"></line>
                                    </svg>
                                    Demander à rejoindre
                                </button>
                            </div>
                            <button class="btn btn-success rooms-actions-full" id="create-room-btn">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <line x1="12" y1="5" x2="12" y2="19"></line>
                                    <line x1="5" y1="12" x2="19" y2="12"></line>
                                </svg>
                                Créer un nouveau salon
                            </button>
                        </div>
                        <div class="rooms-list" id="private-rooms-list">
                            <div style="color:#64748b;font-size:0.9rem;text-align:center;padding:40px;">
                                <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" style="margin-bottom:12px;">
                                    <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                                    <circle cx="9" cy="7" r="4"></circle>
                                    <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                                    <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                                </svg>
                                <p>Aucun salon. Créez-en un ou rejoignez un salon existant.</p>
                            </div>
                        </div>
                    </div>

                    <!-- Room detail view -->
                    <div class="room-detail" id="room-detail">
                        <div class="room-detail-header">
                            <button class="btn btn-secondary" id="back-to-rooms-btn" style="width:auto;padding:8px 16px;">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <line x1="19" y1="12" x2="5" y2="12"></line>
                                    <polyline points="12 19 5 12 12 5"></polyline>
                                </svg>
                                Retour
                            </button>
                            <div class="room-detail-title">
                                <h2 id="detail-room-name">Nom du salon</h2>
                                <span class="room-detail-id" id="detail-room-id">ID: XXXXXXXX</span>
                            </div>
                            <div class="room-detail-actions">
                                <button class="btn btn-secondary" id="copy-access-id-btn" style="width:auto;padding:8px 16px;">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                                        <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                                    </svg>
                                    Copier l'ID
                                </button>
                                <button class="btn btn-danger" id="leave-room-btn" style="width:auto;padding:8px 16px;display:none;">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
                                        <polyline points="16 17 21 12 16 7"></polyline>
                                        <line x1="21" y1="12" x2="9" y2="12"></line>
                                    </svg>
                                    Quitter
                                </button>
                                <button class="btn btn-danger" id="delete-room-btn" style="width:auto;padding:8px 16px;display:none;">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M3 6h18M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/>
                                    </svg>
                                    Supprimer
                                </button>
                            </div>
                        </div>

                        <!-- Join requests section (for creators/admins) -->
                        <div class="join-requests-section" id="join-requests-section" style="display:none;padding:16px 20px;margin:0;border-radius:0;">
                            <div class="join-requests-header">
                                <span class="join-requests-title">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path>
                                    </svg>
                                    Demandes de rejoindre (<span id="join-requests-count">0</span>)
                                </span>
                            </div>
                            <div id="join-requests-list"></div>
                        </div>

                        <!-- Chat area in room -->
                        <div class="messages-container" id="messages-container">
                            <div class="message system">
                                Bienvenue dans le salon !
                            </div>
                        </div>

                        <div class="typing-indicator" id="typing-indicator">
                            <div class="typing-dots">
                                <span></span><span></span><span></span>
                            </div>
                            <span id="typing-names">Quelqu'un écrit...</span>
                        </div>

                        <div class="input-area">
                            <div class="input-row">
                                <div class="input-actions">
                                    <button class="action-btn" id="attach-btn" title="Envoyer un fichier">
                                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <path d="M21.44 11.05l-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66l-9.2 9.19a2 2 0 0 1-2.83-2.83l8.49-8.48"></path>
                                        </svg>
                                    </button>
                                </div>
                                <div class="message-input-wrapper">
                                    <textarea id="message-input" class="message-input" placeholder="Écrivez votre message..." rows="1"></textarea>
                                </div>
                                <button class="send-btn" id="send-btn" title="Envoyer">
                                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <line x1="22" y1="2" x2="11" y2="13"></line>
                                        <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
                                    </svg>
                                </button>
                            </div>
                        </div>

                        <div class="status-bar connecting" id="status-bar">
                            <div class="spinner"></div>
                            <span>Connexion au réseau P2P...</span>
                        </div>
                    </div>
                </div>

                <!-- Users Section -->
                <div class="section-container" id="users-section">
                    <div class="rooms-header">
                        <h2>Utilisateurs connectés</h2>
                    </div>
                    <div class="rooms-list" id="connected-users-list">
                        <div style="color:#64748b;font-size:0.9rem;text-align:center;padding:40px;">
                            <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" style="margin-bottom:12px;">
                                <circle cx="12" cy="12" r="10"></circle>
                                <line x1="12" y1="8" x2="12" y2="12"></line>
                                <line x1="12" y1="16" x2="12.01" y2="16"></line>
                            </svg>
                            <p>Aucun utilisateur connecté pour le moment</p>
                        </div>
                    </div>
                </div>

                <!-- DM Section -->
                <div class="section-container" id="dm-section">
                    <div class="dm-contacts" id="dm-contacts-list">
                        <div style="color:#64748b;font-size:0.9rem;text-align:center;padding:40px;">
                            <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" style="margin-bottom:12px;">
                                <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
                            </svg>
                            <p>Aucune conversation. Ajoutez des amis depuis la barre latérale.</p>
                        </div>
                    </div>

                    <!-- DM conversation view -->
                    <div class="room-detail" id="dm-conversation" style="display:none;">
                        <div class="room-detail-header">
                            <button class="btn btn-secondary dm-back-btn" style="width:auto;padding:8px 16px;">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <line x1="19" y1="12" x2="5" y2="12"></line>
                                    <polyline points="12 19 5 12 12 5"></polyline>
                                </svg>
                                Retour
                            </button>
                            <div class="room-detail-title">
                                <h2 id="dm-contact-name">Nom du contact</h2>
                                <span class="room-detail-id">Message privé</span>
                            </div>
                        </div>

                        <div class="messages-container" id="dm-messages">
                            <div class="message system">
                                Début de la conversation privée
                            </div>
                        </div>

                        <div class="typing-indicator dm-typing-indicator" style="display:none;">
                            <div class="typing-dots">
                                <span></span><span></span><span></span>
                            </div>
                        </div>

                        <div class="input-area">
                            <div class="input-row">
                                <div class="input-actions">
                                    <button class="action-btn dm-attach-btn" title="Envoyer un fichier">
                                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <path d="M21.44 11.05l-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66l-9.2 9.19a2 2 0 0 1-2.83-2.83l8.49-8.48"></path>
                                        </svg>
                                    </button>
                                </div>
                                <div class="message-input-wrapper">
                                    <textarea id="dm-input" class="message-input" placeholder="Écrivez un message privé..." rows="1"></textarea>
                                </div>
                                <button class="send-btn dm-send-btn" title="Envoyer">
                                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <line x1="22" y1="2" x2="11" y2="13"></line>
                                        <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
                                    </svg>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- File input -->
    <input type="file" id="file-input" multiple>

    <!-- Toast -->
    <div class="toast" id="toast"></div>

    <!-- Room creation modal -->
    <div class="modal-overlay" id="room-creation-modal">
        <div class="modal">
            <h3>
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                    <circle cx="9" cy="7" r="4"></circle>
                    <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                    <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                </svg>
                Créer un salon privé
            </h3>
            <div class="room-creation-form">
                <div class="room-creation-field">
                    <label>Nom du salon</label>
                    <input type="text" id="room-name-input" class="input-field" placeholder="Ex: Famille, Travail, Amis..." maxlength="50">
                </div>
                <button class="btn btn-primary" id="confirm-create-room-btn">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="22" y1="2" x2="11" y2="13"></line>
                        <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
                    </svg>
                    Créer le salon
                </button>
                <button class="btn btn-secondary" id="cancel-create-room-btn">
                    Annuler
                </button>
            </div>
        </div>
    </div>

    <!-- Image modal -->
    <div class="modal-overlay" id="image-modal">
        <div class="modal" style="max-width:90%;max-height:90%;padding:10px;">
            <img id="modal-image" style="max-width:100%;max-height:80vh;border-radius:8px;">
        </div>
    </div>

    <!-- Settings modal -->
    <div class="modal-overlay" id="settings-modal">
        <div class="modal settings-modal">
            <h3>
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="3"></circle>
                    <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path>
                </svg>
                Configuration des serveurs ICE
            </h3>

            <!-- Connection status -->
            <div class="connection-status">
                <div class="status-indicator">
                    <span class="status-dot" id="connection-status-dot"></span>
                    <span id="connection-status-text">En attente de connexion...</span>
                </div>
            </div>

            <div class="settings-section">
                <h4>
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10"></circle>
                        <line x1="2" y1="12" x2="22" y2="12"></line>
                        <path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"></path>
                    </svg>
                    Serveurs STUN/TURN configurés
                </h4>
                <div id="ice-servers-list">
                    <!-- ICE servers will be listed here -->
                </div>
            </div>

            <div class="settings-section">
                <h4>
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10"></circle>
                        <line x1="12" y1="8" x2="12" y2="16"></line>
                        <line x1="8" y1="12" x2="16" y2="12"></line>
                    </svg>
                    Ajouter un serveur ICE
                </h4>
                <div class="add-ice-server-form">
                    <select id="ice-server-type" class="input-field">
                        <option value="stun">STUN</option>
                        <option value="turn">TURN (TCP)</option>
                        <option value="turns">TURN (TLS)</option>
                    </select>
                    <input type="text" id="ice-server-url" class="input-field" placeholder="URL (ex: stun:stun.example.com:3478)">
                    <input type="text" id="ice-server-username" class="input-field" placeholder="Nom d'utilisateur (TURN)">
                    <input type="password" id="ice-server-credential" class="input-field" placeholder="Mot de passe (TURN)">
                    <button class="btn btn-success" id="add-ice-server-btn">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="12" y1="5" x2="12" y2="19"></line>
                            <line x1="5" y1="12" x2="19" y2="12"></line>
                        </svg>
                        Ajouter
                    </button>
                </div>
            </div>

            <div class="settings-section">
                <h4>
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M22 12h-4l-3 9L9 3l-3 9H2"></path>
                    </svg>
                    Serveur de signalisation
                </h4>
                <div style="color:#94a3b8;font-size:0.8rem;margin-bottom:10px;">
                    Le serveur par défaut est utilisé. Vous pouvez configurer un serveur personnalisé ci-dessous.
                </div>
                <input type="text" id="signaling-host" class="input-field" placeholder="Host (ex: 0.peerjs.com)">
                <input type="number" id="signaling-port" class="input-field" placeholder="Port (ex: 443)" value="443">
                <input type="text" id="signaling-path" class="input-field" placeholder="Path (ex: /)" value="/">
                <button class="btn btn-secondary" id="save-signaling-btn">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path>
                        <polyline points="17 21 17 13 7 13 7 21"></polyline>
                        <polyline points="7 3 7 8 15 8"></polyline>
                    </svg>
                    Sauvegarder
                </button>
                <button class="btn btn-secondary reset-btn" id="reset-signaling-btn" style="margin-top:10px;">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"></path>
                        <path d="M3 3v5h5"></path>
                    </svg>
                    Réinitialiser par défaut
                </button>
            </div>

            <div class="settings-section">
                <h4>
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10"></circle>
                        <path d="M8 14s1.5 2 4 2 4-2 4-2"></path>
                        <line x1="9" y1="9" x2="9.01" y2="9"></line>
                        <line x1="15" y1="9" x2="15.01" y2="9"></line>
                    </svg>
                    Diagnostic et aide
                </h4>
                <div id="diagnostic-info" style="background:rgba(30, 41, 59, 0.5);border:1px solid rgba(255,255,255,0.1);border-radius:10px;padding:12px;font-size:0.85rem;color:#94a3b8;">
                    <div style="margin-bottom:8px;">
                        <strong>État actuel:</strong>
                        <div id="diagnostic-status">Chargement...</div>
                    </div>
                    <div style="margin-bottom:8px;">
                        <strong>Nombre de connexions P2P:</strong>
                        <span id="diagnostic-connections">0</span>
                    </div>
                    <div style="margin-bottom:8px;">
                        <strong>HTTPS:</strong>
                        <span id="diagnostic-https">-</span>
                    </div>
                    <div>
                        <strong>WebRTC supporté:</strong>
                        <span id="diagnostic-webrtc">-</span>
                    </div>
                </div>
                <div style="margin-top:15px;padding:10px;background:rgba(99, 179, 237, 0.1);border:1px solid rgba(99, 179, 237, 0.2);border-radius:8px;font-size:0.8rem;color:#63b3ed;">
                    <strong>💡 Conseils de dépannage:</strong>
                    <ul style="margin-left:20px;margin-top:8px;line-height:1.6;">
                        <li>Assurez-vous d'utiliser <strong>HTTPS</strong> (obligatoire pour WebRTC)</li>
                        <li>Ajoutez des serveurs TURN pour traverser les NAT/Firewalls</li>
                        <li>Vérifiez que votre pare-feu/antivirus ne bloque pas WebRTC</li>
                        <li>Si le pair est injoignable, il peut être hors ligne</li>
                        <li>Essayez de rafraîchir la page si la connexion au serveur échoue</li>
                    </ul>
                </div>
            </div>

            <div class="modal-actions">
                <button class="btn btn-secondary reset-btn" id="reset-ice-servers-btn">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"></path>
                        <path d="M3 3v5h5"></path>
                    </svg>
                    Réinitialiser
                </button>
                <button class="btn btn-secondary" id="close-settings-btn">Fermer</button>
            </div>
        </div>
    </div>

    <script>
    // ============================================
    // CONFIGURATION
    // ============================================
    // Load custom ICE servers from localStorage or use default configuration
    const savedIceServers = localStorage.getItem('customIceServers');
    const defaultIceServers = [
        // STUN servers (public)
        { urls: 'stun:stun.l.google.com:19302' },
        { urls: 'stun:stun1.l.google.com:19302' },
        { urls: 'stun:stun2.l.google.com:19302' },
        { urls: 'stun:global.stun.twilio.com:3478' },
        // TURN servers (OpenRelay - Free for testing)
        { urls: 'turn:openrelay.metered.ca:80', username: 'openrelayproject', credential: 'openrelayproject' },
        { urls: 'turn:openrelay.metered.ca:443', username: 'openrelayproject', credential: 'openrelayproject' },
        { urls: 'turns:openrelay.metered.ca:443', username: 'openrelayproject', credential: 'openrelayproject' }
    ];

    // Load custom signaling server configuration
    const savedSignalingConfig = localStorage.getItem('signalingConfig');
    let signalingConfig = null;
    if (savedSignalingConfig) {
        try {
            signalingConfig = JSON.parse(savedSignalingConfig);
        } catch (e) {
            console.error('Error parsing signaling config:', e);
        }
    }

    const CONFIG = {
        peerOptions: {
            debug: 1,
            config: {
                iceServers: savedIceServers ? JSON.parse(savedIceServers) : defaultIceServers
            },
            ...(signalingConfig ? signalingConfig : {})
        },
        chunkSize: 16384, // 16KB chunks for file transfer
        maxFileSize: 100 * 1024 * 1024, // 100MB max
        typingTimeout: 2000
    };

    // ============================================
    // STATE
    // ============================================
    const state = {
        peer: null,
        myPeerId: null,
        myName: localStorage.getItem('peerName') || 'Anonyme',
        currentRoom: null,
        isRoomCreator: false,
        connections: new Map(), // peerId -> { conn, name, publicKey, sharedKey, role, username }
        pendingConnections: new Map(),
        myKeyPair: null,
        typingPeers: new Set(),
        typingTimer: null,
        isTyping: false,
        fileTransfers: new Map(), // transferId -> { chunks, metadata }
        // Moderation system
        roomAdmins: new Map(), // roomId -> Set<username>
        activeVotes: new Map(), // voteId -> { targetUsername, votes: Set<username>, expiresAt }
        bannedUsers: new Map(), // roomId -> Set<username>
        reportedUsers: new Map(), // roomId -> Map<username, { reporterUsername, reason, count }>
        myRole: 'participant', // 'creator', 'admin', 'participant'
        // Room system (private only)
        privateRooms: JSON.parse(localStorage.getItem('privateRooms') || '[]'), // Array of room objects
        currentTab: 'rooms', // 'rooms' or 'dm'
        // Friends & DM system
        friends: JSON.parse(localStorage.getItem('friends') || '[]'), // Array of usernames
        friendRequestsSent: new Map(), // username -> timestamp
        friendRequestsReceived: new Map(), // username -> { name, timestamp }
        pendingJoinRequests: new Map(), // roomId -> Array<{username, name, timestamp}>
        allowDMFromNonFriends: localStorage.getItem('allowDMFromNonFriends') !== 'false',
        // Direct messages
        directMessages: new Map(), // username -> Array<{content, timestamp, fromMe}>
        activeDMConversation: null, // username of current DM conversation
        // Identity & discovery system
        usernameToPeerId: new Map(), // username -> current peerId
        peerIdToUsername: new Map(), // peerId -> username
        myPreviousPeerIds: JSON.parse(localStorage.getItem('myPreviousPeerIds') || '[]'), // Array of old peerIds
        // Connections by username for easy lookup
        connectionsByUsername: new Map() // username -> { conn, name, publicKey, sharedKey, role, peerId }
    };

    // ============================================
    // DOM ELEMENTS
    // ============================================
    const elements = {
        myName: document.getElementById('my-name'),
        myPeerId: document.getElementById('my-peer-id'),
        copyIdBtn: document.getElementById('copy-id-btn'),
        peerIdInput: document.getElementById('peer-id-input'),
        connectPeerBtn: document.getElementById('connect-peer-btn'),
        peersList: document.getElementById('peers-list'),
        participantsCount: document.getElementById('participants-count'),
        headerParticipants: document.getElementById('header-participants'),
        roomName: document.getElementById('room-name'),
        currentRoomId: document.getElementById('current-room-id'),
        messagesContainer: document.getElementById('messages-container'),
        messageInput: document.getElementById('message-input'),
        sendBtn: document.getElementById('send-btn'),
        attachBtn: document.getElementById('attach-btn'),
        fileInput: document.getElementById('file-input'),
        typingIndicator: document.getElementById('typing-indicator'),
        typingNames: document.getElementById('typing-names'),
        statusBar: document.getElementById('status-bar'),
        toast: document.getElementById('toast'),
        imageModal: document.getElementById('image-modal'),
        modalImage: document.getElementById('modal-image'),
        settingsBtn: document.getElementById('settings-btn'),
        settingsModal: document.getElementById('settings-modal'),
        iceServersList: document.getElementById('ice-servers-list'),
        iceServerType: document.getElementById('ice-server-type'),
        iceServerUrl: document.getElementById('ice-server-url'),
        iceServerUsername: document.getElementById('ice-server-username'),
        iceServerCredential: document.getElementById('ice-server-credential'),
        addIceServerBtn: document.getElementById('add-ice-server-btn'),
        resetIceServersBtn: document.getElementById('reset-ice-servers-btn'),
        closeSettingsBtn: document.getElementById('close-settings-btn'),
        connectionStatusDot: document.getElementById('connection-status-dot'),
        connectionStatusText: document.getElementById('connection-status-text'),
        signalingHost: document.getElementById('signaling-host'),
        signalingPort: document.getElementById('signaling-port'),
        signalingPath: document.getElementById('signaling-path'),
        saveSignalingBtn: document.getElementById('save-signaling-btn'),
        resetSignalingBtn: document.getElementById('reset-signaling-btn'),
        diagnosticStatus: document.getElementById('diagnostic-status'),
        diagnosticConnections: document.getElementById('diagnostic-connections'),
        diagnosticHttps: document.getElementById('diagnostic-https'),
        diagnosticWebrtc: document.getElementById('diagnostic-webrtc'),
        mobileMenuBtn: document.getElementById('mobile-menu-btn'),
        mobileCloseBtn: document.getElementById('mobile-close-btn'),
        sidebar: document.getElementById('sidebar'),
        sidebarOverlay: document.getElementById('sidebar-overlay'),
        // New UI elements for rooms & DM
        tabsContainer: document.getElementById('tabs-container'),
        roomsTab: document.getElementById('rooms-tab'),
        usersTab: document.getElementById('users-tab'),
        dmTab: document.getElementById('dm-tab'),
        roomsSection: document.getElementById('rooms-section'),
        usersSection: document.getElementById('users-section'),
        dmSection: document.getElementById('dm-section'),
        connectedUsersList: document.getElementById('connected-users-list'),
        privateRoomsList: document.getElementById('private-rooms-list'),
        createRoomBtn: document.getElementById('create-room-btn'),
        joinRoomIdInput: document.getElementById('join-room-id-input'),
        joinRoomBtn: document.getElementById('join-room-btn'),
        roomNameInput: document.getElementById('room-name-input'),
        roomCreationModal: document.getElementById('room-creation-modal'),
        confirmCreateRoomBtn: document.getElementById('confirm-create-room-btn'),
        cancelCreateRoomBtn: document.getElementById('cancel-create-room-btn'),
        backToRoomsBtn: document.getElementById('back-to-rooms-btn'),
        roomDetail: document.getElementById('room-detail'),
        detailRoomName: document.getElementById('detail-room-name'),
        detailRoomId: document.getElementById('detail-room-id'),
        copyAccessIdBtn: document.getElementById('copy-access-id-btn'),
        leaveRoomBtn: document.getElementById('leave-room-btn'),
        deleteRoomBtn: document.getElementById('delete-room-btn'),
        joinRequestsSection: document.getElementById('join-requests-section'),
        joinRequestsList: document.getElementById('join-requests-list'),
        joinRequestsCount: document.getElementById('join-requests-count'),
        // DM elements
        dmContactsList: document.getElementById('dm-contacts-list'),
        dmConversation: document.getElementById('dm-conversation'),
        dmMessages: document.getElementById('dm-messages'),
        dmInput: document.getElementById('dm-input'),
        dmSendBtn: document.querySelector('.dm-send-btn'),
        dmAttachBtn: document.querySelector('.dm-attach-btn'),
        dmBackBtn: document.querySelectorAll('.dm-back-btn'),
        dmContactName: document.getElementById('dm-contact-name'),
        // Friends elements
        friendsList: document.getElementById('friends-list'),
        addFriendInput: document.getElementById('add-friend-input'),
        addFriendBtn: document.getElementById('add-friend-btn'),
        acceptDMToggle: document.getElementById('accept-dm-toggle')
    };

    // ============================================
    // CRYPTO - E2E ENCRYPTION
    // ============================================
    const Crypto = {
        async generateKeyPair() {
            return await window.crypto.subtle.generateKey(
                { name: 'ECDH', namedCurve: 'P-256' },
                true,
                ['deriveKey', 'deriveBits']
            );
        },

        async exportPublicKey(publicKey) {
            const exported = await window.crypto.subtle.exportKey('raw', publicKey);
            return btoa(String.fromCharCode(...new Uint8Array(exported)));
        },

        async importPublicKey(base64Key) {
            const binary = atob(base64Key);
            const bytes = new Uint8Array(binary.length);
            for (let i = 0; i < binary.length; i++) {
                bytes[i] = binary.charCodeAt(i);
            }
            return await window.crypto.subtle.importKey(
                'raw',
                bytes,
                { name: 'ECDH', namedCurve: 'P-256' },
                true,
                []
            );
        },

        async deriveSharedKey(privateKey, publicKey) {
            return await window.crypto.subtle.deriveKey(
                { name: 'ECDH', public: publicKey },
                privateKey,
                { name: 'AES-GCM', length: 256 },
                false,
                ['encrypt', 'decrypt']
            );
        },

        async encrypt(sharedKey, data) {
            const iv = window.crypto.getRandomValues(new Uint8Array(12));
            const encoded = new TextEncoder().encode(JSON.stringify(data));
            const encrypted = await window.crypto.subtle.encrypt(
                { name: 'AES-GCM', iv },
                sharedKey,
                encoded
            );
            return {
                iv: btoa(String.fromCharCode(...iv)),
                data: btoa(String.fromCharCode(...new Uint8Array(encrypted)))
            };
        },

        async decrypt(sharedKey, encryptedData) {
            const iv = new Uint8Array(atob(encryptedData.iv).split('').map(c => c.charCodeAt(0)));
            const data = new Uint8Array(atob(encryptedData.data).split('').map(c => c.charCodeAt(0)));
            const decrypted = await window.crypto.subtle.decrypt(
                { name: 'AES-GCM', iv },
                sharedKey,
                data
            );
            return JSON.parse(new TextDecoder().decode(decrypted));
        },

        async encryptFile(sharedKey, arrayBuffer) {
            const iv = window.crypto.getRandomValues(new Uint8Array(12));
            const encrypted = await window.crypto.subtle.encrypt(
                { name: 'AES-GCM', iv },
                sharedKey,
                arrayBuffer
            );
            return { iv, encrypted: new Uint8Array(encrypted) };
        },

        async decryptFile(sharedKey, iv, encryptedData) {
            return await window.crypto.subtle.decrypt(
                { name: 'AES-GCM', iv },
                sharedKey,
                encryptedData
            );
        }
    };

    // ============================================
    // INITIALIZATION
    // ============================================
    async function init() {
        elements.myName.value = state.myName;

        // Load saved data
        loadDirectMessages();

        // Migrate old data from peerId-based to username-based
        migrateOldData();

        // Generate encryption keys
        state.myKeyPair = await Crypto.generateKeyPair();

        // Event listeners
        elements.myName.addEventListener('input', handleNameChange);
        elements.copyIdBtn.addEventListener('click', copyPeerId);
        elements.connectPeerBtn.addEventListener('click', handleConnectPeer);
        elements.peerIdInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') handleConnectPeer();
        });
        elements.sendBtn.addEventListener('click', sendMessage);
        elements.messageInput.addEventListener('keydown', handleMessageKeydown);
        elements.messageInput.addEventListener('input', handleTyping);
        elements.attachBtn.addEventListener('click', () => elements.fileInput.click());
        elements.fileInput.addEventListener('change', handleFileSelect);
        elements.imageModal.addEventListener('click', () => elements.imageModal.classList.remove('show'));

        // Settings modal event listeners
        elements.settingsBtn.addEventListener('click', () => openSettingsModal());
        elements.closeSettingsBtn.addEventListener('click', () => closeSettingsModal());
        elements.settingsModal.addEventListener('click', (e) => {
            if (e.target === elements.settingsModal) closeSettingsModal();
        });
        elements.addIceServerBtn.addEventListener('click', addIceServer);
        elements.resetIceServersBtn.addEventListener('click', resetIceServers);
        elements.saveSignalingBtn.addEventListener('click', saveSignalingConfig);
        elements.resetSignalingBtn.addEventListener('click', resetSignalingConfig);

        // Mobile menu event listeners
        elements.mobileMenuBtn.addEventListener('click', toggleMobileSidebar);
        elements.mobileCloseBtn.addEventListener('click', toggleMobileSidebar);
        elements.sidebarOverlay.addEventListener('click', toggleMobileSidebar);

        // Refresh rooms button
        const refreshRoomsBtn = document.getElementById('refresh-rooms-btn');
        if (refreshRoomsBtn) {
            refreshRoomsBtn.addEventListener('click', refreshRoomsList);
        }

        // Tab switching
        elements.roomsTab.addEventListener('click', () => switchTab('rooms'));
        elements.usersTab.addEventListener('click', () => switchTab('users'));
        elements.dmTab.addEventListener('click', () => switchTab('dm'));

        // Room creation and management
        elements.createRoomBtn.addEventListener('click', openRoomCreationModal);
        elements.confirmCreateRoomBtn.addEventListener('click', createPrivateRoom);
        elements.cancelCreateRoomBtn.addEventListener('click', closeRoomCreationModal);
        elements.roomCreationModal.addEventListener('click', (e) => {
            if (e.target === elements.roomCreationModal) closeRoomCreationModal();
        });

        // Join room
        elements.joinRoomBtn.addEventListener('click', requestToJoinRoom);

        // Room detail navigation
        elements.backToRoomsBtn.addEventListener('click', backToRoomsList);

        // Copy room access ID
        elements.copyAccessIdBtn.addEventListener('click', copyRoomAccessId);

        // Leave/Delete room
        elements.leaveRoomBtn.addEventListener('click', leaveRoom);
        elements.deleteRoomBtn.addEventListener('click', deleteRoom);

        // Friends management
        elements.addFriendBtn.addEventListener('click', addFriend);
        elements.addFriendInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') addFriend();
        });

        // DM settings toggle
        elements.acceptDMToggle.addEventListener('click', toggleDmSettings);

        // DM message sending
        elements.dmSendBtn.addEventListener('click', sendDirectMessage);
        elements.dmInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendDirectMessage();
            }
        });

        // DM back buttons
        elements.dmBackBtn.forEach(btn => {
            btn.addEventListener('click', backToDmList);
        });

        // Initialize UI
        updateFriendsList();
        updatePrivateRoomsList();
        updateDmContactsList();

        // Initialize PeerJS
        initializePeer();

        // Save current peerId mapping for this username
        savePeerIdMapping();

        // Start ping/pong interval for connection health
        startConnectionHealthCheck();
    }

    function savePeerIdMapping() {
        // Save mapping: username -> current peerId
        const mapping = JSON.parse(localStorage.getItem('usernamePeerIdMapping') || '{}');
        mapping[state.myName] = state.myPeerId;
        localStorage.setItem('usernamePeerIdMapping', JSON.stringify(mapping));
    }

    function getPeerIdForUsername(username) {
        const mapping = JSON.parse(localStorage.getItem('usernamePeerIdMapping') || '{}');
        return mapping[username];
    }

    // Connection health check
    function startConnectionHealthCheck() {
        // Send ping every 30 seconds
        setInterval(() => {
            state.connections.forEach(({ conn }) => {
                if (conn && conn.open) {
                    conn.send({
                        type: 'ping',
                        timestamp: Date.now()
                    });
                }
            });

            // Check for stale connections (no response in 60 seconds)
            const now = Date.now();
            state.connections.forEach((info, peerId) => {
                if (info.lastSeen && now - info.lastSeen > 60000) {
                    console.log(`Peer ${peerId} appears disconnected`);
                    appendSystemMessage(`${info.name || 'Un utilisateur'} semble déconnecté`);
                }
            });
        }, 30000);
    }

    // Handle direct peer connection
    function handleConnectPeer() {
        const input = elements.peerIdInput.value.trim();

        if (!input) {
            showToast('Entrez l\'ID du pair ou le nom d\'utilisateur', 'error');
            return;
        }

        // Check if input looks like a peerId (PT-XXXXXXXX format)
        const isPeerIdFormat = /^PT-[A-Z0-9]{8}$/.test(input.toUpperCase());
        let targetPeerId = input.toUpperCase();
        let targetUsername = input;

        if (!isPeerIdFormat) {
            // Treat as username - try to find current peerId
            const foundPeerId = getPeerIdForUsername(input);
            if (foundPeerId) {
                targetPeerId = foundPeerId;
                targetUsername = input;
                showToast(`Résolution du nom d\'utilisateur "${input}" vers ${foundPeerId}`, 'info');
            } else {
                showToast(`Nom d\'utilisateur "${input}" non trouvé. Assurez-vous que l\'utilisateur est connecté.`, 'warning');
                return;
            }
        }

        if (targetPeerId === state.myPeerId) {
            showToast('Vous ne pouvez pas vous connecter à vous-même', 'error');
            return;
        }

        if (state.connections.has(targetPeerId)) {
            showToast('Déjà connecté à ce pair', 'warning');
            return;
        }

        appendSystemMessage(`Connexion à ${targetUsername} (${targetPeerId})...`);
        connectToPeer(targetPeerId);
        elements.peerIdInput.value = '';
    }

    // ============================================
    // ICE SERVERS CONFIGURATION
    // ============================================
    function openSettingsModal() {
        renderIceServersList();
        loadSignalingConfig();
        updateConnectionStatus();
        updateDiagnostics();
        elements.settingsModal.classList.add('show');
    }

    function updateDiagnostics() {
        // Connection status
        if (state.peer && state.peer.id) {
            elements.diagnosticStatus.textContent = '✅ Connecté';
            elements.diagnosticStatus.style.color = '#34d399';
        } else {
            elements.diagnosticStatus.textContent = '❌ Non connecté';
            elements.diagnosticStatus.style.color = '#ef4444';
        }

        // P2P connections
        elements.diagnosticConnections.textContent = state.connections.size;
        if (state.connections.size > 0) {
            elements.diagnosticConnections.style.color = '#34d399';
        } else {
            elements.diagnosticConnections.style.color = '#fbbf24';
        }

        // HTTPS check
        const isHttps = window.location.protocol === 'https:';
        elements.diagnosticHttps.textContent = isHttps ? '✅ Oui' : '❌ Non (Requis pour WebRTC)';
        elements.diagnosticHttps.style.color = isHttps ? '#34d399' : '#ef4444';

        // WebRTC support
        const hasWebRTC = !!(window.RTCPeerConnection || window.webkitRTCPeerConnection || window.mozRTCPeerConnection);
        elements.diagnosticWebrtc.textContent = hasWebRTC ? '✅ Oui' : '❌ Non';
        elements.diagnosticWebrtc.style.color = hasWebRTC ? '#34d399' : '#ef4444';
    }

    function closeSettingsModal() {
        elements.settingsModal.classList.remove('show');
    }

    function renderIceServersList() {
        const iceServers = CONFIG.peerOptions.config.iceServers;

        if (iceServers.length === 0) {
            elements.iceServersList.innerHTML = `
                <div style="color:#64748b;font-size:0.85rem;text-align:center;padding:20px;">
                    Aucun serveur ICE configuré
                </div>
            `;
            return;
        }

        elements.iceServersList.innerHTML = iceServers.map((server, index) => {
            const url = server.urls;
            const type = getIceServerType(url);
            const hasCredentials = server.username || server.credential;

            return `
                <div class="ice-server-item">
                    <span class="ice-server-type ${type}">${type}</span>
                    <div class="ice-server-details">
                        <div class="server-url">${escapeHtml(url)}</div>
                        ${hasCredentials ? `
                            <div class="server-credentials">
                                ${server.username ? `User: ${escapeHtml(server.username)}` : ''}
                                ${server.username && server.credential ? ' | ' : ''}
                                ${server.credential ? '••••••••' : ''}
                            </div>
                        ` : ''}
                    </div>
                    <button class="delete-ice-server" onclick="removeIceServer(${index})" title="Supprimer">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="18" y1="6" x2="6" y2="18"></line>
                            <line x1="6" y1="6" x2="18" y2="18"></line>
                        </svg>
                    </button>
                </div>
            `;
        }).join('');
    }

    function getIceServerType(url) {
        if (url.startsWith('stun:')) return 'stun';
        if (url.startsWith('turns:')) return 'turns';
        if (url.startsWith('turn:')) return 'turn';
        return 'unknown';
    }

    function addIceServer() {
        const type = elements.iceServerType.value;
        const url = elements.iceServerUrl.value.trim();

        if (!url) {
            showToast('Veuillez entrer l\'URL du serveur', 'error');
            return;
        }

        const newServer = { urls: url };

        // Add credentials for TURN servers
        if (type !== 'stun') {
            const username = elements.iceServerUsername.value.trim();
            const credential = elements.iceServerCredential.value;

            if (username) newServer.username = username;
            if (credential) newServer.credential = credential;
        }

        // Add to configuration
        CONFIG.peerOptions.config.iceServers.push(newServer);

        // Save to localStorage
        localStorage.setItem('customIceServers', JSON.stringify(CONFIG.peerOptions.config.iceServers));

        // Clear form
        elements.iceServerUrl.value = '';
        elements.iceServerUsername.value = '';
        elements.iceServerCredential.value = '';

        // Re-render
        renderIceServersList();
        showToast('Serveur ICE ajouté', 'success');
    }

    window.removeIceServer = function(index) {
        CONFIG.peerOptions.config.iceServers.splice(index, 1);
        localStorage.setItem('customIceServers', JSON.stringify(CONFIG.peerOptions.config.iceServers));
        renderIceServersList();
        showToast('Serveur ICE supprimé', 'success');
    };

    function resetIceServers() {
        if (confirm('Voulez-vous vraiment réinitialiser aux serveurs par défaut ?')) {
            localStorage.removeItem('customIceServers');
            CONFIG.peerOptions.config.iceServers = [...defaultIceServers];
            renderIceServersList();
            showToast('Configuration réinitialisée', 'success');

            // Note: For the new servers to take effect, the user needs to refresh the page
            showToast('Actualisez la page pour appliquer les changements', 'warning');
        }
    }

    function updateConnectionStatus() {
        if (state.peer && state.peer.id) {
            elements.connectionStatusDot.classList.add('connected');
            elements.connectionStatusText.textContent = 'Connecté au réseau P2P';
        } else {
            elements.connectionStatusDot.classList.remove('connected');
            elements.connectionStatusText.textContent = 'En attente de connexion...';
        }
    }

    function loadSignalingConfig() {
        const savedConfig = localStorage.getItem('signalingConfig');
        if (savedConfig) {
            try {
                const config = JSON.parse(savedConfig);
                elements.signalingHost.value = config.host || '';
                elements.signalingPort.value = config.port || '443';
                elements.signalingPath.value = config.path || '/';
            } catch (e) {
                console.error('Error loading signaling config:', e);
            }
        }
    }

    function saveSignalingConfig() {
        const host = elements.signalingHost.value.trim();
        const port = parseInt(elements.signalingPort.value) || 443;
        const path = elements.signalingPath.value.trim() || '/';

        if (!host) {
            showToast('Veuillez entrer l\'hôte du serveur', 'error');
            return;
        }

        const config = { host, port, path };
        localStorage.setItem('signalingConfig', JSON.stringify(config));
        showToast('Configuration du serveur sauvegardée', 'success');

        // Inform user that reload is needed
        showToast('Actualisez la page pour appliquer les changements', 'warning');
    }

    function resetSignalingConfig() {
        if (confirm('Voulez-vous vraiment réinitialiser au serveur par défaut ?')) {
            localStorage.removeItem('signalingConfig');
            elements.signalingHost.value = '';
            elements.signalingPort.value = '443';
            elements.signalingPath.value = '/';
            showToast('Configuration réinitialisée', 'success');
            showToast('Actualisez la page pour appliquer les changements', 'warning');
        }
    }

    function initializePeer() {
        const peerId = 'PT-' + generateId(8);

        try {
            state.peer = new Peer(peerId, CONFIG.peerOptions);

            state.peer.on('open', (id) => {
                state.myPeerId = id;
                elements.myPeerId.textContent = id;
                updateStatusBar('connected', 'Connecté au réseau P2P');
                updateConnectionStatus();
                updateDiagnostics();
                appendSystemMessage('✅ Connecté au serveur de signalisation');
                appendSystemMessage('Prêt ! Partagez votre ID et entrez celui de votre correspondant pour vous connecter.');
                enableChat();
            });

            state.peer.on('connection', handleIncomingConnection);
            state.peer.on('error', handlePeerError);
            state.peer.on('disconnected', () => {
                console.log('Peer disconnected from signaling server');
                updateStatusBar('warning', 'Connexion serveur perdue. Reconnexion...');
                appendSystemMessage('⚠️ Connexion au serveur de signalisation perdue. Tentative de reconnexion...');
                // P2P connections remain active even if signaling server is lost
                // Reconnect to signaling server after delay
                setTimeout(() => {
                    try {
                        state.peer.reconnect();
                        console.log('Reconnecting to signaling server...');
                    } catch (e) {
                        console.error('Reconnect error:', e);
                        appendSystemMessage('❌ Impossible de se reconnecter au serveur. Essayez de rafraîchir la page.');
                    }
                }, 2000);
            });

        } catch (error) {
            console.error('Init error:', error);
            updateStatusBar('error', 'Erreur d\'initialisation');
            appendSystemMessage('❌ Erreur d\'initialisation: ' + error.message);
            appendSystemMessage('💡 Astuce: Vérifiez votre connexion internet et les paramètres du serveur de signalisation ⚙️');
        }
    }

    // ============================================
    // CONNECTION HANDLING
    // ============================================
    async function handleIncomingConnection(conn) {
        console.log('Incoming connection from:', conn.peer);

        if (state.connections.has(conn.peer)) {
            conn.close();
            return;
        }

        setupConnection(conn);
    }

    async function connectToPeer(peerId) {
        if (state.connections.has(peerId) || peerId === state.myPeerId) {
            return;
        }

        try {
            const conn = state.peer.connect(peerId, {
                reliable: true,
                serialization: 'json'
            });
            setupConnection(conn);
        } catch (error) {
            console.error('Connection error:', error);
        }
    }

    async function setupConnection(conn) {
        const peerId = conn.peer;

        state.pendingConnections.set(peerId, { conn, name: 'Connexion...' });
        updatePeersList();

        conn.on('open', async () => {
            // Send handshake with public key
            const publicKeyBase64 = await Crypto.exportPublicKey(state.myKeyPair.publicKey);
            conn.send({
                type: 'handshake',
                name: state.myName,
                publicKey: publicKeyBase64,
                room: state.currentRoom
            });
        });

        conn.on('data', async (data) => {
            await handleIncomingData(conn, data);
        });

        conn.on('close', () => {
            handlePeerDisconnect(peerId);
        });

        conn.on('error', (err) => {
            console.error('Connection error:', err);
            // Don't immediately disconnect on data channel errors during file transfer
            if (err.type === 'data-channel-error' && state.fileTransfers.size > 0) {
                console.log('Data channel error during file transfer - ignoring');
                return;
            }
            handlePeerDisconnect(peerId);
        });
    }

    async function handleIncomingData(conn, data) {
        const peerId = conn.peer;

        switch (data.type) {
            case 'handshake':
                await handleHandshake(conn, data);
                break;

            case 'encrypted':
                await handleEncryptedMessage(peerId, data);
                break;

            case 'file-start':
                handleFileStart(peerId, data);
                break;

            case 'file-chunk':
                handleFileChunk(peerId, data);
                break;

            case 'file-end':
                await handleFileEnd(peerId, data);
                break;

            case 'ping':
                // Respond to ping with pong
                const peerInfo = state.connections.get(peerId);
                if (peerInfo && peerInfo.conn) {
                    peerInfo.conn.send({ type: 'pong', timestamp: data.timestamp });
                }
                break;

            case 'pong':
                // Update last activity for this peer
                const info = state.connections.get(peerId);
                if (info) {
                    info.lastSeen = Date.now();
                }
                break;

            case 'typing':
                handleTypingIndicator(peerId, data);
                break;

            case 'peer-list':
                handlePeerList(data);
                break;

            case 'kick-user':
                handleKickUser(data);
                break;

            case 'ban-user':
                handleBanUser(data);
                break;

            case 'report-user':
                handleReportUser(data);
                break;

            case 'vote-kick':
                handleVoteKick(data);
                break;

            case 'admin-assign':
                handleAdminAssign(data);
                break;

            case 'admin-revoke':
                handleAdminRevoke(data);
                break;

            case 'join-request':
                handleJoinRequest(data);
                break;

            case 'join-approved':
                handleJoinApproved(data);
                break;

            case 'dm':
                handleDirectMessage(data);
                break;

            case 'dmRejected':
                handleDmRejected(data);
                break;

            case 'dmRead':
                handleDmRead(data);
                break;
        }
    }

    async function handleHandshake(conn, data) {
        const peerId = conn.peer;
        const username = data.name || 'Anonyme';

        try {
            // Check if this is a name update (no public key) or initial handshake
            const existingConnection = state.connections.get(peerId);
            
            if (data.publicKey && !existingConnection) {
                // Initial handshake - import public key and derive shared key
                const peerPublicKey = await Crypto.importPublicKey(data.publicKey);
                const sharedKey = await Crypto.deriveSharedKey(state.myKeyPair.privateKey, peerPublicKey);

                // Store new connection info
                const connectionInfo = {
                    conn,
                    name: username,
                    username: username,
                    publicKey: peerPublicKey,
                    sharedKey,
                    lastSeen: Date.now()
                };

                state.connections.set(peerId, connectionInfo);
                state.connectionsByUsername.set(username, connectionInfo);

                // Store mapping username <-> peerId
                state.usernameToPeerId.set(username, peerId);
                state.peerIdToUsername.set(peerId, username);

                // Save previous peerIds for this username
                if (!state.myPreviousPeerIds.includes(peerId)) {
                    state.myPreviousPeerIds.push(peerId);
                    localStorage.setItem('myPreviousPeerIds', JSON.stringify(state.myPreviousPeerIds));
                }

                state.pendingConnections.delete(peerId);
                updatePeersList();
                updateDiagnostics();
                if (state.currentTab === 'users') {
                    updateConnectedUsersList();
                }

                appendSystemMessage(`${username} a rejoint le salon (E2E activé)`);
                showToast(`${username} connecté`, 'success');

                // If we're the room creator, share the peer list
                if (state.isRoomCreator) {
                    broadcastPeerList();
                }

                // Enable chat if not already
                enableChat();
            } else if (existingConnection) {
                // Name update - just update the name and mappings
                existingConnection.name = username;
                existingConnection.username = username;
                existingConnection.lastSeen = Date.now();

                // Update mappings
                state.usernameToPeerId.set(username, peerId);
                state.peerIdToUsername.set(peerId, username);

                updatePeersList();
            } else {
                // Invalid handshake - no connection and no public key
                console.warn('Invalid handshake: no existing connection and no public key');
                conn.close();
            }

        } catch (error) {
            console.error('Handshake error:', error);
            conn.close();
        }
    }

    function handlePeerDisconnect(peerId) {
        const peerInfo = state.connections.get(peerId);
        const name = peerInfo?.name || 'Un utilisateur';

        state.connections.delete(peerId);
        state.pendingConnections.delete(peerId);
        state.typingPeers.delete(peerId);

        updatePeersList();
        updateTypingIndicator();
        updateDiagnostics();
        if (state.currentTab === 'users') {
            updateConnectedUsersList();
        }

        appendSystemMessage(`${name} a quitté le salon`);
    }

    function broadcastPeerList() {
        const peerIds = Array.from(state.connections.keys());
        state.connections.forEach(({ conn }) => {
            conn.send({
                type: 'peer-list',
                peers: peerIds
            });
        });
    }

    function handlePeerList(data) {
        // Connect to any peers we're not already connected to
        data.peers.forEach(peerId => {
            if (!state.connections.has(peerId) && peerId !== state.myPeerId) {
                connectToPeer(peerId);
            }
        });
    }

    // ============================================
    // MODERATION HANDLERS
    // ============================================
    function handleKickUser(data) {
        const { targetPeerId, initiatorId, reason } = data;

        // Check if we have permission
        if (!canModerate()) {
            appendSystemMessage('⚠️ Action de modération ignorée - permissions insuffisantes', 'warning');
            return;
        }

        const peerInfo = state.connections.get(targetPeerId);
        if (peerInfo) {
            appendSystemMessage(`🚪 ${peerInfo.name} a été expulsé par l'administrateur`, 'warning');
            showToast(`${peerInfo.name} expulsé`, 'info');

            // Disconnect the user
            peerInfo.conn.send({
                type: 'kicked',
                reason: reason || 'Expulsion par administrateur',
                initiatorId
            });
            peerInfo.conn.close();
            state.connections.delete(targetPeerId);
            updatePeersList();
        }
    }

    function handleBanUser(data) {
        const { targetPeerId, initiatorId, reason } = data;

        // Check if we have permission
        if (!canModerate()) {
            appendSystemMessage('⚠️ Action de modération ignorée - permissions insuffisantes', 'warning');
            return;
        }

        const peerInfo = state.connections.get(targetPeerId);
        if (peerInfo) {
            appendSystemMessage(`🚫 ${peerInfo.name} a été banni du salon`, 'error');
            showToast(`${peerInfo.name} banni`, 'error');

            // Add to banned list
            const roomId = state.currentRoom?.id;
            if (roomId && !state.bannedUsers.has(roomId)) {
                state.bannedUsers.set(roomId, new Set());
            }
            if (roomId) {
                state.bannedUsers.get(roomId).add(targetPeerId);
            }

            // Disconnect the user
            peerInfo.conn.send({
                type: 'banned',
                reason: reason || 'Bannissement par administrateur',
                initiatorId
            });
            peerInfo.conn.close();
            state.connections.delete(targetPeerId);
            updatePeersList();
        }
    }

    function handleReportUser(data) {
        const { reporterId, targetPeerId, reason } = data;
        const reporterInfo = state.connections.get(reporterId);
        const targetInfo = state.connections.get(targetPeerId);

        if (!reporterInfo || !targetInfo) return;

        // Only admins/creator can see reports
        if (canModerate()) {
            appendSystemMessage(`🚨 Signalement: ${reporterInfo.name} signale ${targetInfo.name}`, 'warning');
            if (reason) {
                appendSystemMessage(`   Raison: ${reason}`, 'warning');
            }
            showToast('Nouveau signalement reçu', 'warning');
        }

        // Store report
        const roomId = state.currentRoom?.id;
        if (roomId) {
            if (!state.reportedUsers.has(roomId)) {
                state.reportedUsers.set(roomId, new Map());
            }
            const reports = state.reportedUsers.get(roomId);
            const existingReport = reports.get(targetPeerId);
            if (existingReport) {
                existingReport.count++;
                existingReport.reasons.push(reason);
            } else {
                reports.set(targetPeerId, {
                    reporterId,
                    reason,
                    count: 1,
                    reasons: [reason],
                    timestamp: Date.now()
                });
            }
        }
    }

    function handleVoteKick(data) {
        const { voteId, targetPeerId, voterId, vote } = data;

        // Check if we're the one being voted on
        if (targetPeerId === state.myPeerId) {
            // We cannot veto our own expulsion
            const peerInfo = state.connections.get(voterId);
            appendSystemMessage(`🗳 ${peerInfo?.name || 'Quelqu\'un'} a voté pour votre expulsion`, 'warning');

            // If vote passes (more than half of participants)
            const totalParticipants = state.connections.size + 1;
            const activeVote = state.activeVotes.get(voteId);
            if (activeVote && activeVote.votes.size >= Math.ceil(totalParticipants / 2)) {
                appendSystemMessage(`💔 Vous avez été expulsé par vote collectif`, 'error');
                // Send acceptance and disconnect
                state.connections.forEach(({ conn }) => {
                    conn.send({ type: 'vote-result', voteId, result: 'accepted', targetPeerId });
                });
                leaveRoom();
            }
            return;
        }

        // If we're admin/creator, handle veto
        if (canModerate()) {
            handleVoteResult(data);
            return;
        }

        // Regular participant - handle voting
        const activeVote = state.activeVotes.get(voteId);
        if (!activeVote) {
            // Create new vote
            state.activeVotes.set(voteId, {
                targetPeerId,
                votes: new Set([voterId]),
                expiresAt: Date.now() + 300000 // 5 minutes
            });
            const targetInfo = state.connections.get(targetPeerId);
            const voterInfo = state.connections.get(voterId);
            appendSystemMessage(`🗳 Vote d'expulsion lancé par ${voterInfo?.name || 'inconnu'} contre ${targetInfo?.name || 'inconnu'}`, 'warning');
            showToast('Vote d\'expulsion en cours - répondez par /oui ou /non', 'info');
        } else if (!activeVote.votes.has(voterId)) {
            // Add vote
            activeVote.votes.add(voterId);
            const votersCount = activeVote.votes.size;
            const totalParticipants = state.connections.size + 1;

            // Check if vote passes
            if (votersCount >= Math.ceil(totalParticipants / 2)) {
                appendSystemMessage(`✅ Vote accepté - Expulsion en cours`, 'warning');
                broadcastMessage({
                    type: 'vote-result',
                    voteId,
                    result: 'accepted',
                    targetPeerId
                });
            }
        }
    }

    function handleVoteResult(data) {
        const { voteId, result, targetPeerId } = data;

        if (!canModerate()) {
            // Not admin - regular participant
            if (result === 'rejected') {
                appendSystemMessage(`✅ L'expulsion a été rejetée par l'administrateur`, 'success');
                showToast('Vote annulé par l\'administrateur', 'success');
            }
            return;
        }

        // Admin/creator - veto authority
        if (result === 'accepted') {
            const targetInfo = state.connections.get(targetPeerId);
            if (confirm(`Le vote pour expulser ${targetInfo?.name || 'ce participant'} a réussi. Voulez-vous l'accepter ou le veto ?`)) {
                // Accept vote
                appendSystemMessage(`✅ Vote accepté - ${targetInfo?.name || 'Participant'} expulsé`, 'warning');
                if (targetInfo) {
                    targetInfo.conn.send({
                        type: 'kicked',
                        reason: 'Expulsion par vote collectif',
                        initiatorId: 'vote'
                    });
                    targetInfo.conn.close();
                    state.connections.delete(targetPeerId);
                    updatePeersList();
                }
                broadcastMessage({
                    type: 'vote-result',
                    voteId,
                    result: 'accepted',
                    targetPeerId
                });
            } else {
                // Veto vote
                appendSystemMessage(`🛡️ Veto appliqué - Expulsion annulée`, 'info');
                broadcastMessage({
                    type: 'vote-result',
                    voteId,
                    result: 'rejected',
                    targetPeerId
                });
            }
        }

        state.activeVotes.delete(voteId);
    }

    function handleAdminAssign(data) {
        const { targetPeerId, adminId } = data;
        const targetInfo = state.connections.get(targetPeerId);
        const adminInfo = state.connections.get(adminId);

        if (!targetInfo || !adminInfo) return;

        // Update role
        targetInfo.role = 'admin';

        // Store admin
        const roomId = state.currentRoom?.id;
        if (roomId) {
            if (!state.roomAdmins.has(roomId)) {
                state.roomAdmins.set(roomId, new Set());
            }
            state.roomAdmins.get(roomId).add(targetPeerId);
        }

        appendSystemMessage(`👑 ${adminInfo.name} a nommé ${targetInfo.name} administrateur`, 'success');
        showToast(`${targetInfo.name} est maintenant administrateur`, 'success');
        updatePeersList();
    }

    function handleAdminRevoke(data) {
        const { targetPeerId, revokerId } = data;
        const targetInfo = state.connections.get(targetPeerId);
        const revokerInfo = state.connections.get(revokerId);

        if (!targetInfo || !revokerInfo) return;

        // Update role
        targetInfo.role = 'participant';

        // Remove from admins
        const roomId = state.currentRoom?.id;
        if (roomId && state.roomAdmins.has(roomId)) {
            state.roomAdmins.get(roomId).delete(targetPeerId);
        }

        appendSystemMessage(`⚠️ ${revokerInfo.name} a révoqué les droits d'admin de ${targetInfo.name}`, 'warning');
        showToast(`${targetInfo.name} n'est plus administrateur`, 'warning');
        updatePeersList();
    }

    // Helper functions
    function canModerate() {
        return state.myRole === 'creator' || state.myRole === 'admin';
    }

    function broadcastMessage(message) {
        state.connections.forEach(({ conn }) => {
            if (conn.open) {
                conn.send(message);
            }
        });
    }

    // ============================================
    // MESSAGING
    // ============================================
    async function sendMessage() {
        const content = elements.messageInput.value.trim();
        if (!content || state.connections.size === 0) return;

        const timestamp = new Date().toISOString();
        const messageData = {
            type: 'message',
            content,
            sender: state.myName,
            timestamp
        };

        // Encrypt and send to all peers
        for (const [peerId, { conn, sharedKey }] of state.connections) {
            try {
                const encrypted = await Crypto.encrypt(sharedKey, messageData);
                conn.send({ type: 'encrypted', payload: encrypted });
            } catch (error) {
                console.error('Encryption error:', error);
            }
        }

        // Display locally
        appendMessage(content, 'sent', state.myName, timestamp, true);

        // Clear input
        elements.messageInput.value = '';
        elements.messageInput.style.height = 'auto';

        // Stop typing indicator
        sendTypingStatus(false);
    }

    async function handleEncryptedMessage(peerId, data) {
        const peerInfo = state.connections.get(peerId);
        if (!peerInfo) return;

        try {
            const decrypted = await Crypto.decrypt(peerInfo.sharedKey, data.payload);

            if (decrypted.type === 'message') {
                appendMessage(decrypted.content, 'received', decrypted.sender, decrypted.timestamp, true);
                playNotificationSound();
            }
        } catch (error) {
            console.error('Decryption error:', error);
        }
    }

    function appendMessage(content, type, sender, timestamp, encrypted = false) {
        const messageDiv = document.createElement('div');
        messageDiv.className = `message ${type}`;

        const time = timestamp ? formatTime(new Date(timestamp)) : formatTime(new Date());

        if (type === 'system') {
            messageDiv.textContent = content;
        } else {
            messageDiv.innerHTML = `
                <div class="message-header">
                    <span class="message-sender">${escapeHtml(sender)}</span>
                    <span class="message-time">${time}</span>
                </div>
                <div class="message-content">${escapeHtml(content)}</div>
                ${encrypted ? '<div class="message-encryption"><svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 10 0v4"></path></svg> Chiffré E2E</div>' : ''}
            `;
        }

        elements.messagesContainer.appendChild(messageDiv);
        scrollToBottom();
    }

    function appendSystemMessage(content) {
        appendMessage(content, 'system');
    }

    // ============================================
    // FILE TRANSFER
    // ============================================
    async function handleFileSelect(e) {
        const files = e.target.files;
        if (!files.length || state.connections.size === 0) return;

        for (const file of files) {
            if (file.size > CONFIG.maxFileSize) {
                showToast(`${file.name} est trop volumineux (max 100MB)`, 'error');
                continue;
            }
            await sendFile(file);
        }

        elements.fileInput.value = '';
    }

    async function sendFile(file) {
        const transferId = generateId(12);
        const arrayBuffer = await file.arrayBuffer();

        // Create message element with progress
        const messageId = 'file-' + transferId;
        appendFileMessage(messageId, file.name, file.size, file.type, 'sent', 0);

        // Send file to all peers
        for (const [peerId, { conn, sharedKey }] of state.connections) {
            try {
                // Encrypt the file
                const { iv, encrypted } = await Crypto.encryptFile(sharedKey, arrayBuffer);

                // Send file metadata
                conn.send({
                    type: 'file-start',
                    transferId,
                    fileName: file.name,
                    fileSize: encrypted.length,
                    fileType: file.type,
                    iv: Array.from(iv),
                    sender: state.myName,
                    timestamp: new Date().toISOString()
                });

                // Send chunks - use smaller chunk size for binary data
                const chunkSize = 4096; // 4KB chunks for binary data (smaller than JSON limit)
                const totalChunks = Math.ceil(encrypted.length / chunkSize);
                
                // Send chunks with delay to avoid connection overload
                for (let i = 0; i < totalChunks; i++) {
                    const start = i * chunkSize;
                    const end = Math.min(start + chunkSize, encrypted.length);
                    const chunk = encrypted.slice(start, end);

                    // Convert to base64 to avoid array size issues
                    const chunkBase64 = btoa(String.fromCharCode(...chunk));

                    conn.send({
                        type: 'file-chunk',
                        transferId,
                        chunkIndex: i,
                        totalChunks,
                        data: chunkBase64
                    });

                    // Update progress
                    const progress = ((i + 1) / totalChunks) * 100;
                    updateFileProgress(messageId, progress);

                    // Add small delay between chunks to avoid connection overload
                    await new Promise(resolve => setTimeout(resolve, 10));
                }

                // Add delay before sending completion
                await new Promise(resolve => setTimeout(resolve, 100));

                // Send completion
                conn.send({
                    type: 'file-end',
                    transferId
                });

            } catch (error) {
                console.error('File send error:', error);
                showToast(`Erreur d'envoi de ${file.name}`, 'error');
            }
        }

        updateFileProgress(messageId, 100, true);
    }

    function handleFileStart(peerId, data) {
        // Calculate expected chunks based on 4KB chunk size
        const chunkSize = 4096;
        state.fileTransfers.set(data.transferId, {
            chunks: new Array(Math.ceil(data.fileSize / chunkSize)),
            metadata: data,
            receivedChunks: 0,
            peerId
        });

        const messageId = 'file-' + data.transferId;
        appendFileMessage(messageId, data.fileName, data.fileSize, data.fileType, 'received', 0, data.sender, data.timestamp);
    }

    function handleFileChunk(peerId, data) {
        const transfer = state.fileTransfers.get(data.transferId);
        if (!transfer) return;

        // Decode base64 chunk to Uint8Array
        const binaryString = atob(data.data);
        const chunk = new Uint8Array(binaryString.length);
        for (let i = 0; i < binaryString.length; i++) {
            chunk[i] = binaryString.charCodeAt(i);
        }

        transfer.chunks[data.chunkIndex] = chunk;
        transfer.receivedChunks++;

        const progress = (transfer.receivedChunks / data.totalChunks) * 100;
        updateFileProgress('file-' + data.transferId, progress);
    }

    async function handleFileEnd(peerId, data) {
        const transfer = state.fileTransfers.get(data.transferId);
        if (!transfer) return;

        try {
            // Combine chunks - filter out null/undefined chunks
            const validChunks = transfer.chunks.filter(chunk => chunk !== null && chunk !== undefined);
            const totalLength = validChunks.reduce((sum, chunk) => sum + chunk.length, 0);
            const combined = new Uint8Array(totalLength);
            let offset = 0;
            for (const chunk of validChunks) {
                combined.set(chunk, offset);
                offset += chunk.length;
            }

            // Decrypt file
            const peerInfo = state.connections.get(peerId);
            if (!peerInfo) return;

            const iv = new Uint8Array(transfer.metadata.iv);
            const decrypted = await Crypto.decryptFile(peerInfo.sharedKey, iv, combined);

            // Create blob and download link
            const blob = new Blob([decrypted], { type: transfer.metadata.fileType });
            const url = URL.createObjectURL(blob);

            updateFileDownload('file-' + data.transferId, url, transfer.metadata.fileName, transfer.metadata.fileType, blob);

            playNotificationSound();

        } catch (error) {
            console.error('File receive error:', error);
            showToast('Erreur de réception du fichier', 'error');
        }

        state.fileTransfers.delete(data.transferId);
    }

    function appendFileMessage(messageId, fileName, fileSize, fileType, type, progress, sender = state.myName, timestamp = null) {
        const messageDiv = document.createElement('div');
        messageDiv.className = `message ${type}`;
        messageDiv.id = messageId;

        const time = timestamp ? formatTime(new Date(timestamp)) : formatTime(new Date());
        const isImage = fileType.startsWith('image/');

        messageDiv.innerHTML = `
            <div class="message-header">
                <span class="message-sender">${escapeHtml(sender)}</span>
                <span class="message-time">${time}</span>
            </div>
            <div class="file-message">
                <div class="file-info">
                    <div class="file-icon">
                        ${isImage ?
                            '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><circle cx="8.5" cy="8.5" r="1.5"></circle><polyline points="21 15 16 10 5 21"></polyline></svg>' :
                            '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline></svg>'
                        }
                    </div>
                    <div class="file-details">
                        <div class="file-name">${escapeHtml(fileName)}</div>
                        <div class="file-size">${formatFileSize(fileSize)}</div>
                    </div>
                </div>
                <div class="file-progress">
                    <div class="file-progress-bar" style="width: ${progress}%"></div>
                </div>
                <div class="file-actions"></div>
            </div>
            <div class="message-encryption"><svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 10 0v4"></path></svg> Fichier chiffré E2E</div>
        `;

        elements.messagesContainer.appendChild(messageDiv);
        scrollToBottom();
    }

    function updateFileProgress(messageId, progress, complete = false) {
        const el = document.getElementById(messageId);
        if (!el) return;

        const progressBar = el.querySelector('.file-progress-bar');
        if (progressBar) {
            progressBar.style.width = progress + '%';
        }

        if (complete) {
            const progressEl = el.querySelector('.file-progress');
            if (progressEl) progressEl.style.display = 'none';
        }
    }

    function updateFileDownload(messageId, url, fileName, fileType, blob) {
        const el = document.getElementById(messageId);
        if (!el) return;

        const actionsEl = el.querySelector('.file-actions');
        const progressEl = el.querySelector('.file-progress');

        if (progressEl) progressEl.style.display = 'none';

        // Show image preview if applicable
        if (fileType.startsWith('image/')) {
            const preview = document.createElement('img');
            preview.src = url;
            preview.className = 'image-preview';
            preview.onclick = () => {
                elements.modalImage.src = url;
                elements.imageModal.classList.add('show');
            };
            actionsEl.before(preview);
        }

        actionsEl.innerHTML = `
            <button class="file-download" onclick="downloadFile('${url}', '${escapeHtml(fileName)}')">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                    <polyline points="7 10 12 15 17 10"></polyline>
                    <line x1="12" y1="15" x2="12" y2="3"></line>
                </svg>
                Télécharger
            </button>
        `;
    }

    function downloadFile(url, fileName) {
        const a = document.createElement('a');
        a.href = url;
        a.download = fileName;
        a.click();
    }
    window.downloadFile = downloadFile;

    // ============================================
    // TYPING INDICATOR
    // ============================================
    function handleTyping() {
        // Auto-resize
        elements.messageInput.style.height = 'auto';
        elements.messageInput.style.height = Math.min(elements.messageInput.scrollHeight, 120) + 'px';

        if (!state.isTyping) {
            state.isTyping = true;
            sendTypingStatus(true);
        }

        clearTimeout(state.typingTimer);
        state.typingTimer = setTimeout(() => {
            state.isTyping = false;
            sendTypingStatus(false);
        }, CONFIG.typingTimeout);
    }

    function sendTypingStatus(isTyping) {
        state.connections.forEach(({ conn }) => {
            conn.send({
                type: 'typing',
                isTyping,
                name: state.myName
            });
        });
    }

    function handleTypingIndicator(peerId, data) {
        if (data.isTyping) {
            state.typingPeers.add(data.name || 'Quelqu\'un');
        } else {
            state.typingPeers.delete(data.name || 'Quelqu\'un');
        }
        updateTypingIndicator();
    }

    function updateTypingIndicator() {
        if (state.typingPeers.size > 0) {
            const names = Array.from(state.typingPeers);
            let text;
            if (names.length === 1) {
                text = `${names[0]} écrit...`;
            } else if (names.length === 2) {
                text = `${names[0]} et ${names[1]} écrivent...`;
            } else {
                text = `${names.length} personnes écrivent...`;
            }
            elements.typingNames.textContent = text;
            elements.typingIndicator.classList.add('active');
        } else {
            elements.typingIndicator.classList.remove('active');
        }
    }

    // ============================================
    // UI UPDATES
    // ============================================
    function updatePeersList() {
        updateParticipantsList();
    }

    function updateParticipantsList() {
        const allPeers = [
            ...Array.from(state.connections.entries()).map(([id, info]) => ({ id, ...info, connected: true })),
            ...Array.from(state.pendingConnections.entries()).map(([id, info]) => ({ id, ...info, connected: false }))
        ];

        if (allPeers.length === 0) {
            elements.peersList.innerHTML = `
                <div style="color:#64748b;font-size:0.85rem;text-align:center;padding:20px;">
                    Aucun participant connecté
                </div>
            `;
        } else {
            elements.peersList.innerHTML = allPeers.map(peer => `
                <div class="peer-item ${peer.connected ? 'connected' : ''}">
                    <div class="peer-avatar">${(peer.name || '?')[0].toUpperCase()}</div>
                    <div class="peer-details">
                        <div class="peer-name">
                            ${escapeHtml(peer.name || 'Connexion...')}
                            ${peer.role === 'admin' ? '<span class="role-badge admin">👑 Admin</span>' : ''}
                            ${peer.role === 'creator' ? '<span class="role-badge creator">🎯 Créateur</span>' : ''}
                        </div>
                        <div class="peer-id">${escapeHtml(peer.id)}</div>
                    </div>
                    ${!peer.connected ? '<span class="peer-status">Connexion...</span>' : ''}
                </div>
            `).join('');
        }

        // Update participants count
        const connectedCount = state.connections.size;
        const totalCount = allPeers.length;
        elements.participantsCount.textContent = connectedCount;
        if (elements.headerParticipants) {
            elements.headerParticipants.textContent = connectedCount;
        }
    }


    function enableChat() {
        elements.messageInput.disabled = false;
        elements.messageInput.placeholder = 'Tapez votre message...';
        elements.sendBtn.disabled = false;
    }

    function updateStatusBar(status, message) {
        elements.statusBar.className = 'status-bar ' + status;
        elements.statusBar.innerHTML = status === 'connecting'
            ? `<div class="spinner"></div><span>${message}</span>`
            : `<span>${message}</span>`;
    }

    function toggleMobileSidebar() {
        const sidebar = elements.sidebar;
        const overlay = elements.sidebarOverlay;
        const isShown = sidebar.classList.contains('mobile-show');

        if (isShown) {
            // Hide sidebar
            sidebar.classList.remove('mobile-show');
            overlay.classList.remove('show');
        } else {
            // Show sidebar
            sidebar.classList.add('mobile-show');
            overlay.classList.add('show');
        }
    }

    // ============================================
    // UTILITY FUNCTIONS
    // ============================================
    function generateId(length) {
        const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
        let result = '';
        for (let i = 0; i < length; i++) {
            result += chars[Math.floor(Math.random() * chars.length)];
        }
        return result;
    }

    function formatTime(date) {
        return date.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' });
    }

    function formatFileSize(bytes) {
        if (bytes < 1024) return bytes + ' B';
        if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
        return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
    }

    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    function scrollToBottom() {
        if (elements.messagesContainer) {
            elements.messagesContainer.scrollTop = elements.messagesContainer.scrollHeight;
        }
    }

    function showToast(message, type = 'info') {
        elements.toast.textContent = message;
        elements.toast.className = `toast ${type} show`;
        setTimeout(() => elements.toast.classList.remove('show'), 3000);
    }

    // ============================================
    // MODERATION ACTIONS
    // ============================================
    function initiateKick(peerId) {
        const peerInfo = state.connections.get(peerId);
        if (!peerInfo) return;

        const reason = prompt(`Raison de l'expulsion de ${peerInfo.name} :`, 'Comportement inapproprié');
        if (reason === null) return;

        broadcastMessage({
            type: 'kick-user',
            targetPeerId: peerId,
            initiatorId: state.myPeerId,
            reason
        });
    }

    function initiateBan(peerId) {
        const peerInfo = state.connections.get(peerId);
        if (!peerInfo) return;

        if (!confirm(`Voulez-vous vraiment bannir ${peerInfo.name} du salon ?`)) return;

        const reason = prompt(`Raison du bannissement de ${peerInfo.name} :`, 'Comportement inapproprié');
        if (reason === null) return;

        broadcastMessage({
            type: 'ban-user',
            targetPeerId: peerId,
            initiatorId: state.myPeerId,
            reason
        });
    }

    function reportUser(peerId) {
        const peerInfo = state.connections.get(peerId);
        if (!peerInfo) return;

        const reason = prompt(`Raison du signalement de ${peerInfo.name} :`, 'Comportement inapproprié');
        if (reason === null) return;

        appendSystemMessage(`🚨 Vous avez signalé ${peerInfo.name} aux administrateurs`, 'info');
        showToast('Signalement envoyé aux administrateurs', 'success');

        broadcastMessage({
            type: 'report-user',
            reporterId: state.myPeerId,
            targetPeerId: peerId,
            reason
        });
    }

    function initiateVote(peerId) {
        const peerInfo = state.connections.get(peerId);
        if (!peerInfo) return;

        const reason = prompt(`Raison du vote d'expulsion contre ${peerInfo.name} :`, 'Comportement inapproprié');
        if (reason === null) return;

        if (!confirm(`Voulez-vous vraiment lancer un vote d'expulsion contre ${peerInfo.name} ? Les participants devront voter avec /oui ou /non`)) return;

        const voteId = generateId(10);
        state.activeVotes.set(voteId, {
            targetPeerId: peerId,
            votes: new Set([state.myPeerId]),
            reason,
            expiresAt: Date.now() + 300000
        });

        appendSystemMessage(`🗳 Vote d'expulsion lancé contre ${peerInfo.name}`, 'warning');
        showToast('Vote d\'expulsion en cours - envoyez /oui ou /non pour voter', 'info');

        broadcastMessage({
            type: 'vote-kick',
            voteId,
            targetPeerId: peerId,
            voterId: state.myPeerId,
            vote: 'initiate',
            reason
        });
    }

    function assignAdmin(peerId) {
        const peerInfo = state.connections.get(peerId);
        if (!peerInfo) return;

        if (!confirm(`Voulez-vous nommer ${peerInfo.name} administrateur ?`)) return;

        appendSystemMessage(`👑 Vous avez nommé ${peerInfo.name} administrateur`, 'success');
        showToast(`${peerInfo.name} est maintenant administrateur`, 'success');

        broadcastMessage({
            type: 'admin-assign',
            targetPeerId: peerId,
            adminId: state.myPeerId
        });

        // Update local
        peerInfo.role = 'admin';
        const roomId = state.currentRoom?.id;
        if (roomId) {
            if (!state.roomAdmins.has(roomId)) {
                state.roomAdmins.set(roomId, new Set());
            }
            state.roomAdmins.get(roomId).add(peerId);
        }
        updatePeersList();
    }

    function revokeAdmin(peerId) {
        const peerInfo = state.connections.get(peerId);
        if (!peerInfo) return;

        if (!confirm(`Voulez-vous révoquer les droits d'admin de ${peerInfo.name} ?`)) return;

        appendSystemMessage(`⬇️ Vous avez révoqué les droits d'admin de ${peerInfo.name}`, 'warning');
        showToast(`${peerInfo.name} n'est plus administrateur`, 'warning');

        broadcastMessage({
            type: 'admin-revoke',
            targetPeerId: peerId,
            revokerId: state.myPeerId
        });

        // Update local
        peerInfo.role = 'participant';
        const roomId = state.currentRoom?.id;
        if (roomId && state.roomAdmins.has(roomId)) {
            state.roomAdmins.get(roomId).delete(peerId);
        }
        updatePeersList();
    }

    function playNotificationSound() {
        try {
            const ctx = new (window.AudioContext || window.webkitAudioContext)();
            const osc = ctx.createOscillator();
            const gain = ctx.createGain();
            osc.connect(gain);
            gain.connect(ctx.destination);
            osc.frequency.value = 800;
            gain.gain.setValueAtTime(0.1, ctx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.15);
            osc.start();
            osc.stop(ctx.currentTime + 0.15);
        } catch (e) {}
    }

    // Event handlers
    function handleNameChange(e) {
        state.myName = e.target.value.trim() || 'Anonyme';
        localStorage.setItem('peerName', state.myName);

        // Update all connected peers
        state.connections.forEach(({ conn }) => {
            conn.send({
                type: 'handshake',
                name: state.myName,
                publicKey: null // Don't resend key
            });
        });
    }

    function copyPeerId() {
        if (!state.myPeerId) return;
        navigator.clipboard.writeText(state.myPeerId).then(() => {
            showToast('ID copié !', 'success');
        });
    }

    function handleMessageKeydown(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            sendMessage();
        }
    }

    function handlePeerError(err) {
        console.error('Peer error:', err);
        let message = 'Erreur de connexion';
        let isCritical = false;

        if (err.type === 'peer-unavailable') {
            message = 'Pair introuvable. Vérifiez l\'ID et réessayez.';
            updateStatusBar('error', message);
            showToast(message, 'error');
        } else if (err.type === 'network' || err.type === 'server-error') {
            // Network errors are usually temporary and don't affect existing P2P connections
            message = 'Erreur réseau temporaire. Connexions P2P actives.';
            console.log('Temporary network error - P2P connections remain active');
            updateStatusBar('connecting', 'Reconnexion au serveur...');
            // Don't show error toast for temporary network issues, but show system message
            appendSystemMessage('⚠️ Erreur de connexion au serveur de signalisation. Les connexions P2P restent actives. Reconnexion en cours...');
        } else if (err.type === 'peer-error') {
            message = 'Erreur de connexion au pair. Vérifiez votre configuration ICE.';
            isCritical = true;
            updateStatusBar('error', message);
            showToast(message, 'error');
        } else if (err.type === 'ssl-unavailable') {
            message = 'Erreur SSL. Vérifiez que vous utilisez HTTPS.';
            isCritical = true;
            updateStatusBar('error', message);
            showToast(message, 'error');
        } else if (err.type === 'server-error') {
            message = 'Erreur du serveur de signalisation.';
            updateStatusBar('error', message);
            showToast(message, 'warning');
        } else {
            message = `Erreur: ${err.type || 'Connexion échouée'}`;
            isCritical = true;
            updateStatusBar('error', message);
            showToast(message, 'error');
        }

        // If critical error, show help message
        if (isCritical) {
            appendSystemMessage('💡 Astuce: Si vous avez des problèmes de connexion, essayez d\'ajouter des serveurs TURN supplémentaires dans les paramètres ⚙️');
        }
    }

    // ============================================
    // MIGRATION FROM PEERID TO USERNAME
    // ============================================

    function migrateOldData() {
        // Load old data if exists
        const oldFriends = localStorage.getItem('friends');
        const oldRooms = localStorage.getItem('privateRooms');
        const oldDirectMessages = localStorage.getItem('directMessages');

        // These are now loaded in state initialization, but we need to migrate them if they use old format
        console.log('Migration: Checking for old format data...');
    }

    // ============================================
    // TABS AND UI MANAGEMENT
    // ============================================

    function switchTab(tab) {
        state.currentTab = tab;

        // Update tab buttons
        elements.roomsTab.classList.toggle('active', tab === 'rooms');
        elements.usersTab.classList.toggle('active', tab === 'users');
        elements.dmTab.classList.toggle('active', tab === 'dm');

        // Update sections
        elements.roomsSection.classList.toggle('active', tab === 'rooms');
        elements.usersSection.classList.toggle('active', tab === 'users');
        elements.dmSection.classList.toggle('active', tab === 'dm');

        // Refresh user list when switching to users tab
        if (tab === 'users') {
            updateConnectedUsersList();
        }
    }

    // ============================================
    // CONNECTED USERS SYSTEM
    // ============================================

    function updateConnectedUsersList() {
        const container = document.getElementById('connected-users-list');
        const allPeers = Array.from(state.connections.entries()).map(([id, info]) => ({
            id,
            name: info.name,
            connected: true
        }));

        if (allPeers.length === 0) {
            container.innerHTML = `
                <div style="color:#64748b;font-size:0.9rem;text-align:center;padding:40px;">
                    <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" style="margin-bottom:12px;">
                        <circle cx="12" cy="12" r="10"></circle>
                        <line x1="12" y1="8" x2="12" y2="12"></line>
                        <line x1="12" y1="16" x2="12.01" y2="16"></line>
                    </svg>
                    <p>Aucun utilisateur connecté pour le moment</p>
                </div>
            `;
            return;
        }

        container.innerHTML = allPeers.map(peer => {
            const isFriend = state.friends.includes(peer.id);
            const initial = peer.name.charAt(0).toUpperCase();

            return `
                <div class="room-card" style="padding:16px;">
                    <div class="room-card-header">
                        <div style="display:flex;align-items:center;gap:12px;">
                            <div class="dm-contact-avatar" style="width:45px;height:45px;font-size:1.3rem;">
                                ${escapeHtml(initial)}
                            </div>
                            <div>
                                <div class="room-card-name">${escapeHtml(peer.name)}</div>
                                <div class="room-card-info" style="margin-bottom:0;">${escapeHtml(peer.id)}</div>
                            </div>
                        </div>
                        <span class="room-card-badge" style="background:rgba(52,211,153,0.2);color:#34d399;">
                            En ligne
                        </span>
                    </div>
                    <div style="display:flex;gap:8px;margin-top:12px;">
                        ${!isFriend ? `
                            <button class="btn btn-primary" style="flex:1;padding:8px;" onclick="addFriendById('${peer.id}')">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right:4px;">
                                    <line x1="12" y1="5" x2="12" y2="19"></line>
                                    <line x1="5" y1="12" x2="19" y2="12"></line>
                                </svg>
                                Ajouter en ami
                            </button>
                        ` : `
                            <button class="btn btn-success" style="flex:1;padding:8px;" onclick="startDmWithFriend('${peer.id}')">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right:4px;">
                                    <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
                                </svg>
                                Message
                            </button>
                            <button class="btn btn-secondary" style="flex:1;padding:8px;" onclick="removeFriendById('${peer.id}')">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <line x1="18" y1="6" x2="6" y2="18"></line>
                                    <line x1="6" y1="6" x2="18" y2="18"></line>
                                </svg>
                            </button>
                        `}
                    </div>
                </div>
            `;
        }).join('');
    }

    window.addFriendById = function(peerId) {
        if (state.friends.includes(peerId)) {
            showToast('Cet ami est déjà dans votre liste', 'warning');
            return;
        }

        state.friends.push(peerId);
        saveFriends();
        updateFriendsList();
        updateConnectedUsersList();
        showToast('Ami ajouté !', 'success');
    };

    window.removeFriendById = function(peerId) {
        const index = state.friends.indexOf(peerId);
        if (index > -1) {
            state.friends.splice(index, 1);
            saveFriends();
            updateFriendsList();
            updateConnectedUsersList();
            showToast('Ami supprimé', 'info');
        }
    };

    // ============================================
    // PRIVATE ROOMS SYSTEM
    // ============================================

    function openRoomCreationModal() {
        elements.roomNameInput.value = '';
        elements.roomCreationModal.classList.add('show');
        elements.roomNameInput.focus();
    }

    function closeRoomCreationModal() {
        elements.roomCreationModal.classList.remove('show');
    }

    async function createPrivateRoom() {
        const roomName = elements.roomNameInput.value.trim();
        if (!roomName) {
            showToast('Veuillez entrer un nom pour le salon', 'warning');
            return;
        }

        const room = {
            id: generateRoomId(),
            name: roomName,
            creatorId: state.myPeerId,
            creatorUsername: state.myName,
            admins: [state.myPeerId],
            members: [state.myPeerId],
            createdAt: Date.now()
        };

        state.privateRooms.push(room);
        savePrivateRooms();
        closeRoomCreationModal();
        updatePrivateRoomsList();

        showToast(`Salon "${roomName}" créé avec succès !`, 'success');

        // Show room detail
        showRoomDetail(room);
    }

    function refreshRoomsList() {
        // Recharge la liste des salons depuis localStorage
        const savedRooms = JSON.parse(localStorage.getItem('privateRooms') || '[]');
        state.privateRooms = savedRooms;
        updatePrivateRoomsList();
        showToast('Liste des salons actualisée', 'success');
    }

    // Auto-refresh every 30 seconds
    setInterval(() => {
        if (state.currentTab === 'rooms') {
            refreshRoomsList();
        }
    }, 30000);

    function generateRoomId() {
        const prefix = 'RT';
        const chars = '0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ';
        let id = '';
        for (let i = 0; i < 8; i++) {
            id += chars.charAt(Math.floor(Math.random() * chars.length));
        }
        return `${prefix}-${id}`;
    }

    function updatePrivateRoomsList() {
        const rooms = state.privateRooms;
        const container = elements.privateRoomsList;

        if (rooms.length === 0) {
            container.innerHTML = `
                <div style="color:#64748b;font-size:0.9rem;text-align:center;padding:40px;">
                    <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" style="margin-bottom:12px;">
                        <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                        <circle cx="9" cy="7" r="4"></circle>
                        <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                        <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                    </svg>
                    <p>Aucun salon. Créez-en un ou rejoignez un salon existant.</p>
                </div>
            `;
            return;
        }

        container.innerHTML = rooms.map(room => {
            const memberCount = room.members.length;
            const isCreator = room.creatorId === state.myPeerId;
            const isAdmin = room.admins.includes(state.myPeerId);

            // Get creator username from the stored mapping
            let creatorName = room.creatorId; // Default to peerId
            if (room.creatorUsername) {
                creatorName = room.creatorUsername;
            } else {
                // Try to find the username from the mapping
                const savedRoom = state.privateRooms.find(r => r.id === room.id);
                if (savedRoom && savedRoom.creatorUsername) {
                    creatorName = savedRoom.creatorUsername;
                    room.creatorUsername = savedRoom.creatorUsername; // Cache it
                }
            }

            return `
                <div class="room-card" data-room-id="${room.id}">
                    <div class="room-card-header">
                        <span class="room-card-name">${escapeHtml(room.name)}</span>
                        <span class="room-card-badge">${isCreator ? 'Créateur' : isAdmin ? 'Admin' : 'Membre'}</span>
                    </div>
                    <div class="room-card-info">ID: ${room.id}</div>
                    <div class="room-card-info" style="font-size:0.75rem;">Créateur: ${escapeHtml(creatorName)}</div>
                    <div class="room-card-participants">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                            <circle cx="9" cy="7" r="4"></circle>
                        </svg>
                        ${memberCount} membre${memberCount > 1 ? 's' : ''}
                    </div>
                </div>
            `;
        }).join('');

        // Add click listeners
        container.querySelectorAll('.room-card').forEach(card => {
            card.addEventListener('click', () => {
                const roomId = card.dataset.roomId;
                const room = state.privateRooms.find(r => r.id === roomId);
                if (room) {
                    showRoomDetail(room);
                }
            });
        });
    }

    function showRoomDetail(room) {
        state.currentRoom = room;
        state.isRoomCreator = room.creatorId === state.myPeerId;
        state.myRole = room.creatorId === state.myPeerId ? 'creator' :
                      room.admins.includes(state.myPeerId) ? 'admin' : 'participant';

        // Check if user is already a member
        const isMember = room.members.includes(state.myPeerId);

        // Hide rooms list, show detail
        document.getElementById('rooms-list-view').style.display = 'none';
        elements.roomDetail.classList.add('active');

        // Update header
        elements.detailRoomName.textContent = room.name;
        elements.detailRoomId.textContent = `ID: ${room.id}`;

        // Show/hide leave and delete buttons based on role
        elements.leaveRoomBtn.style.display = (isMember && !state.isRoomCreator) ? 'inline-flex' : 'none';
        elements.deleteRoomBtn.style.display = state.isRoomCreator ? 'inline-flex' : 'none';

        if (!isMember) {
            // User is not a member - show join request view
            showRoomJoinRequestView(room);
        } else {
            // User is a member - show normal room view
            showRoomNormalView(room);
        }
    }

    function showRoomJoinRequestView(room) {
        // Hide chat elements, show join request interface
        elements.messagesContainer.innerHTML = `
            <div style="display:flex;flex-direction:column;align-items:center;justify-content:center;height:100%;padding:40px;text-align:center;">
                <svg width="80" height="80" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" style="margin-bottom:20px;color:#fbbf24;">
                    <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path>
                </svg>
                <h2 style="color:#e2e8f0;margin-bottom:15px;">Salon privé</h2>
                <p style="color:#94a3b8;margin-bottom:30px;max-width:400px;">
                    Ce salon est privé. Vous devez envoyer une demande au créateur pour y accéder.
                </p>
                <div style="background:rgba(99,179,237,0.1);border:1px solid rgba(99,179,237,0.2);border-radius:12px;padding:20px;margin-bottom:25px;max-width:400px;width:100%;">
                    <h3 style="color:#63b3ed;font-size:1rem;margin-bottom:10px;">${escapeHtml(room.name)}</h3>
                    <p style="color:#64748b;font-size:0.85rem;margin-bottom:5px;">Créé par :</p>
                    <p style="color:#94a3b8;font-weight:600;">${escapeHtml(room.creatorId)}</p>
                </div>
                <div style="display:flex;gap:15px;justify-content:center;">
                    <button id="send-join-request-btn" class="btn btn-primary" style="padding:12px 30px;">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right:6px;">
                            <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                            <polyline points="22 4 12 14.01 9 11.01"></polyline>
                        </svg>
                        Envoyer une demande
                    </button>
                    <button id="cancel-join-request-btn" class="btn btn-secondary" style="padding:12px 30px;">
                        Annuler
                    </button>
                </div>
                <p style="color:#64748b;font-size:0.75rem;margin-top:20px;">
                    Votre Peer ID : <strong style="color:#63b3ed;">${state.myPeerId}</strong>
                </p>
            </div>
        `;

        // Add event listeners
        setTimeout(() => {
            const sendBtn = document.getElementById('send-join-request-btn');
            const cancelBtn = document.getElementById('cancel-join-request-btn');

            if (sendBtn) {
                sendBtn.onclick = () => sendJoinRequestToCreator(room);
            }
            if (cancelBtn) {
                cancelBtn.onclick = backToRoomsList;
            }
        }, 100);

        // Hide join requests section and chat input for non-members
        elements.joinRequestsSection.style.display = 'none';

        // Hide chat input area completely
        const inputArea = elements.messageInput ? elements.messageInput.closest('.input-area') : null;
        if (inputArea) {
            inputArea.style.display = 'none';
        }
        if (elements.messageInput) {
            elements.messageInput.disabled = true;
        }
        if (elements.sendBtn) {
            elements.sendBtn.disabled = true;
        }
        if (elements.attachBtn) {
            elements.attachBtn.disabled = true;
        }
    }

    function sendJoinRequestToCreator(room) {
        // In a real decentralized system, we would need to:
        // 1. Connect to the room creator via P2P
        // 2. Send them a join-request message
        // 3. Wait for their response

        // For now, we'll simulate this by showing a message
        // and storing the request locally

        showToast('Demande envoyée au créateur du salon', 'success');

        // Simulate storing the request (in real implementation, this would be sent via P2P)
        const request = {
            roomId: room.id,
            peerId: state.myPeerId,
            name: state.myName,
            timestamp: Date.now()
        };

        // Show confirmation
        elements.messagesContainer.innerHTML = `
            <div style="display:flex;flex-direction:column;align-items:center;justify-content:center;height:100%;padding:40px;text-align:center;">
                <svg width="60" height="60" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" style="margin-bottom:20px;color:#34d399;">
                    <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                    <polyline points="22 4 12 14.01 9 11.01"></polyline>
                </svg>
                <h3 style="color:#34d399;margin-bottom:15px;">Demande envoyée !</h3>
                <p style="color:#94a3b8;margin-bottom:25px;">
                    Le créateur du salon a reçu votre demande. Vous serez notifié(e) quand elle sera acceptée.
                </p>
                <button class="btn btn-secondary" onclick="backToRoomsList()" style="padding:10px 25px;">
                    Retour aux salons
                </button>
            </div>
        `;

        // In a real implementation, this would be sent to the creator:
        /*
        const creatorConnection = state.connections.get(room.creatorId);
        if (creatorConnection && creatorConnection.conn.open) {
            creatorConnection.conn.send({
                type: 'join-request',
                roomId: room.id,
                peerId: state.myPeerId,
                name: state.myName
            });
        }
        */
    }

    function showRoomNormalView(room) {
        // Show/hide join requests section based on role
        const isAdmin = state.myRole === 'creator' || state.myRole === 'admin';
        const pendingRequests = state.pendingJoinRequests.get(room.id) || [];

        if (isAdmin && pendingRequests.length > 0) {
            elements.joinRequestsSection.style.display = 'block';
            updateJoinRequestsList(room.id);
        } else {
            elements.joinRequestsSection.style.display = 'none';
        }

        // Enable chat and ensure input area is visible
        if (elements.messageInput) {
            elements.messageInput.disabled = false;
            elements.messageInput.placeholder = 'Écrivez votre message...';
            elements.messageInput.style.display = 'block';
        }
        if (elements.sendBtn) {
            elements.sendBtn.disabled = false;
            elements.sendBtn.style.display = 'flex';
        }
        if (elements.attachBtn) {
            elements.attachBtn.disabled = false;
            elements.attachBtn.style.display = 'flex';
        }

        // Ensure input area container is visible
        const inputArea = elements.messageInput ? elements.messageInput.closest('.input-area') : null;
        if (inputArea) {
            inputArea.style.display = 'block';
        }

        // Clear and update messages
        elements.messagesContainer.innerHTML = `<div class="message system">Bienvenue dans le salon "${escapeHtml(room.name)}" !</div>`;

        // Update participants list
        updateParticipantsList();
    }

    function backToRoomsList() {
        state.currentRoom = null;
        document.getElementById('rooms-list-view').style.display = 'block';
        elements.roomDetail.classList.remove('active');
    }

    function copyRoomAccessId() {
        if (!state.currentRoom) return;

        navigator.clipboard.writeText(state.currentRoom.id)
            .then(() => showToast('ID du salon copié !', 'success'))
            .catch(() => showToast('Erreur lors de la copie', 'error'));
    }

    function leaveRoom() {
        if (!state.currentRoom) return;

        const roomName = state.currentRoom.name;
        if (!confirm(`Êtes-vous sûr de vouloir quitter le salon "${roomName}" ?`)) return;

        // Remove user from members
        const memberIndex = state.currentRoom.members.indexOf(state.myPeerId);
        if (memberIndex > -1) {
            state.currentRoom.members.splice(memberIndex, 1);
        }

        // Also remove from admins if applicable
        const adminIndex = state.currentRoom.admins.indexOf(state.myPeerId);
        if (adminIndex > -1) {
            state.currentRoom.admins.splice(adminIndex, 1);
        }

        // Update the room in state.privateRooms
        const roomIndex = state.privateRooms.findIndex(r => r.id === state.currentRoom.id);
        if (roomIndex > -1) {
            state.privateRooms[roomIndex] = state.currentRoom;
        }

        savePrivateRooms();
        updatePrivateRoomsList();
        backToRoomsList();

        showToast(`Vous avez quitté le salon "${roomName}"`, 'success');
    }

    function deleteRoom() {
        if (!state.currentRoom || !state.isRoomCreator) return;

        const roomName = state.currentRoom.name;
        if (!confirm(`Êtes-vous sûr de vouloir supprimer définitivement le salon "${roomName}" ?\n\nCette action est irréversible.`)) return;

        // Remove room from state
        const roomIndex = state.privateRooms.findIndex(r => r.id === state.currentRoom.id);
        if (roomIndex > -1) {
            state.privateRooms.splice(roomIndex, 1);
        }

        savePrivateRooms();
        updatePrivateRoomsList();
        backToRoomsList();

        showToast(`Salon "${roomName}" supprimé`, 'success');
    }

    // ============================================
    // JOIN REQUESTS SYSTEM
    // ============================================

    function requestToJoinRoom() {
        const roomId = elements.joinRoomIdInput.value.trim().toUpperCase();
        if (!roomId) {
            showToast('Veuillez entrer l\'ID du salon', 'warning');
            return;
        }

        // Check if we're already in this room
        const existingRoom = state.privateRooms.find(r => r.id === roomId);
        if (existingRoom) {
            showToast('Vous êtes déjà membre de ce salon', 'warning');
            return;
        }

        // Store the pending join request
        state.pendingJoinRequest = {
            roomId,
            timestamp: Date.now()
        };

        elements.joinRoomIdInput.value = '';

        // Show instructions modal
        const modal = document.createElement('div');
        modal.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.8);display:flex;align-items:center;justify-content:center;z-index:1000;';
        modal.innerHTML = `
            <div style="background:rgba(15,23,42,0.95);padding:30px;border-radius:20px;max-width:400px;text-align:center;">
                <h3 style="color:#e2e8f0;margin-bottom:15px;">📝 Demande de rejoindre</h3>
                <p style="color:#94a3b8;margin-bottom:20px;">
                    Pour rejoindre le salon <strong style="color:#63b3ed;">${roomId}</strong> :
                </p>
                <ol style="color:#cbd5e1;text-align:left;margin:0 0 20px 20px;line-height:1.8;">
                    <li>Partagez votre Peer ID avec le créateur</li>
                    <li>Le créateur vous connectera au salon</li>
                    <li>Vous pourrez alors participer</li>
                </ol>
                <div style="background:rgba(99,179,237,0.1);border:1px solid rgba(99,179,237,0.2);border-radius:8px;padding:12px;margin-bottom:20px;">
                    <p style="color:#64748b;font-size:0.85rem;margin:0;">Votre Peer ID :</p>
                    <p style="color:#63b3ed;font-family:monospace;font-size:1.1rem;margin:5px 0 0 0;">${state.myPeerId}</p>
                </div>
                <button id="close-modal-btn" class="btn btn-primary" style="padding:10px 30px;">
                    Compris
                </button>
            </div>
        `;
        document.body.appendChild(modal);
        modal.querySelector('#close-modal-btn').onclick = () => modal.remove();
    }

    function updateJoinRequestsList(roomId) {
        const requests = state.pendingJoinRequests.get(roomId) || [];
        elements.joinRequestsCount.textContent = requests.length;

        if (requests.length === 0) {
            elements.joinRequestsList.innerHTML = `
                <div style="color:#94a3b8;font-size:0.85rem;padding:10px;">
                    Aucune demande en attente
                </div>
            `;
            return;
        }

        elements.joinRequestsList.innerHTML = requests.map((request, index) => {
            const timeAgo = formatTimeAgo(request.timestamp);

            return `
                <div class="join-request-item">
                    <div>
                        <div class="join-request-info">${escapeHtml(request.name)}</div>
                        <div class="join-request-time">${timeAgo}</div>
                    </div>
                    <div class="join-request-actions">
                        <button class="btn btn-success" style="width:auto;padding:6px 12px;" onclick="approveJoinRequest('${roomId}', ${index})">
                            ✓
                        </button>
                        <button class="btn reset-btn" style="width:auto;padding:6px 12px;" onclick="rejectJoinRequest('${roomId}', ${index})">
                            ✗
                        </button>
                    </div>
                </div>
            `;
        }).join('');
    }

    window.approveJoinRequest = function(roomId, index) {
        const requests = state.pendingJoinRequests.get(roomId);
        if (!requests || !requests[index]) return;

        const request = requests[index];

        // Send approval to the requester (in real implementation, via P2P)
        // For now, just log it
        console.log(`Approving join request from ${request.name} (${request.peerId})`);

        // Remove request
        requests.splice(index, 1);
        state.pendingJoinRequests.set(roomId, requests);

        updateJoinRequestsList(roomId);

        if (requests.length === 0) {
            elements.joinRequestsSection.style.display = 'none';
        }

        showToast(`Demande de ${request.name} approuvée`, 'success');
    };

    window.rejectJoinRequest = function(roomId, index) {
        const requests = state.pendingJoinRequests.get(roomId);
        if (!requests || !requests[index]) return;

        const request = requests[index];

        // Send rejection (in real implementation, via P2P)

        requests.splice(index, 1);
        state.pendingJoinRequests.set(roomId, requests);

        updateJoinRequestsList(roomId);

        if (requests.length === 0) {
            elements.joinRequestsSection.style.display = 'none';
        }

        showToast(`Demande de ${request.name} rejetée`, 'info');
    };

    // ============================================
    // FRIENDS SYSTEM
    // ============================================

    function addFriend() {
        const friendId = elements.addFriendInput.value.trim().toUpperCase();
        if (!friendId) {
            showToast('Veuillez entrer l\'ID de l\'ami', 'warning');
            return;
        }

        if (friendId === state.myPeerId) {
            showToast('Vous ne pouvez pas vous ajouter vous-même', 'warning');
            return;
        }

        if (state.friends.includes(friendId)) {
            showToast('Cet ami est déjà dans votre liste', 'warning');
            return;
        }

        state.friends.push(friendId);
        saveFriends();
        updateFriendsList();
        elements.addFriendInput.value = '';

        showToast('Ami ajouté avec succès !', 'success');
    }

    function removeFriend(friendId) {
        const index = state.friends.indexOf(friendId);
        if (index > -1) {
            state.friends.splice(index, 1);
            saveFriends();
            updateFriendsList();
            showToast('Ami supprimé', 'info');
        }
    }

    function updateFriendsList() {
        const friends = state.friends;
        const container = elements.friendsList;

        if (friends.length === 0) {
            container.innerHTML = `
                <div style="color:#64748b;font-size:0.85rem;text-align:center;padding:20px;">
                    Aucun ami. Ajoutez-en un !
                </div>
            `;
            return;
        }

        container.innerHTML = friends.map(friendId => {
            const connection = state.connections.get(friendId);
            const isOnline = connection && connection.conn.open;
            const name = connection ? connection.name : friendId;
            const initial = name.charAt(0).toUpperCase();

            return `
                <div class="friend-item ${isOnline ? '' : 'offline'}" data-friend-id="${friendId}">
                    <div class="friend-status ${isOnline ? 'online' : ''}"></div>
                    <span class="friend-name">${escapeHtml(name)}</span>
                    ${isOnline ?
                        `<button class="btn btn-primary" style="width:auto;padding:4px 8px;font-size:0.75rem;" onclick="startDmWithFriend('${friendId}')">
                            DM
                        </button>` :
                        `<span style="color:#64748b;font-size:0.75rem;">Hors ligne</span>`
                    }
                </div>
            `;
        }).join('');

        // Add click listeners for starting DM
        container.querySelectorAll('.friend-item').forEach(item => {
            item.addEventListener('click', (e) => {
                if (e.target.tagName !== 'BUTTON') {
                    const friendId = item.dataset.friendId;
                    const connection = state.connections.get(friendId);
                    if (connection && connection.conn.open) {
                        startDmWithFriend(friendId);
                    }
                }
            });
        });
    }

    window.startDmWithFriend = function(friendId) {
        const connection = state.connections.get(friendId);
        if (!connection) {
            showToast('Non connecté à cet ami', 'warning');
            return;
        }

        switchTab('dm');
        openDmConversation(friendId);
    };

    function saveFriends() {
        localStorage.setItem('friends', JSON.stringify(state.friends));
    }

    // ============================================
    // DIRECT MESSAGES SYSTEM
    // ============================================

    function toggleDmSettings() {
        state.allowDMFromNonFriends = !state.allowDMFromNonFriends;
        localStorage.setItem('allowDMFromNonFriends', state.allowDMFromNonFriends);

        const toggle = elements.acceptDMToggle.querySelector('.toggle-input');
        toggle.classList.toggle('active', state.allowDMFromNonFriends);

        showToast(state.allowDMFromNonFriends ?
            'Messages de non-amis autorisés' :
            'Seuls les amis peuvent vous envoyer des messages',
        'info');
    }

    function updateDmContactsList() {
        // Get all contacts we have DMs with
        const contacts = Array.from(state.directMessages.keys());
        
        const container = elements.dmContactsList;

        if (contacts.length === 0) {
            container.innerHTML = `
                <div style="color:#64748b;font-size:0.9rem;text-align:center;padding:40px;">
                    <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" style="margin-bottom:12px;">
                        <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
                    </svg>
                    <p>Aucune conversation. Ajoutez des amis depuis la barre latérale.</p>
                </div>
            `;
            return;
        }

        container.innerHTML = contacts.map(peerId => {
            const connection = state.connections.get(peerId);
            const isOnline = connection && connection.conn.open;
            const name = connection ? connection.name : peerId;
            const initial = name.charAt(0).toUpperCase();
            const messages = state.directMessages.get(peerId) || [];
            const lastMessage = messages[messages.length - 1];
            const unreadCount = messages.filter(m => !m.fromMe && !m.read).length;

            return `
                <div class="dm-contact" data-peer-id="${peerId}">
                    <div class="dm-contact-avatar">${escapeHtml(initial)}</div>
                    <div class="dm-contact-info">
                        <div class="dm-contact-name">${escapeHtml(name)}</div>
                        <div class="dm-contact-status">${isOnline ? 'En ligne' : 'Hors ligne'}</div>
                    </div>
                    ${unreadCount > 0 ? `<div class="dm-contact-unread">${unreadCount}</div>` : ''}
                    <button class="dm-delete-btn" data-peer-id="${peerId}" title="Supprimer la conversation">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M3 6h18M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/>
                        </svg>
                    </button>
                </div>
            `;
        }).join('');

        // Add click listeners for contacts
        container.querySelectorAll('.dm-contact').forEach(contact => {
            contact.addEventListener('click', (e) => {
                if (!e.target.closest('.dm-delete-btn')) {
                    openDmConversation(contact.dataset.peerId);
                }
            });
        });

        // Add click listeners for delete buttons
        container.querySelectorAll('.dm-delete-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                e.stopPropagation();
                deleteDmConversation(btn.dataset.peerId);
            });
        });
    }

    function deleteDmConversation(peerId) {
        const connection = state.connections.get(peerId);
        const name = connection ? connection.name : peerId;

        if (!confirm(`Êtes-vous sûr de vouloir supprimer la conversation avec ${name} ?`)) return;

        state.directMessages.delete(peerId);
        saveDirectMessages();
        updateDmContactsList();

        // Si c'est la conversation actuelle, revenir à la liste
        if (state.activeDMConversation === peerId) {
            backToDmList();
        }

        showToast('Conversation supprimée', 'success');
    }

    function openDmConversation(peerId) {
        state.activeDMConversation = peerId;

        const connection = state.connections.get(peerId);
        const name = connection ? connection.name : peerId;

        elements.dmContactName.textContent = name;

        // Show conversation, hide list
        elements.dmContactsList.style.display = 'none';
        elements.dmConversation.style.display = 'block';

        // Load messages
        const messages = state.directMessages.get(peerId) || [];
        renderDmMessages(messages);

        // Mark as read
        messages.forEach(m => { if (!m.fromMe) m.read = true; });
        state.directMessages.set(peerId, messages);
        saveDirectMessages();

        elements.dmInput.focus();
        
        // Show toast to confirm connection
        if (connection && connection.conn.open) {
            showToast(`Conversation avec ${name} prête`, 'success');
        }
    }

    function backToDmList() {
        state.activeDMConversation = null;
        elements.dmContactsList.style.display = 'block';
        elements.dmConversation.style.display = 'none';
        updateDmContactsList();
    }

    function renderDmMessages(messages) {
        elements.dmMessages.innerHTML = '';

        if (messages.length === 0) {
            elements.dmMessages.innerHTML = `<div class="message system">Début de la conversation privée</div>`;
            return;
        }

        messages.forEach(msg => {
            appendDmMessage(msg.content, msg.fromMe, msg.timestamp);
        });

        scrollToBottom(elements.dmMessages);
    }

    function appendDmMessage(content, fromMe, timestamp = Date.now()) {
        const messageDiv = document.createElement('div');
        messageDiv.className = `message ${fromMe ? 'sent' : 'received'}`;

        const timeStr = new Date(timestamp).toLocaleTimeString('fr-FR', {
            hour: '2-digit',
            minute: '2-digit'
        });

        messageDiv.innerHTML = `
            <div class="message-content">${escapeHtml(content)}</div>
            <div class="message-time">${timeStr}</div>
        `;

        elements.dmMessages.appendChild(messageDiv);
        scrollToBottom(elements.dmMessages);
    }

    async function sendDirectMessage() {
        if (!state.activeDMConversation) return;

        const content = elements.dmInput.value.trim();
        if (!content) return;

        const peerId = state.activeDMConversation;
        const connection = state.connections.get(peerId);

        if (!connection || !connection.conn.open) {
            showToast('Non connecté à ce contact', 'warning');
            return;
        }

        // Encrypt and send message
        const encrypted = await Crypto.encrypt(connection.sharedKey, content);

        connection.conn.send({
            type: 'dm',
            encrypted: encrypted,
            from: state.myName,
            to: connection.name || 'Inconnu'
        });

        // Store locally
        const messages = state.directMessages.get(peerId) || [];
        messages.push({
            content,
            timestamp: Date.now(),
            fromMe: true,
            read: true
        });
        state.directMessages.set(peerId, messages);
        saveDirectMessages();

        // Display
        appendDmMessage(content, true, Date.now());

        elements.dmInput.value = '';
    }

    function saveDirectMessages() {
        const data = Array.from(state.directMessages.entries()).map(([peerId, msgs]) => ({
            peerId,
            messages: msgs
        }));
        localStorage.setItem('directMessages', JSON.stringify(data));
    }

    function loadDirectMessages() {
        const data = JSON.parse(localStorage.getItem('directMessages') || '[]');
        data.forEach(({ peerId, messages }) => {
            state.directMessages.set(peerId, messages);
        });
    }

    // ============================================
    // UTILITY FUNCTIONS
    // ============================================

    function savePrivateRooms() {
        localStorage.setItem('privateRooms', JSON.stringify(state.privateRooms));
    }

    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    function formatTimeAgo(timestamp) {
        const seconds = Math.floor((Date.now() - timestamp) / 1000);

        if (seconds < 60) return "À l'instant";
        if (seconds < 3600) return `Il y a ${Math.floor(seconds / 60)} min`;
        if (seconds < 86400) return `Il y a ${Math.floor(seconds / 3600)} h`;
        return `Il y a ${Math.floor(seconds / 86400)} j`;
    }

    function scrollToBottom(container) {
        if (container && container.scrollHeight !== undefined) {
            container.scrollTop = container.scrollHeight;
        }
    }

    // ============================================
    // MESSAGE HANDLERS FOR NEW FEATURES
    // ============================================

    function handleJoinRequest(data) {
        // Handler for when someone requests to join a room
        // In real implementation, this would be called from the P2P message handler
        const { peerId, name, roomId } = data;

        const room = state.privateRooms.find(r => r.id === roomId);
        if (!room) return;

        // Only creator/admins receive join requests
        const isAdmin = room.creatorId === state.myPeerId || room.admins.includes(state.myPeerId);
        if (!isAdmin) return;

        // Add to pending requests
        const requests = state.pendingJoinRequests.get(roomId) || [];
        requests.push({
            peerId,
            name,
            timestamp: Date.now()
        });
        state.pendingJoinRequests.set(roomId, requests);

        if (state.currentRoom && state.currentRoom.id === roomId) {
            elements.joinRequestsSection.style.display = 'block';
            updateJoinRequestsList(roomId);
        }

        showToast(`${name} souhaite rejoindre le salon`, 'info');
    }

    function handleJoinApproved(data) {
        // Handler for when our join request is approved
        const { roomId, roomName, creatorId, admins } = data;

        const room = {
            id: roomId,
            name: roomName,
            creatorId,
            admins,
            members: [state.myPeerId],
            createdAt: Date.now()
        };

        state.privateRooms.push(room);
        savePrivateRooms();
        updatePrivateRoomsList();

        showToast(`Demande approuvée ! Vous avez rejoint "${roomName}"`, 'success');
        showRoomDetail(room);
    }

    async function handleDirectMessage(data) {
        const { encrypted, from } = data;

        // Find the connection that sent this message
        let senderConnection = null;
        let senderPeerId = null;

        for (const [peerId, connectionInfo] of state.connections) {
            if (connectionInfo.name === from) {
                senderConnection = connectionInfo;
                senderPeerId = peerId;
                break;
            }
        }

        if (!senderConnection || !senderConnection.conn.open) {
            console.error('No connection found for DM sender:', from);
            return;
        }

        // Check if we allow DMs from this sender
        const isFriend = state.friends.includes(from);
        if (!state.allowDMFromNonFriends && !isFriend) {
            // Send rejection
            senderConnection.conn.send({
                type: 'dmRejected',
                reason: 'DM restricted to friends only'
            });
            return;
        }

        try {
            const content = await Crypto.decrypt(senderConnection.sharedKey, encrypted);

            // Store message
            const messages = state.directMessages.get(senderPeerId) || [];
            messages.push({
                content,
                timestamp: Date.now(),
                fromMe: false,
                read: !state.activeDMConversation || state.activeDMConversation !== senderPeerId
            });
            state.directMessages.set(senderPeerId, messages);
            saveDirectMessages();

            // Update UI
            if (state.activeDMConversation === senderPeerId) {
                appendDmMessage(content, false, Date.now());
                // Send read receipt
                senderConnection.conn.send({ 
                    type: 'dmRead',
                    from: state.myName
                });
            }

            updateDmContactsList();
            showToast(`Message de ${from}`, 'info');

        } catch (err) {
            console.error('Error decrypting DM:', err);
        }
    }

    function handleDmRejected(data) {
        showToast(`Message rejeté: ${data.reason}`, 'warning');
    }

    function handleDmRead(data) {
        // Mark messages as read
        const peerId = data.peerId;
        const messages = state.directMessages.get(peerId) || [];
        messages.forEach(m => { if (!m.fromMe) m.read = true; });
        state.directMessages.set(peerId, messages);
        saveDirectMessages();
    }

    // Initialize
    document.addEventListener('DOMContentLoaded', init);

    // Cleanup
    window.addEventListener('beforeunload', () => {
        state.connections.forEach(({ conn }) => conn.close());
        if (state.peer) state.peer.destroy();
    });

    // Expose connect function for manual connection
    window.connectToPeer = connectToPeer;
    </script>
</body>
</html>
